<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>用 JavaScript 自制 GameBoy 模拟器（上） · Cytrogen 的个人博客</title><meta name="description" content="本文是一篇使用现代 JavaScript (ES6) 从零开始制作 GameBoy 模拟器的详细教程（上篇）。文章循序渐进地讲解了模拟 GameBoy 核心硬件的原理与实现，内容涵盖 Z80 CPU 的指令周期、内存管理单元（MMU）的内存映射、GPU 的显示时序和瓦片图形渲染系统。最终通过一个系统调度器将这些独立的模块集成起来，构建出一个完整、可运行的模拟器基础架构。本教程不仅提供了大量代码示例，还用通俗易懂的方式解释了底层硬件的工作原理，适合对模拟器开发、计算机体系结构或复古游戏技术感兴趣的开发者。"><link rel="icon" href="../favicon.png"><link rel="webmention" href="https://webmention.io/cytrogen.icu/webmention"><link rel="preload" href="../fonts/opensans-regular-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous"><style>@font-face {
  font-family: 'Open Sans';
  src: url('../fonts/opensans-regular-latin.woff2') format('woff2');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  size-adjust: 107%;
  ascent-override: 97%;
  descent-override: 25%;
  line-gap-override: 0%;
}
</style><link rel="stylesheet" href="../css/ares.css"><script data-netlify-skip-bundle="true">(function() {
  const getInitialTheme = () => {
    const saved = localStorage.getItem('theme');
    if (saved && (saved === 'light' || saved === 'dark')) {
      return saved;
    }
    
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    
    return 'light';
  };
  
  const theme = getInitialTheme();
  document.documentElement.setAttribute('data-theme', theme);
  
  document.documentElement.style.colorScheme = theme;
  
  // Add anti-flicker style for dark mode
  if (theme === 'dark') {
    const style = document.createElement('style');
    style.id = 'anti-flicker-style';
    style.innerHTML = `
      #page-wrapper[data-theme="dark"] {
        background-color: #0f172a;
        color: #f1f5f9;
      }
    `;
    document.head.appendChild(style);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const pageWrapper = document.getElementById('page-wrapper');
    if (pageWrapper) {
      pageWrapper.setAttribute('data-theme', theme);
    }
  });
})();

</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 8.0.0"><link rel="alternate" href="atom.xml" title="Cytrogen 的个人博客" type="application/atom+xml">
</head><body><div id="page-wrapper"><a class="skip-link" href="#main-content">跳到主要内容</a><div class="wrap"><header><a class="logo-link" href="../index.html"><img src="../favicon.png" alt="logo"></a><nav class="site-nav"><div class="nav-main"><div class="nav-primary"><ul class="nav-list hidden-mobile"><li class="nav-item"><a class="nav-link" href="../index.html">首页</a></li></ul><div class="nav-tools"><div class="language-menu"><button class="language-toggle" type="button"><svg class="icon icon-globe" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855A7.97 7.97 0 0 0 10.855 12H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"></path></svg><span>中文</span></button><div class="language-dropdown"></div></div></div><div class="nav-controls"><div class="more-menu hidden-mobile"><button class="more-toggle" type="button"><span>更多</span><svg class="icon icon-chevron-down" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true" focusable="false"><path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1s.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0s.3.8 0 1.1l-3.3 3.3c-.1.1-.3.2-.5.2z"></path></svg></button><div class="more-dropdown"><ul class="dropdown-list"><li class="dropdown-item"><a class="nav-link" href="../archives">归档</a></li><li class="dropdown-item"><a class="nav-link" href="../categories">分类</a></li><li class="dropdown-item"><a class="nav-link" href="../tags">标签</a></li><li class="dropdown-item"><a class="nav-link" href="../about">关于</a></li><li class="dropdown-item"><a class="nav-link" href="../friends">友链</a></li><li class="dropdown-item"><a class="nav-link" href="../atom.xml">RSS订阅</a></li><li class="dropdown-item"><a class="dropdown-link" href="https://github.com/cytrogen" target="_blank" rel="noopener noreferrer me">GitHub<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li><li class="dropdown-item"><a class="dropdown-link" href="https://portfolio.cytrogen.icu" target="_blank" rel="noopener noreferrer">作品集<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li></ul></div></div><div class="theme-switcher"><button class="theme-toggle" type="button" role="switch" aria-pressed="false" aria-label="切换主题"><div class="theme-icon moon-icon"><svg class="icon icon-moon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path></svg></div><div class="theme-icon sun-icon"><svg class="icon icon-sun" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg></div></button></div><details class="mobile-menu-details hidden-desktop"><summary class="hamburger-menu" aria-label="nav.menu"><svg class="icon icon-bars" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"></path></svg><span class="menu-text">nav.menu</span></summary><div class="mobile-menu-dropdown"><ul class="mobile-nav-list"><li class="mobile-nav-item"><a class="mobile-nav-link" href="../index.html">首页</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../archives">归档</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../categories">分类</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../tags">标签</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../about">关于</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../friends">友链</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../atom.xml">RSS订阅</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="https://github.com/cytrogen" target="_blank" rel="noopener noreferrer me">GitHub<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="https://portfolio.cytrogen.icu" target="_blank" rel="noopener noreferrer">作品集<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li></ul></div></details></div></div></div></nav></header><main class="container" id="main-content" tabindex="-1"><div class="post"><article class="post-block"><h1 class="post-title">用 JavaScript 自制 GameBoy 模拟器（上）</h1><div class="post-info"><time class="post-date dt-published" datetime="2025-07-01T04:00:00.000Z">7/1/2025</time></div><div class="post-content"><html><head></head><body><p>近期有些百无聊赖。因为工作，先前的个人项目全都不得不暂时搁置。为了找点乐子，我决定做一些与全栈开发不同的事情 <s>（主要是最近玩宝可梦玩的有点多）</s>。</p>
<p>这期的文章参考了 Imre Nazar 在 2010 年写的一系列关于 <a target="_blank" rel="noopener" href="https://imrannazar.com/series/gameboy-emulation-in-javascript">用 JavaScript 实现 GameBoy 模拟器</a> 的教程。虽然这个教程有些年头了，但还是提供了一个很好的起点和思路。自然，这期文章不会直接去 Ctrl C + V 他的实现，而是会使用更现代的 ES6 语法。</p>
<span id="more"></span>
<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1>
<p>要模拟一台 GameBoy，我们至少需要模拟以下核心组件：</p>
<ul>
<li>CPU（Z80 兼容处理器），也就是「大脑」，负责执行游戏代码</li>
<li>内存管理单元（MMU），用于处理内存的读写，包括 ROM、RAM 和各种硬件寄存器</li>
<li>图形处理单元（PPU），负责渲染游戏画面</li>
<li>输入设备，处理用户按键操作</li>
<li>定时器，提供精确的时间控制</li>
<li>声音处理单元，生成游戏音效和音乐</li>
</ul>
<h1 id="1-模拟-z80-cpu"><a class="markdownIt-Anchor" href="#1-模拟-z80-cpu"></a> 1. 模拟 Z80 CPU</h1>
<p>GameBoy 的 CPU 是一个修改过的 Zilog Z80 处理器。要模拟它，就得理解它的工作方式。</p>
<p>核心概念很简单：取指 → 解码 → 执行循环。</p>
<ol>
<li>取指：从内存中获取下一条指令</li>
<li>解码：解析指令的含义</li>
<li>执行：执行指令指定的操作</li>
</ol>
<p>这个循环在 GameBoy 上电后就开始运行，直到关机。为了跟踪程序执行到哪里，CPU 会使用一个特殊的寄存器 —— 程序计数器。每当一条指令被取出后，程序计数器就会根据指令的长度向前移动，指向下一条要执行的指令。</p>
<p>Z80 CPU 是一个 8 位芯片，意味着它一次可以处理一个字节的数据。它也能访问多达 6,5536 字节的内存空间，程序代码和普通数据都被存储在同一个内存地址空间中，而一条指令的长度可以在 1 到 3 个字节之间。</p>
<p>除了程序计数器，Z80 CPU 还有一组内存寄存器，用于存储数据和执行计算：</p>
<ul>
<li>8 位通用寄存器（A、B、C、D、E、H、L），每个可以存储一个字节（0 到 255）的值。大多数 Z80 指令都围绕着操作这些寄存器，例如将内存中的值加载到寄存器中，或者对寄存器中的值进行算术运算</li>
<li>标志寄存器（F）是一个特殊的 8 位寄存器，其中每个位都代表一个「标志」，用于存储上一次运算的结果状态</li>
<li>栈指针（SP）是一个 16 位寄存器，用于指向内存中的「栈顶」位置
<ul>
<li>栈是一种后进先出的数据结构</li>
</ul>
</li>
</ul>
<blockquote>
<p>CPU 是什么？（用大白话说）</p>
<p><strong>不要被「中央处理器」这个名字吓到。</strong></p>
<p>把 CPU 想象成一个超快的计算器工人：</p>
<ul>
<li>他有一张小纸条（寄存器），记录当前的数字</li>
<li>他有一本操作手册（指令集），告诉他怎么计算</li>
<li>他一次只能做一件事，但做得很快</li>
</ul>
<p>假设有一个指令是「把 A 和 B 加起来」，那么对于这个工人而言就是：</p>
<ol>
<li>看看 A 纸条（3）</li>
<li>看看 B 纸条（5）</li>
<li>算出结果（8）</li>
<li>写到 A 纸条上</li>
</ol>
<p><s>基本上就是一个只会加减乘除但超级勤快的员工</s></p>
</blockquote>
<p>基于以上理解，我们的 Z80 CPU 模拟器需要包含以下核心组件：</p>
<ul>
<li>内部状态，需要保存所有寄存器的当前值、执行上一条指令所花费的时间，以及 CPU 总共运行了多长时间</li>
<li>指令模拟函数</li>
<li>指令映射表</li>
<li>内存接口</li>
</ul>
<h2 id="11-cpu-骨架"><a class="markdownIt-Anchor" href="#11-cpu-骨架"></a> 1.1. CPU 骨架</h2>
<p>下面是我们 <code>GameBoyCPU</code> 类的初步骨架，包含了 CPU 的时钟系统和所有重要的寄存器：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GameBoy Z80 CPU 类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameBoyCPU</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 时钟系统，跟踪 CPU 执行时间</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clock</span> = {</span><br><span class="line">      <span class="attr">m</span>: <span class="number">0</span>, <span class="comment">// 机器周期计数器（主时钟）</span></span><br><span class="line">      <span class="attr">t</span>: <span class="number">0</span>, <span class="comment">// 时钟周期计数器，用于精确计时</span></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CPU 寄存器组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span> = {</span><br><span class="line">      <span class="comment">// === 8位通用寄存器 ===</span></span><br><span class="line">      <span class="attr">a</span>: <span class="number">0</span>, <span class="comment">// 累加器，主要用于算术运算</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// BC寄存器对（可作为16位使用）</span></span><br><span class="line">      <span class="attr">b</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">c</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// DE寄存器对（同上）</span></span><br><span class="line">      <span class="attr">d</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">e</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// HL寄存器对（同上；常用作内存指针）</span></span><br><span class="line">      <span class="attr">h</span>: <span class="number">0</span>, <span class="comment">// 高位</span></span><br><span class="line">      <span class="attr">l</span>: <span class="number">0</span>, <span class="comment">// 低位</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">f</span>: <span class="number">0</span>, <span class="comment">// 标志寄存器，存储运算结果的状态标志</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// === 16位专用寄存器 ===</span></span><br><span class="line">      <span class="attr">pc</span>: <span class="number">0</span>, <span class="comment">// 程序计数器，指向下一条要执行的指令</span></span><br><span class="line">      <span class="attr">sp</span>: <span class="number">0</span>, <span class="comment">// 栈指针，指向栈顶位置</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// === 指令执行时间记录 ===</span></span><br><span class="line">      <span class="attr">m</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">t</span>: <span class="number">0</span>,</span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>CPU 的时钟系统是用来精确跟踪模拟时间的，<code>m</code> 代表机器周期，<code>t</code> 代表时钟周期，两者之间存在固定关系。</p>
<h2 id="12-标志寄存器与基本指令"><a class="markdownIt-Anchor" href="#12-标志寄存器与基本指令"></a> 1.2. 标志寄存器与基本指令</h2>
<p>标志寄存器是 CPU 运算中一个非常关键的部分，它会根据上一条指令的执行结果自动设置某些位。在 GameBoy 的 Z80 CPU 中，有四个重要的标志位：</p>
<ul>
<li>零标志（<code>0x80</code>）：如果上一次运算的结果为 0，则设置此位</li>
<li>减法标志（<code>0x40</code>）：如果上一次运算是减法操作，则设置此位</li>
<li>半进位标志（<code>0x20</code>）：如果上一次运算在字节的低 4 位发生了溢出（即结果的第 3 位向第 4 位进位），则设置此位</li>
<li>进位标志（<code>0x10</code>）：如果上一次加法运算结果超过 255（8 位最大值），或者减法运算结果低于 0（发生借位），则设置此位</li>
</ul>
<blockquote>
<p>看不懂的话……</p>
<p>想象你刚做完一道数学题，你的大脑会自动记住一些「状态」：</p>
<ul>
<li>「咦，答案是 0？」→ 零标志</li>
<li>「我刚才是在做减法吗？」→ 减法标志</li>
<li>「有没有进位？」→ 进位标志</li>
</ul>
<p>GameBoy 的 CPU 也是如此。每次计算完，它都会在标志寄存器里记下这些「感想」。</p>
<p>为什么需要这些标志？因为后面的指令可能会问：「上次计算结果是 0 吗？如果是的话，跳转到别的地方。」</p>
</blockquote>
<p>为了更好地管理这些标志位，我们首先定义一个常量对象 <code>CPU_FLAGS</code>：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标志位常量定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CPU_FLAGS</span> = {</span><br><span class="line">  <span class="attr">ZERO</span>: <span class="number">0x80</span>,</span><br><span class="line">  <span class="attr">OPERATION</span>: <span class="number">0x40</span>,</span><br><span class="line">  <span class="attr">HALF_CARRY</span>: <span class="number">0x20</span>,</span><br><span class="line">  <span class="attr">CARRY</span>: <span class="number">0x10</span>,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>接着，我们为 <code>GameBoyCPU</code> 类添加 <code>reset</code>、<code>setFlag</code> 和 <code>getFlag</code> 方法：</p>
<ul>
<li><code>reset</code> 方法用于将 CPU 的所有寄存器和时钟状态复位到初始值，这对于模拟器启动或重新加载游戏非常有用</li>
<li><code>setFlag</code> 和 <code>getFlag</code> 则分别用于设置和检查标志位，方便我们根据运算结果来操作标志寄存器 <code>f</code></li>
</ul>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 之前的 constructor ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CPU 重置，将所有寄存器和时钟复位为初始状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">reset</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 重置所有8位寄存器</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">b</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">c</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">d</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">e</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">h</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">l</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">f</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置16位寄存器</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">pc</span> = <span class="number">0</span>; <span class="comment">// 程序从地址0开始执行</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">sp</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置时钟</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">m</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">clock</span>.<span class="property">t</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'主人~ CPU 已重置到初始状态喵！'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置标志位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} flag 要设置的标志位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">boolean</span>} condition 是否设置该标志位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">setFlag</span>(<span class="params">flag, condition</span>) {</span><br><span class="line">  <span class="keyword">if</span>（condition) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">f</span> |= flag; <span class="comment">// 设置位：通过按位或操作将指定标志位设置为 1</span></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// 否则就清除位：通过按位与操作与指定标志位的补码，将其设置为 0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">f</span> &amp;= ~flag;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查标志位是否设置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} flag 要检查的标志位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getFlag</span>(<span class="params">flag</span>) {</span><br><span class="line">  <span class="keyword">return</span> (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">f</span> &amp; flag) !== <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>为了演示 CPU 如何执行指令并影响寄存器和标志位，我们来模拟几个基本的 Z80 指令：</p>
<ul>
<li>
<p><code>ADD A, E</code>（加法指令）：将寄存器 <code>e</code> 的值加到寄存器 <code>a</code> 中，结果存回 <code>a</code>。这个函数需要更新 <code>a</code> 寄存器的值，并根据结果设置零标志和进位标志。<br>
注意，我们将结果限制在 8 位范围内（<code>&amp;= 255</code>），并更新指令执行所花费的机器周期 <code>m</code> 和时钟周期 <code>t</code>。</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 E 寄存器的值加到 A 寄存器</span></span><br><span class="line"><span class="comment"> * 算术指令用：ADD A, E</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">addRegisterE</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span> += <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">e</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除所有标志位并准备设置新的</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">f</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查零标志和进位标志</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setFlag</span>(<span class="variable constant_">CPU_FLAGS</span>.<span class="property">ZERO</span>, !(<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span> &amp; <span class="number">255</span>)); <span class="comment">// 结果为0则设置零标志</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setFlag</span>(<span class="variable constant_">CPU_FLAGS</span>.<span class="property">CARRY</span>, <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span> &gt; <span class="number">255</span>);   <span class="comment">// 结果溢出255则设置进位标志</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将结果限制为 8 位</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span> &amp;= <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置指令执行时间（1 机器周期，4 时钟周期)</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">m</span> = <span class="number">1</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span> = <span class="number">4</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p><code>CP A, B</code>（比较指令）：将寄存器 <code>a</code> 的值与寄存器 <code>b</code> 的值进行比较。这个指令实际上是执行 <code>a - b</code> 的操作，但不保存结果，只根据结果设置标志位。我们需要设置减法标志，并根据比较结果设置零标志（如果 <code>a == b</code>）和进位标志（如果 <code>a &lt; b</code>）。</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比较 B 寄存器和 A 寄存器</span></span><br><span class="line"><span class="comment"> * 用于条件判断和循环控制：CP A, B</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">compareRegisterB</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 创建 A 的副本并模拟 A - B</span></span><br><span class="line">  <span class="keyword">let</span> result = <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span>;</span><br><span class="line">  result -= <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">b</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置减法标志</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">f</span> = <span class="variable constant_">CPU_FLAGS</span>.<span class="property">OPERATION</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查 A 是否等于 B（结果为 0）以及 A 是否小于 B（结果为负，产生借位）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setFlag</span>(<span class="variable constant_">CPU_FLAGS</span>.<span class="property">ZERO</span>, !(result &amp; <span class="number">255</span>)); <span class="comment">// 结果为0则设置零标志</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setFlag</span>(<span class="variable constant_">CPU_FLAGS</span>.<span class="property">CARRY</span>, result &lt; <span class="number">0</span>);     <span class="comment">// 结果为负（下溢）则设置进位标志</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置指令执行时间（1 机器周期，4 时钟周期)</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">m</span> = <span class="number">1</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span> = <span class="number">4</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>NOP（无操作指令）：这个指令不做任何事情，仅仅消耗 CPU 周期，用来延时或指令对齐。</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无操作指令，不执行任何操作只是浪费时间</span></span><br><span class="line"><span class="comment"> * 延时或指令对齐用：NOP</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">noOperation</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">m</span> = <span class="number">1</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span> = <span class="number">4</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>最后弄个调试工具，要打印出当前所有寄存器的十六进制值、标志位的状态以及时钟技术。</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取当前 CPU 状态的字符串表示，用于调试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getStatusString</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> r = <span class="variable language_">this</span>.<span class="property">registers</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`CPU状态:</span></span><br><span class="line"><span class="string">  寄存器: A=<span class="subst">${r.a.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span> B=<span class="subst">${r.b.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span> C=<span class="subst">${r.c.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span></span></span><br><span class="line"><span class="string">          D=<span class="subst">${r.d.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span> E=<span class="subst">${r.e.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span> H=<span class="subst">${r.h.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span> L=<span class="subst">${r.l.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span></span></span><br><span class="line"><span class="string">  标志位: F=<span class="subst">${r.f.toString(<span class="number">16</span>).padStart(<span class="number">2</span>,<span class="string">'0'</span>)}</span> [Z:<span class="subst">${<span class="variable language_">this</span>.getFlag(CPU_FLAGS.ZERO)?<span class="number">1</span>:<span class="number">0</span>}</span> N:<span class="subst">${<span class="variable language_">this</span>.getFlag(CPU_FLAGS.OPERATION)?<span class="number">1</span>:<span class="number">0</span>}</span> H:<span class="subst">${<span class="variable language_">this</span>.getFlag(CPU_FLAGS.HALF_CARRY)?<span class="number">1</span>:<span class="number">0</span>}</span> C:<span class="subst">${<span class="variable language_">this</span>.getFlag(CPU_FLAGS.CARRY)?<span class="number">1</span>:<span class="number">0</span>}</span>]</span></span><br><span class="line"><span class="string">  PC=<span class="subst">${r.pc.toString(<span class="number">16</span>).padStart(<span class="number">4</span>,<span class="string">'0'</span>)}</span> SP=<span class="subst">${r.sp.toString(<span class="number">16</span>).padStart(<span class="number">4</span>,<span class="string">'0'</span>)}</span></span></span><br><span class="line"><span class="string">  时钟: M=<span class="subst">${<span class="variable language_">this</span>.clock.m}</span> T=<span class="subst">${<span class="variable language_">this</span>.clock.t}</span>`</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="13-完整指令集与执行循环"><a class="markdownIt-Anchor" href="#13-完整指令集与执行循环"></a> 1.3. 完整指令集与执行循环</h2>
<p>在前面我们实现了几个示例指令，但真正的 GameBoy CPU 需要支持完整的 Z80 指令集。现代模拟器的核心是建立一个高效的「取值 → 解码 → 执行」循环，这个循环每秒要执行数百万次。</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 指令时序常量（T 周期）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">INSTRUCTION_TIMINGS</span> = {</span><br><span class="line">  <span class="comment">// 基础指令时序</span></span><br><span class="line">  <span class="attr">NOP</span>: <span class="number">4</span>,              <span class="comment">// 0x00: NOP</span></span><br><span class="line">  <span class="attr">LD_BC_nn</span>: <span class="number">12</span>,        <span class="comment">// 0x01: LD BC,nn</span></span><br><span class="line">  <span class="attr">LD_MEM_BC_A</span>: <span class="number">8</span>,      <span class="comment">// 0x02: LD (BC),A</span></span><br><span class="line">  <span class="attr">INC_BC</span>: <span class="number">8</span>,           <span class="comment">// 0x03: INC BC</span></span><br><span class="line">  <span class="attr">INC_B</span>: <span class="number">4</span>,            <span class="comment">// 0x04: INC B</span></span><br><span class="line">  <span class="attr">DEC_B</span>: <span class="number">4</span>,            <span class="comment">// 0x05: DEC B</span></span><br><span class="line">  <span class="attr">LD_B_n</span>: <span class="number">8</span>,           <span class="comment">// 0x06: LD B,n</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 跳转指令</span></span><br><span class="line">  <span class="attr">JR_s8</span>: <span class="number">12</span>,           <span class="comment">// 0x18: JR s8</span></span><br><span class="line">  <span class="attr">JR_NZ_s8</span>: <span class="number">8</span>,         <span class="comment">// 0x20: JR NZ,s8 (8 if not taken, 12 if taken)</span></span><br><span class="line">  <span class="attr">JR_Z_s8</span>: <span class="number">8</span>,          <span class="comment">// 0x28: JR Z,s8</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 算术指令</span></span><br><span class="line">  <span class="attr">ADD_A_r</span>: <span class="number">4</span>,          <span class="comment">// 0x80-0x87: ADD A,r</span></span><br><span class="line">  <span class="attr">SUB_r</span>: <span class="number">4</span>,            <span class="comment">// 0x90-0x97: SUB r</span></span><br><span class="line">  <span class="attr">AND_r</span>: <span class="number">4</span>,            <span class="comment">// 0xA0-0xA7: AND r</span></span><br><span class="line">  <span class="attr">CP_r</span>: <span class="number">4</span>,             <span class="comment">// 0xB8-0xBF: CP r</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 其他</span></span><br><span class="line">  <span class="attr">HALT</span>: <span class="number">4</span>,             <span class="comment">// 0x76: HALT</span></span><br><span class="line">  <span class="attr">RET</span>: <span class="number">16</span>,             <span class="comment">// 0xC9: RET</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>指令映射是现代模拟器的核心技术。我们创建了一个 256 元素的数组，每个元素对应一个操作码（opcode），直接指向对应的函数。这避免了复杂的 switch-case 语句，大幅提升执行效率：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建指令映射表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">buildInstructionMap</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基础指令集</span></span><br><span class="line">  map[<span class="number">0x00</span>] = <span class="variable language_">this</span>.<span class="property">nop</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);           <span class="comment">// NOP</span></span><br><span class="line">  map[<span class="number">0x01</span>] = <span class="variable language_">this</span>.<span class="property">ld_bc_nn</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);     <span class="comment">// LD BC,nn</span></span><br><span class="line">  map[<span class="number">0x02</span>] = <span class="variable language_">this</span>.<span class="property">ld_mem_bc_a</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);  <span class="comment">// LD (BC),A</span></span><br><span class="line">  map[<span class="number">0x03</span>] = <span class="variable language_">this</span>.<span class="property">inc_bc</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);       <span class="comment">// INC BC</span></span><br><span class="line">  map[<span class="number">0x04</span>] = <span class="variable language_">this</span>.<span class="property">inc_b</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);        <span class="comment">// INC B</span></span><br><span class="line">  map[<span class="number">0x05</span>] = <span class="variable language_">this</span>.<span class="property">dec_b</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);        <span class="comment">// DEC B</span></span><br><span class="line">  map[<span class="number">0x06</span>] = <span class="variable language_">this</span>.<span class="property">ld_b_n</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);       <span class="comment">// LD B,n</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 跳转指令</span></span><br><span class="line">  map[<span class="number">0x18</span>] = <span class="variable language_">this</span>.<span class="property">jr_s8</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);        <span class="comment">// JR s8</span></span><br><span class="line">  map[<span class="number">0x20</span>] = <span class="variable language_">this</span>.<span class="property">jr_nz_s8</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);     <span class="comment">// JR NZ,s8</span></span><br><span class="line">  map[<span class="number">0x28</span>] = <span class="variable language_">this</span>.<span class="property">jr_z_s8</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);      <span class="comment">// JR Z,s8</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 算术指令 - ADD A,r（批量注册）</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0x80</span>; i &lt;= <span class="number">0x87</span>; i++) {</span><br><span class="line">    map[i] = <span class="variable language_">this</span>.<span class="property">add_a_r</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>, i &amp; <span class="number">0x07</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 比较指令 - CP r（批量注册）</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0xB8</span>; i &lt;= <span class="number">0xBF</span>; i++) {</span><br><span class="line">    map[i] = <span class="variable language_">this</span>.<span class="property">cp_r</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>, i &amp; <span class="number">0x07</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 填充未实现的指令</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) {</span><br><span class="line">    <span class="keyword">if</span> (!map[i]) {</span><br><span class="line">      map[i] = <span class="variable language_">this</span>.<span class="property">unimplemented</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>, i);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> map;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>CPU 执行的核心是 <code>step()</code> 方法。每次调用它会执行一条指令，这个方法每秒会被调用数百万次：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行单条指令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">step</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">halted</span> || <span class="variable language_">this</span>.<span class="property">stopped</span>) {</span><br><span class="line">    <span class="comment">// CPU 处于暂停状态，只更新时钟</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">m</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateClocks</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">mmu</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'CPU 未连接到 MMU'</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// 取指令：从 PC 指向的内存地址读取操作码</span></span><br><span class="line">    <span class="keyword">const</span> opcode = <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">readByte</span>(<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">pc</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">pc</span> = (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">pc</span> + <span class="number">1</span>) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录指令（用于调试）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">lastInstruction</span> = opcode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解码并执行：直接通过映射表调用对应函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instructionMap</span>[opcode]();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新统计</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">instructionsExecuted</span>++;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">lastCycles</span> = <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">totalCycles</span> += <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新时钟</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">updateClocks</span>();</span><br><span class="line"></span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`❌ CPU 执行错误 PC=0x<span class="subst">${<span class="variable language_">this</span>.registers.pc.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>:`</span>, error);</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>为了简化指令实现，我们提供了一组辅助方法来处理常见的寄存器操作：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取寄存器值（按编号）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getRegisterValue</span>(<span class="params">regNum</span>) {</span><br><span class="line">  <span class="keyword">switch</span> (regNum) {</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">b</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">c</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">d</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">e</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">h</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">l</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">readByte</span>(<span class="variable language_">this</span>.<span class="title function_">getHL</span>()); <span class="comment">// (HL)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>: <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span>;</span><br><span class="line">    <span class="attr">default</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取 16 位寄存器组合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getBC</span>(<span class="params"></span>) { <span class="keyword">return</span> (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">b</span> &lt;&lt; <span class="number">8</span>) | <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">c</span>; }</span><br><span class="line"><span class="title function_">getDE</span>(<span class="params"></span>) { <span class="keyword">return</span> (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">d</span> &lt;&lt; <span class="number">8</span>) | <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">e</span>; }</span><br><span class="line"><span class="title function_">getHL</span>(<span class="params"></span>) { <span class="keyword">return</span> (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">h</span> &lt;&lt; <span class="number">8</span>) | <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">l</span>; }</span><br><span class="line"></span><br><span class="line"><span class="title function_">setBC</span>(<span class="params">value</span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">b</span> = (value &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">c</span> = value &amp; <span class="number">0xFF</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="14-导出"><a class="markdownIt-Anchor" href="#14-导出"></a> 1.4. 导出</h2>
<p>在文件的最下方、<code>GameBoyCPU</code> 类的外部添加导出代码：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">module</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">exports</span>) {</span><br><span class="line">  <span class="comment">// Node.js 环境导出</span></span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">exports</span> = { <span class="title class_">GameBoyCPU</span>, <span class="variable constant_">CPU_FLAGS</span>, <span class="variable constant_">INSTRUCTION_TIMINGS</span> };</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">'undefined'</span>) {</span><br><span class="line">  <span class="comment">// 浏览器环境导出到全局对象</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">GameBoyCPU</span> = <span class="title class_">GameBoyCPU</span>;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">CPU_FLAGS</span> = <span class="variable constant_">CPU_FLAGS</span>;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">INSTRUCTION_TIMINGS</span> = <span class="variable constant_">INSTRUCTION_TIMINGS</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="2-模拟内存管理单元"><a class="markdownIt-Anchor" href="#2-模拟内存管理单元"></a> 2. 模拟内存管理单元</h1>
<p>我们的 GameBoy CPU 骨架虽然能够执行指令并管理内存寄存器，但是一个没有内存的 CPU 就跟一个没有书的图书馆差不多，光有管理员也没啥用。CPU 必需能够与外部内存交互，才能读取程序代码、存取数据，并与各种硬件组件通信。</p>
<p>这就是 <strong>内存管理单元</strong>（MMU）的作用。MMU 负责管理 GameBoy 的整个 64KB 的地址空间，并将 CPU 的内存访问请求路由到正确的物理内存区域。</p>
<blockquote>
<p>为什么需要 MMU？（大白话 + 1）</p>
<p>想象你在管理一个大仓库，有多大呢？GameBoy 的 64KB 内存相当于有 65536 个格子，你的大仓库也有这 65536 个格子：</p>
<ul>
<li>有些格子放游戏程序（ROM）</li>
<li>有些格子放临时数据（RAM）</li>
<li>有些格子放图片数据（VRAM）</li>
<li>有些格子是控制按钮（I / O 寄存器）</li>
</ul>
<p>CPU 依然是那个工人。假设他想要 <code>0x8000</code> 地址的数据。</p>
<p>如果没有 MMU 的话，CPU 就得自己跑到 <code>0x8000</code> 格子、搞清楚这个格子到底存的是什么、自行处理各种复杂情况。</p>
<p>有了 MMU 的话，CPU 只需要说他要 <code>0x8000</code> 的数据，MMU 就会：</p>
<ol>
<li>「<code>0x8000</code> 是图片数据区域。」</li>
<li>「这个区域的数据在 VRAM 里。」</li>
<li>「给你！」</li>
</ol>
<p>这样看，MMU 就像是一个很靠谱的仓库管理员。</p>
</blockquote>
<h2 id="21-gameboy-内存映射"><a class="markdownIt-Anchor" href="#21-gameboy-内存映射"></a> 2.1. GameBoy 内存映射</h2>
<p>与现代计算机复杂的内存管理不同，GameBoy 的内存映射相对直观，但仍然包含了多个不同功能的区域。理解这个内存映射对于正确模拟 GameBoy 至关重要。</p>
<p>GameBoy 的 64KB 地址空间被划分为以下主要区域：</p>
<ul>
<li><code>0x0000 - 0x3FFF</code>：卡带 ROM 银行 0<br>
这是游戏卡带程序的第一个 16KB 区域，始终可访问。
<ul>
<li><code>0x0000 - 0x00FF</code>：BIOS：GameBoy 启动时，CPU 从 <code>0x0000</code> 地址开始执行 BIOS 代码。一旦 BIOS 运行完毕，这片区域就会被卡带 ROM 覆盖，不再可访问。</li>
<li><code>0x0100 - 0x014F</code>：卡带头部：这部分包含游戏的名称、制造商、ROM / RAM 大小等关键信息。</li>
</ul>
</li>
<li><code>0x4000 - 0x7FFF</code>：卡带 ROM 其他银行<br>
对于大于 32KB 的游戏，卡带会包含多个 16KB 的 ROM 银行。MMU 需要通过 <strong>内存银行控制器</strong>（MBC）来切换这些银行，以便 CPU 能够访问整个游戏程序。对于 32KB 或更小的游戏，这个区域也直接是 ROM 的一部分，无需银行切换。</li>
<li><code>0x8000 - 0x9FFF</code>：视频 RAM<br>
存储用于渲染游戏背景和精灵图形数据。这部分内存对 CPU 可读写，但主要由图形处理单元（GPU）使用。</li>
<li><code>0xA000 - 0xBFFF</code>：卡带外部 RAM<br>
部分游戏卡带会包含额外的可读写内存，用于保存游戏进度或临时数据。</li>
<li><code>0xC000 - 0xDFFF</code>：工作 RAM<br>
这是 GameBoy 内部的主工作内存，CPU 可以自由读写，用于存储程序变量、栈等。</li>
<li><code>0xE000 - 0xFDFF</code>：工作 RAM 镜像<br>
由于硬件接线的设计，工作 RAM 在内存映射中有一个完全相同的镜像区域。这意味着对 <code>0xE000-0xFDFF</code> 的读写实际上是对 <code>0xC000-0xDFFF</code> 的读写。</li>
<li><code>0xFE00 - 0xFE9F</code>：精灵属性表<br>
存储屏幕上所有精灵（例如角色、敌人）的位置、大小、图形数据索引等属性信息。</li>
<li><code>0xFF00 - 0xFF7F</code>：内存映射 I / O 寄存器<br>
这个区域包含了控制 GameBoy 各个硬件子系统（如图形、声音、定时器、输入）的寄存器。CPU 通过读写这些地址来控制硬件行为。</li>
<li><code>0xFF80 - 0xFFFF</code>：零页 RAM<br>
又称「高速 RAM」，这片区域是 GameBoy 最顶部的内存，CPU 访问它们的速度最快。虽然地址很高，但因其在汇编编程中的常用性，常被称为「零页」。</li>
</ul>
<blockquote>
<p>太复杂了看不懂、一图胜千言版本：</p>
<p>GameBoy 的 64KB 内存就像一栋 8 层楼的公寓：</p>
<p>🏢 GameBoy 内存公寓（64KB）<br>
├── 8 楼（<code>0xFF00-0xFFFF</code>）控制中心（按钮、音量调节等）<br>
├── 7 楼（<code>0xFE00-0xFEFF</code>）精灵属性（角色信息）<br>
├── 6 楼（<code>0xE000-0xFDFF</code>）工作区镜像（楼下的复印件）<br>
├── 5 楼（<code>0xC000-0xDFFF</code>）工作区（临时文件柜）<br>
├── 4 楼（<code>0xA000-0xBFFF</code>）卡带存档（游戏进度）<br>
├── 3 楼（<code>0x8000-0x9FFF</code>）图片仓库（所有图像数据）<br>
├── 2 楼（<code>0x4000-0x7FFF</code>）游戏程序（第 2 部分）<br>
└── 1 楼（<code>0x0000-0x3FFF</code>）游戏程序（第 1 部分）<br>
└── 地下室（<code>0x0000-0x00FF</code>）开机程序（BIOS）</p>
<p>每次 CPU 说他想要 <code>0x8000</code> 的数据，MMU 就知道：「哦，你要 3 楼图片仓库的东西。」</p>
</blockquote>
<p>为了在代码中清晰地表示这些区域，我们定义一个 <code>MEMORY_REGIONS</code> 常量对象：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 内存区域常量定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MEMORY_REGIONS</span> = {</span><br><span class="line">  <span class="comment">// ROM 区域</span></span><br><span class="line">  <span class="attr">ROM_BANK_0_START</span>: <span class="number">0x0000</span>,</span><br><span class="line">  <span class="attr">ROM_BANK_0_END</span>: <span class="number">0x3FFF</span>,</span><br><span class="line">  <span class="attr">ROM_BANK_1_START</span>: <span class="number">0x4000</span>,</span><br><span class="line">  <span class="attr">ROM_BANK_1_END</span>: <span class="number">0x7FFF</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BIOS 区域（在 ROM 银行 0 内）</span></span><br><span class="line">  <span class="attr">BIOS_START</span>: <span class="number">0x0000</span>,</span><br><span class="line">  <span class="attr">BIOS_END</span>: <span class="number">0x00FF</span>,</span><br><span class="line">  <span class="attr">BIOS_EXIT_POINT</span>: <span class="number">0x0100</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 卡带头部（在 ROM 银行 0 内）</span></span><br><span class="line">  <span class="attr">CARTRIDGE_HEADER_START</span>: <span class="number">0x0100</span>,</span><br><span class="line">  <span class="attr">CARTRIDGE_HEADER_END</span>: <span class="number">0x014F</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 视频 RAM</span></span><br><span class="line">  <span class="attr">VRAM_START</span>: <span class="number">0x8000</span>,</span><br><span class="line">  <span class="attr">VRAM_END</span>: <span class="number">0x9FFF</span>,</span><br><span class="line">  <span class="attr">VRAM_SIZE</span>: <span class="number">0x2000</span>, <span class="comment">// 8KB</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 外部 RAM</span></span><br><span class="line">  <span class="attr">ERAM_START</span>: <span class="number">0xA000</span>,</span><br><span class="line">  <span class="attr">ERAM_END</span>: <span class="number">0xBFFF</span>,</span><br><span class="line">  <span class="attr">ERAM_SIZE</span>: <span class="number">0x2000</span>, <span class="comment">// 8KB</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 工作 RAM</span></span><br><span class="line">  <span class="attr">WRAM_START</span>: <span class="number">0xC000</span>,</span><br><span class="line">  <span class="attr">WRAM_END</span>: <span class="number">0xDFFF</span>,</span><br><span class="line">  <span class="attr">WRAM_SIZE</span>: <span class="number">0x2000</span>, <span class="comment">// 8KB</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 工作 RAM 镜像</span></span><br><span class="line">  <span class="attr">WRAM_SHADOW_START</span>: <span class="number">0xE000</span>,</span><br><span class="line">  <span class="attr">WRAM_SHADOW_END</span>: <span class="number">0xFDFF</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 精灵属性内存</span></span><br><span class="line">  <span class="attr">OAM_START</span>: <span class="number">0xFE00</span>,</span><br><span class="line">  <span class="attr">OAM_END</span>: <span class="number">0xFE9F</span>,</span><br><span class="line">  <span class="attr">OAM_SIZE</span>: <span class="number">0xA0</span>, <span class="comment">// 160 字节</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// I/O 寄存器</span></span><br><span class="line">  <span class="attr">IO_START</span>: <span class="number">0xFF00</span>,</span><br><span class="line">  <span class="attr">IO_END</span>: <span class="number">0xFF7F</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 零页 RAM</span></span><br><span class="line">  <span class="attr">ZRAM_START</span>: <span class="number">0xFF80</span>,</span><br><span class="line">  <span class="attr">ZRAM_END</span>: <span class="number">0xFFFF</span>,</span><br><span class="line">  <span class="attr">ZRAM_SIZE</span>: <span class="number">0x80</span> <span class="comment">// 128 字节</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h2 id="22-mmu-类结构与初始化"><a class="markdownIt-Anchor" href="#22-mmu-类结构与初始化"></a> 2.2. MMU 类结构与初始化</h2>
<p>我们的 <code>GameBoyMMU</code> 类会负责创建和管理这些内存区域的实际存储（用 <code>Unit8Array</code>），并提供读写内存的接口。</p>
<p>在构造函数里，首先要调用 <code>initializeMemoryRegions</code> 来分配各个内存区域的存储空间，然后调用 <code>reset</code> 方法将它们清空并设置初始状态。</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GameBoy 内存管理单元类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameBoyMMU</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeMemoryRegions</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">reset</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化所有内存区域</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initializeMemoryRegions</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// BIOS 数据（256 字节），GameBoy 启动代码</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bios</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">256</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 卡带 ROM 数据（最大 32KB 基础 ROM）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rom</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">0x8000</span>); <span class="comment">// 32KB 初始空间</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 视频 RAM（8KB），存储背景和精灵图形数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vram</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">VRAM_SIZE</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 外部 RAM（8KB），卡带上的额外可写内存</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eram</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">ERAM_SIZE</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工作 RAM（8KB），GameBoy 内部 RAM</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">wram</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">WRAM_SIZE</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 零页 RAM（128 字节），高速访问内存</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">zram</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">ZRAM_SIZE</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 精灵属性内存（160 字节），存储精灵位置和属性</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">oam</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">OAM_SIZE</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// I/O 寄存器映射（128 字节），硬件控制寄存器</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ioRegisters</span> = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">0x80</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 重置 MMU 到初始状态</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">reset</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// BIOS 映射标志，控制是否显示 BIOS 区域</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">biosEnabled</span> = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清空所有可写内存区域</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vram</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eram</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">wram</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">zram</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">oam</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ioRegisters</span>.<span class="title function_">fill</span>(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'MMU 已重置到初始状态'</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="23-内存读取"><a class="markdownIt-Anchor" href="#23-内存读取"></a> 2.3. 内存读取</h2>
<p>MMU 最核心的功能就是根据 CPU 请求的地址，将其路由到正确的内存区域并返回数据。<code>readByte(address)</code> 方法实现了这一逻辑：它根据 16 位地址的不同范围，返回对应 <code>Uint8Array</code> 中的字节。</p>
<p>这里需要特别注意 BIOS 区域的逻辑：当 CPU 程序计数器 <code>PC</code> 达到 <code>0x0100</code> 时，表明 BIOS 已经执行完毕，此时我们会禁用 BIOS 映射（<code>this.biosEnabled = false;</code>），让该地址范围（<code>0x0000-0x00FF</code>）切换到显示卡带 ROM。</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 之前写的方法 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从指定地址读取 8 位字节</span></span><br><span class="line"><span class="comment"> * 根据地址范围路由到相应的内存区域</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 16 位内存地址（0x0000-0xFFFF）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">number</span>} 8 位数据值（0x00-0xFF）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">readByte</span>(<span class="params">address</span>) {</span><br><span class="line">  <span class="comment">// 确保地址在 16 位范围内</span></span><br><span class="line">  address &amp;= <span class="number">0xFFFF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据地址高 4 位进行初步分类，提升性能</span></span><br><span class="line">  <span class="keyword">switch</span> (address &amp; <span class="number">0xF000</span>) {</span><br><span class="line">    <span class="comment">// 0x0000-0x0FFF: BIOS/ROM 银行 0 区域</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x0000</span>: {</span><br><span class="line">      <span class="comment">// 检查是否在 BIOS 区域且 BIOS 已启用</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">biosEnabled</span> &amp;&amp; address &lt; <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">BIOS_EXIT_POINT</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">bios</span>[address];</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// BIOS 退出检查：当 PC 到达 0x0100 时禁用 BIOS</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> 这里依赖于全局的 cpu 实例，后续可以考虑通过依赖注入优化</span></span><br><span class="line">      <span class="keyword">if</span> (address === <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">BIOS_EXIT_POINT</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">cpu</span>?.<span class="property">registers</span>?.<span class="property">pc</span> === <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">BIOS_EXIT_POINT</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">biosEnabled</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'BIOS已退出，切换到卡带ROM'</span>);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">rom</span>[address]; <span class="comment">// 否则读取 ROM</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x1000-0x3FFF: ROM 银行 0 的其余部分</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x2000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x3000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">rom</span>[address];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x4000-0x7FFF: ROM 银行 1（可切换） - 基础模拟中直接从 rom 读取</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x4000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x5000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x7000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">rom</span>[address];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x8000-0x9FFF: 视频 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x8000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vram</span>[address &amp; <span class="number">0x1FFF</span>]; <span class="comment">// 限制在 8KB（0x2000）范围内</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xA000-0xBFFF: 外部 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xA000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xB000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">eram</span>[address &amp; <span class="number">0x1FFF</span>]; <span class="comment">// 限制在 8KB 范围内</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xC000-0xDFFF: 工作 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xD000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">wram</span>[address &amp; <span class="number">0x1FFF</span>]; <span class="comment">// 限制在 8KB 范围内</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xE000-0xEFFF: 工作 RAM 镜像</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xE000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">wram</span>[address &amp; <span class="number">0x1FFF</span>]; <span class="comment">// 映射到工作 RAM</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xF000-0xFFFF: 复杂区域 - 包含 RAM 镜像、OAM、I/O、零页 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xF000</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">readHighMemoryRegion</span>(address); <span class="comment">// 调用辅助函数处理高地址区域</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`未处理的内存读取地址: 0x<span class="subst">${address.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFF</span>; <span class="comment">// 返回未连接总线的典型值（全1）</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理高内存区域的读取（0xF000-0xFFFF）</span></span><br><span class="line"><span class="comment"> * 这个区域包含多个不同的内存映射，需要进一步细分</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 内存地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">number</span>} 读取的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">readHighMemoryRegion</span>(<span class="params">address</span>) {</span><br><span class="line">  <span class="comment">// 根据地址的中间 4 位进一步分类</span></span><br><span class="line">  <span class="keyword">switch</span> (address &amp; <span class="number">0x0F00</span>) {</span><br><span class="line">    <span class="comment">// 0xF000-0xFDFF: 工作 RAM 镜像的剩余部分</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x000</span>: <span class="keyword">case</span> <span class="number">0x100</span>: <span class="keyword">case</span> <span class="number">0x200</span>: <span class="keyword">case</span> <span class="number">0x300</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x400</span>: <span class="keyword">case</span> <span class="number">0x500</span>: <span class="keyword">case</span> <span class="number">0x600</span>: <span class="keyword">case</span> <span class="number">0x700</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x800</span>: <span class="keyword">case</span> <span class="number">0x900</span>: <span class="keyword">case</span> <span class="number">0xA00</span>: <span class="keyword">case</span> <span class="number">0xB00</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC00</span>: <span class="keyword">case</span> <span class="number">0xD00</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">wram</span>[address &amp; <span class="number">0x1FFF</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xFE00-0xFEFF: 精灵属性内存区域（OAM）</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xE00</span>:</span><br><span class="line">      <span class="keyword">if</span> (address &lt; <span class="number">0xFEA0</span>) {</span><br><span class="line">        <span class="comment">// 有效的 OAM 区域（0xFE00-0xFE9F）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">oam</span>[address &amp; <span class="number">0xFF</span>]; <span class="comment">// 限制在 160 字节（0xA0）范围内</span></span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 0xFEA0-0xFEFF: 未使用区域，读取通常返回 0 或 0xFF，这里统一返回 0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xFF00-0xFFFF: I/O 寄存器和零页 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xF00</span>:</span><br><span class="line">      <span class="keyword">if</span> (address &gt;= <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">ZRAM_START</span>) {</span><br><span class="line">        <span class="comment">// 0xFF80-0xFFFF: 零页 RAM</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">zram</span>[address &amp; <span class="number">0x7F</span>]; <span class="comment">// 限制在 128 字节（0x80）范围内</span></span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 0xFF00-0xFF7F: I/O 寄存器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">readIORegister</span>(address); <span class="comment">// 调用辅助函数处理 I/O 寄存器读取</span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFF</span>; <span class="comment">// 未知区域返回 0xFF</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取 I/O 寄存器</span></span><br><span class="line"><span class="comment"> * 这些寄存器控制 GameBoy 的各个硬件子系统。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> 目前只是返回其在内部数组中的值，具体硬件逻辑将在后续章节实现。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address I/O 寄存器地址（0xFF00-0xFF7F）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">number</span>} 寄存器值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">readIORegister</span>(<span class="params">address</span>) {</span><br><span class="line">  <span class="keyword">const</span> registerIndex = address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>;</span><br><span class="line">  <span class="comment">// 返回 I/O 寄存器数组中的值，如果超出范围则返回 0（或 0xFF）</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[registerIndex] || <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从指定地址读取 16 位字（小端序 - Little Endian）</span></span><br><span class="line"><span class="comment"> * GameBoy CPU 使用小端序存储多字节数据，即低位字节在前。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 起始地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">number</span>} 16位值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">readWord</span>(<span class="params">address</span>) {</span><br><span class="line">  <span class="keyword">const</span> lowByte = <span class="variable language_">this</span>.<span class="title function_">readByte</span>(address);</span><br><span class="line">  <span class="keyword">const</span> highByte = <span class="variable language_">this</span>.<span class="title function_">readByte</span>(address + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> lowByte | (highByte &lt;&lt; <span class="number">8</span>); <span class="comment">// 将高位字节左移 8 位后与低位字节合并</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="24-内存写入"><a class="markdownIt-Anchor" href="#24-内存写入"></a> 2.4. 内存写入</h2>
<p>内存写入的逻辑与读取类似，<code>writeByte(address, value)</code> 方法根据地址将数据写入对应的内存区域。需要注意的是，ROM 区域通常是只读的，任何写入操作都会被忽略（除了用于内存银行切换的特殊地址，这将在后面讨论）。</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 之前写的方法 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向指定地址写入 8 位字节</span></span><br><span class="line"><span class="comment"> * 根据地址范围路由到相应的内存区域</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 16 位内存地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} value 8 位数据值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeByte</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="comment">// 确保地址和值在有效范围内</span></span><br><span class="line">  address &amp;= <span class="number">0xFFFF</span>;</span><br><span class="line">  value &amp;= <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据地址高 4 位进行分类</span></span><br><span class="line">  <span class="keyword">switch</span> (address &amp; <span class="number">0xF000</span>) {</span><br><span class="line">    <span class="comment">// 0x0000-0x7FFF: ROM 区域 - 通常只读，但可能有银行切换逻辑</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x0000</span>: <span class="keyword">case</span> <span class="number">0x1000</span>: <span class="keyword">case</span> <span class="number">0x2000</span>: <span class="keyword">case</span> <span class="number">0x3000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x4000</span>: <span class="keyword">case</span> <span class="number">0x5000</span>: <span class="keyword">case</span> <span class="number">0x6000</span>: <span class="keyword">case</span> <span class="number">0x7000</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleROMWrite</span>(address, value); <span class="comment">// 专门处理 ROM 区域的写入</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x8000-0x9FFF: 视频 RAM - 可写</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x8000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x9000</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">vram</span>[address &amp; <span class="number">0x1FFF</span>] = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xA000-0xBFFF: 外部 RAM - 可写</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xA000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xB000</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">eram</span>[address &amp; <span class="number">0x1FFF</span>] = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xC000-0xDFFF: 工作 RAM - 可写</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC000</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xD000</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">wram</span>[address &amp; <span class="number">0x1FFF</span>] = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xE000-0xEFFF: 工作 RAM 镜像 - 写入映射到工作 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xE000</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">wram</span>[address &amp; <span class="number">0x1FFF</span>] = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xF000-0xFFFF: 高内存区域</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xF000</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">writeHighMemoryRegion</span>(address, value); <span class="comment">// 调用辅助函数处理高地址区域写入</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`未处理的内存写入地址: 0x<span class="subst">${address.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理 ROM 区域的写入</span></span><br><span class="line"><span class="comment"> * ROM 通常是只读的。在基础模拟中，任何对 ROM 区域的写入都会被忽略。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> 在未来的内存银行章节中，这里将包含处理卡带内存银行控制器的逻辑。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} value 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">handleROMWrite</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ROM写入被忽略: 地址=0x<span class="subst">${address.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>, 值=0x<span class="subst">${value.toString(<span class="number">16</span>).padStart(<span class="number">2</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理高内存区域的写入（0xF000-0xFFFF）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} value 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeHighMemoryRegion</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="keyword">switch</span> (address &amp; <span class="number">0x0F00</span>) {</span><br><span class="line">    <span class="comment">// 0xF000-0xFDFF: 工作 RAM 镜像 - 写入映射到工作 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x000</span>: <span class="keyword">case</span> <span class="number">0x100</span>: <span class="keyword">case</span> <span class="number">0x200</span>: <span class="keyword">case</span> <span class="number">0x300</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x400</span>: <span class="keyword">case</span> <span class="number">0x500</span>: <span class="keyword">case</span> <span class="number">0x600</span>: <span class="keyword">case</span> <span class="number">0x700</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x800</span>: <span class="keyword">case</span> <span class="number">0x900</span>: <span class="keyword">case</span> <span class="number">0xA00</span>: <span class="keyword">case</span> <span class="number">0xB00</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC00</span>: <span class="keyword">case</span> <span class="number">0xD00</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">wram</span>[address &amp; <span class="number">0x1FFF</span>] = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xFE00-0xFEFF: 精灵属性内存（OAM）</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xE00</span>:</span><br><span class="line">      <span class="keyword">if</span> (address &lt; <span class="number">0xFEA0</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">oam</span>[address &amp; <span class="number">0xFF</span>] = value;</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// 0xFEA0-0xFEFF 区域的写入通常被忽略</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xFF00-0xFFFF: I/O 寄存器和零页 RAM</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xF00</span>:</span><br><span class="line">      <span class="keyword">if</span> (address &gt;= <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">ZRAM_START</span>) {</span><br><span class="line">        <span class="comment">// 零页 RAM</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">zram</span>[address &amp; <span class="number">0x7F</span>] = value;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// I/O 寄存器</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">writeIORegister</span>(address, value);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入 I/O 寄存器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address I/O 寄存器地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} value 要写入的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeIORegister</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="keyword">const</span> registerIndex = address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[registerIndex] = value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 在后续章节中，这里将处理特定 I/O 寄存器写入的副作用</span></span><br><span class="line">  <span class="comment">// 例如：当写入显示控制寄存器时触发屏幕更新，或写入声音寄存器时播放声音</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向指定地址写入 16 位字（小端序）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} address 起始地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} value 16 位值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeWord</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">writeByte</span>(address, value &amp; <span class="number">0xFF</span>);            <span class="comment">// 写入低位字节</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">writeByte</span>(address + <span class="number">1</span>, (value &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>); <span class="comment">// 写入高位字节</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="25-加载-rom-与-bios"><a class="markdownIt-Anchor" href="#25-加载-rom-与-bios"></a> 2.5. 加载 ROM 与 BIOS</h2>
<p>为了让模拟器能够运行游戏，MMU 还需要加载 BIOS 和游戏 ROM 的功能：</p>
<ul>
<li><code>loadBIOS(biosData)</code>：加载 GameBoy 的 BIOS 文件
<ul>
<li>BIOS 是启动时运行的一小段程序，通常用于初始化硬件和显示任天堂的标志</li>
</ul>
</li>
<li><code>loadROM(romData)</code>：加载游戏卡带的 ROM 数据。这个方法会将 ROM 数据复制到 MMU 内部的 <code>this.rom</code> 数组中</li>
<li><code>loadROMFromURL(url)</code>：直接从给定的 URL 下载 ROM 文件并加载</li>
</ul>
<p><code>displayCartridgeInfo()</code> 方法则会从 ROM 的卡带头部读取并打印出游戏的标题、类型、ROM 大小和 RAM 大小等信息，这对于验证 ROM 是否正确加载非常有用。</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 之前写的方法 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载 BIOS 数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">Uint8Array|Array</span>} biosData BIOS 数据数组（应为 256 字节）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">loadBIOS</span>(<span class="params">biosData</span>) {</span><br><span class="line">  <span class="keyword">if</span> (biosData.<span class="property">length</span> !== <span class="number">256</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'BIOS 数据必须正好是 256 字节'</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">bios</span>.<span class="title function_">set</span>(biosData); <span class="comment">// 将传入的 BIOS 数据复制到内部存储</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">biosEnabled</span> = <span class="literal">true</span>; <span class="comment">// 确保 BIOS 映射处于启用状态</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'BIOS 已加载'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载 ROM 文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">Uint8Array|ArrayBuffer</span>} romData ROM 数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">loadROM</span>(<span class="params">romData</span>) {</span><br><span class="line">  <span class="comment">// 转换为 Uint8Array（如果传入的是 ArrayBuffer）</span></span><br><span class="line">  <span class="keyword">const</span> rom = romData <span class="keyword">instanceof</span> <span class="title class_">ArrayBuffer</span> ? <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(romData) : romData;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确保 ROM 不超过 MMU 分配的最大支持大小</span></span><br><span class="line">  <span class="keyword">const</span> maxSize = <span class="variable language_">this</span>.<span class="property">rom</span>.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">if</span> (rom.<span class="property">length</span> &gt; maxSize) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`ROM 大小 <span class="subst">${rom.length}</span> 字节超过最大支持大小 <span class="subst">${maxSize}</span> 字节，将被截断`</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复制 ROM 数据到内部存储，只复制有效部分</span></span><br><span class="line">  <span class="keyword">const</span> copySize = <span class="title class_">Math</span>.<span class="title function_">min</span>(rom.<span class="property">length</span>, maxSize);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">rom</span>.<span class="title function_">set</span>(rom.<span class="title function_">slice</span>(<span class="number">0</span>, copySize));</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ROM 已加载，大小: <span class="subst">${copySize}</span> 字节`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 显示卡带信息，验证 ROM 是否加载正确</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">displayCartridgeInfo</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 显示卡带头部信息</span></span><br><span class="line"><span class="comment"> * 从 ROM 的特定地址读取游戏元数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">displayCartridgeInfo</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 读取卡带标题（0x0134-0x0143）</span></span><br><span class="line">  <span class="keyword">let</span> title = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0x0134</span>; i &lt;= <span class="number">0x0143</span>; i++) {</span><br><span class="line">    <span class="keyword">const</span> char = <span class="variable language_">this</span>.<span class="property">rom</span>[i];</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="number">0</span>) <span class="keyword">break</span>; <span class="comment">// 标题以空字符结束</span></span><br><span class="line">    title += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(char);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取卡带类型（0x0147）</span></span><br><span class="line">  <span class="keyword">const</span> cartridgeType = <span class="variable language_">this</span>.<span class="property">rom</span>[<span class="number">0x0147</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取 ROM 大小（0x0148）</span></span><br><span class="line">  <span class="keyword">const</span> romSizeCode = <span class="variable language_">this</span>.<span class="property">rom</span>[<span class="number">0x0148</span>];</span><br><span class="line">  <span class="comment">// 根据 GameBoy 规范计算 ROM 实际大小，32KB * (2^romSizeCode)</span></span><br><span class="line">  <span class="keyword">const</span> romSize = <span class="number">32</span> * (<span class="number">1</span> &lt;&lt; romSizeCode); <span class="comment">// KB</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读取 RAM 大小（0x0149）</span></span><br><span class="line">  <span class="keyword">const</span> ramSizeCode = <span class="variable language_">this</span>.<span class="property">rom</span>[<span class="number">0x0149</span>];</span><br><span class="line">  <span class="comment">// 根据 GameBoy 规范定义 RAM 大小映射</span></span><br><span class="line">  <span class="keyword">const</span> ramSizes = [<span class="number">0</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">64</span>]; <span class="comment">// KB</span></span><br><span class="line">  <span class="keyword">const</span> ramSize = ramSizes[ramSizeCode] || <span class="number">0</span>; <span class="comment">// 处理未知编码</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'=== 卡带信息 ==='</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`标题: <span class="subst">${title}</span>`</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`卡带类型: 0x<span class="subst">${cartridgeType.toString(<span class="number">16</span>).padStart(<span class="number">2</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`ROM 大小: <span class="subst">${romSize}</span>KB`</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`RAM 大小: <span class="subst">${ramSize}</span>KB`</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步加载 ROM 文件（从 URL）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} url ROM 文件 URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">loadROMFromURL</span>(<span class="params">url</span>) {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`正在加载ROM: <span class="subst">${url}</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url); <span class="comment">// 发起网络请求</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP错误: <span class="subst">${response.status}</span>`</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> romData = <span class="keyword">await</span> response.<span class="title function_">arrayBuffer</span>(); <span class="comment">// 获取二进制数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">loadROM</span>(romData); <span class="comment">// 调用 loadROM 进行处理</span></span><br><span class="line">  } <span class="keyword">catch</span> (error) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'ROM加载失败:'</span>, error);</span><br><span class="line">    <span class="keyword">throw</span> error; <span class="comment">// 重新抛出错误以便外部捕获</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取内存使用情况统计（用于调试）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">Object</span>} 内存使用统计对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getMemoryStats</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">biosEnabled</span>: <span class="variable language_">this</span>.<span class="property">biosEnabled</span>,</span><br><span class="line">    <span class="attr">romLoaded</span>: <span class="variable language_">this</span>.<span class="property">rom</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>), <span class="comment">// 检查 ROM 是否包含数据</span></span><br><span class="line">    <span class="attr">memoryRegions</span>: {</span><br><span class="line">      <span class="attr">bios</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">bios</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">bios</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) },</span><br><span class="line">      <span class="attr">rom</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">rom</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">rom</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) },</span><br><span class="line">      <span class="attr">vram</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">vram</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">vram</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) },</span><br><span class="line">      <span class="attr">eram</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">eram</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">eram</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) },</span><br><span class="line">      <span class="attr">wram</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">wram</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">wram</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) },</span><br><span class="line">      <span class="attr">zram</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">zram</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">zram</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) },</span><br><span class="line">      <span class="attr">oam</span>: { <span class="attr">size</span>: <span class="variable language_">this</span>.<span class="property">oam</span>.<span class="property">length</span>, <span class="attr">used</span>: <span class="variable language_">this</span>.<span class="property">oam</span>.<span class="title function_">some</span>(<span class="function"><span class="params">byte</span> =&gt;</span> byte !== <span class="number">0</span>) }</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取内存转储（用于调试）</span></span><br><span class="line"><span class="comment"> * 以十六进制和 ASCII 形式显示内存内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} startAddr 起始地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} length 要转储的长度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">string</span>} 十六进制转储字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getMemoryDump</span>(<span class="params">startAddr, length = <span class="number">256</span></span>) {</span><br><span class="line">  <span class="keyword">let</span> dump = <span class="string">`内存转储 (0x<span class="subst">${startAddr.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span> - 0x<span class="subst">${(startAddr + length - <span class="number">1</span>).toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>):\n`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每行显示 16 个字节</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i += <span class="number">16</span>) {</span><br><span class="line">    <span class="keyword">const</span> addr = startAddr + i;</span><br><span class="line">    <span class="keyword">let</span> line = <span class="string">`<span class="subst">${addr.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>: `</span>; <span class="comment">// 地址部分</span></span><br><span class="line">    <span class="keyword">let</span> ascii = <span class="string">''</span>; <span class="comment">// ASCII 可视化部分</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span> &amp;&amp; (i + j) &lt; length; j++) {</span><br><span class="line">      <span class="keyword">const</span> byte = <span class="variable language_">this</span>.<span class="title function_">readByte</span>(addr + j);</span><br><span class="line">      line += <span class="string">`<span class="subst">${byte.toString(<span class="number">16</span>).padStart(<span class="number">2</span>, <span class="string">'0'</span>)}</span> `</span>; <span class="comment">// 十六进制字节</span></span><br><span class="line">      <span class="comment">// 将可打印字符转换为 ASCII，否则显示 '.'</span></span><br><span class="line">      ascii += (byte &gt;= <span class="number">32</span> &amp;&amp; byte &lt;= <span class="number">126</span>) ? <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(byte) : <span class="string">'.'</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    line = line.<span class="title function_">padEnd</span>(<span class="number">50</span>, <span class="string">' '</span>) + ascii; <span class="comment">// 填充空格对齐</span></span><br><span class="line">    dump += line + <span class="string">'\n'</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dump;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="26-mmu-与-cpu-的连接"><a class="markdownIt-Anchor" href="#26-mmu-与-cpu-的连接"></a> 2.6. MMU 与 CPU 的连接</h2>
<p>现在我们有了 <code>GameBoyCPU</code> 和 <code>GameBoyMMU</code> 两个类。CPU 需要一个方式来与 MMU 交互，才能真正实现「取指」和「读写内存」的功能。最简单的方式就是将 MMU 实例作为参数传递给 CPU，或者让 CPU 拥有一个 MMU 的引用。</p>
<p>不过也别忘了在 <code>mmu.js</code> 中导出 <code>GameBoyMMU</code> 类和常量：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">module</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">exports</span>) {</span><br><span class="line">  <span class="comment">// Node.js 环境导出</span></span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">exports</span> = { <span class="title class_">GameBoyMMU</span>, <span class="variable constant_">MEMORY_REGIONS</span> };</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">'undefined'</span>) {</span><br><span class="line">  <span class="comment">// 浏览器环境导出到全局对象</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">GameBoyMMU</span> = <span class="title class_">GameBoyMMU</span>;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">MEMORY_REGIONS</span> = <span class="variable constant_">MEMORY_REGIONS</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>然后在 <code>GameBoyCPU</code> 类中，我们可以添加一个对 MMU 的引用：</p>
<figure class="highlight javascript"><figcaption><span>cpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameBoyCPU</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">mmu</span>) { <span class="comment">// 接收 MMU 实例</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mmu</span> = mmu; <span class="comment">// 存储 MMU 引用</span></span><br><span class="line">    <span class="comment">// ... 其他寄存器和时钟初始化 ...</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 示例：实现一个 LD A, (HL) 指令</span></span><br><span class="line">  <span class="comment">// 将 HL 寄存器指向的内存地址的值加载到 A 寄存器</span></span><br><span class="line">  <span class="title function_">loadAToHL</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> address = (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">h</span> &lt;&lt; <span class="number">8</span>) | <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">l</span>; <span class="comment">// 合并 H 和 L 得到 16 位地址</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">a</span> = <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">readByte</span>(address); <span class="comment">// 通过 MMU 读取内存</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">m</span> = <span class="number">2</span>; <span class="comment">// 假设这条指令需要 2 机器周期</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">t</span> = <span class="number">8</span>; <span class="comment">// 假设这条指令需要 8 时钟周期</span></span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// ... 其他指令和方法 ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这样，CPU 就可以通过 <code>this.mmu.readByte()</code>、<code>this.mmu.writeByte()</code> 等方法来访问内存了。</p>
<h1 id="3-gpu-时序让-gameboy-屏幕动起来"><a class="markdownIt-Anchor" href="#3-gpu-时序让-gameboy-屏幕动起来"></a> 3. GPU 时序：让 GameBoy 屏幕动起来</h1>
<p>先前我们已经构建了 GameBoy 模拟器的 CPU 骨架和 MMU，让模拟器能够加载游戏 ROM 并开始执行指令。但是一个没有图像输出的模拟器是没有灵魂的！现在我们得引入 GameBoy 的主要输出设备 —— <strong> 图形处理单元</strong> 也就是我们经常说到的 GPU 了。</p>
<p>GameBoy 的官方内部名称是「点阵式游戏机」（Dot Matrix Game），这是因为它靠着一块 160x144 像素的单色 LCD 屏幕来显示内容。为了模拟这个屏幕，我们可以在 Web 页面中使用一个 HTML5 <code>&lt;canvas&gt;</code> 元素。这个 Canvas 将作为我们的「帧缓冲区」，其中每个像素的颜色都可以被直接操作。</p>
<h2 id="31-模拟屏幕与帧缓冲区"><a class="markdownIt-Anchor" href="#31-模拟屏幕与帧缓冲区"></a> 3.1. 模拟屏幕与帧缓冲区</h2>
<p>要将 GameBoy 的图形输出呈现在网页上，最直接的方法就是创建一个与 GameBoy 屏幕尺寸相同的 Canvas。我们可以通过 Canvas 的 2D 渲染上下文来操作它的像素数据。</p>
<p>GameBoy 的显示分辨率是 160 像素宽和 140 像素高。Canvas 的像素数据通常以 RGBA（红、绿、蓝、透明度）的 4 字节序列存储。这意味着每个像素需要 4 个字节来表示其颜色。我们可以通过 <code>getImageData</code> 或 <code>createImageData</code> 方法获取或创建这个帧缓冲区。</p>
<p>首先，在 HTML 文件中添加一个 Canvas 元素：</p>
<figure class="highlight html"><figcaption><span>index.HTML</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"gameboy-screen"</span> <span class="attr">width</span>=<span class="string">"160"</span> <span class="attr">height</span>=<span class="string">"144"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>在 <code>GameBoyGPU</code> 类中，我们将负责初始化这个 Canvas 并创建帧缓冲区。我们还设置了 <code>imageSmoothingEnabled = false</code> 和 <code>image-rendering: pixelated</code> 样式，以确保图像在放大时保持像素艺术的清晰度，而不是变得模糊。</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 其他常量定义，之后写 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GameBoy GPU 类</span></span><br><span class="line"><span class="comment"> * 负责管理显示时序、渲染管线和帧缓冲区</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameBoyGPU</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeTimingState</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeCanvas</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initializeFrameBuffer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'GameBoy GPU 已初始化'</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化 Canvas 画布</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initializeCanvas</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 尝试获取已存在的 canvas 元素</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'gameboy-screen'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不存在，创建新的 canvas 并添加到页面</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">canvas</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="variable language_">this</span>.<span class="title function_">createCanvas</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 2D 渲染上下文</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = <span class="variable language_">this</span>.<span class="property">canvas</span>.<span class="title function_">getContext</span>(<span class="string">'2d'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">context</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'无法获取 Canvas 2D 渲染上下文'</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁用图像平滑，保持像素艺术风格</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">imageSmoothingEnabled</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'Canvas 画布已初始化'</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建新的 Canvas 元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> {<span class="type">HTMLCanvasElement</span>} 创建的 canvas 元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">createCanvas</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">'canvas'</span>);</span><br><span class="line">    canvas.<span class="property">id</span> = <span class="string">'gameboy-screen'</span>;</span><br><span class="line">    canvas.<span class="property">width</span> = <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">WIDTH</span>;</span><br><span class="line">    canvas.<span class="property">height</span> = <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">HEIGHT</span>;</span><br><span class="line">    canvas.<span class="property">style</span>.<span class="property">border</span> = <span class="string">'2px solid #333'</span>;</span><br><span class="line">    canvas.<span class="property">style</span>.<span class="property">imageRendering</span> = <span class="string">'pixelated'</span>; <span class="comment">// 保持像素完美缩放</span></span><br><span class="line">    canvas.<span class="property">style</span>.<span class="property">imageRendering</span> = <span class="string">'-moz-crisp-edges'</span>; <span class="comment">// Firefox</span></span><br><span class="line">    canvas.<span class="property">style</span>.<span class="property">imageRendering</span> = <span class="string">'crisp-edges'</span>;      <span class="comment">// Chrome/Edge</span></span><br><span class="line">    canvas.<span class="property">style</span>.<span class="property">backgroundColor</span> = <span class="string">'#9BBC0F'</span>; <span class="comment">// GameBoy 绿色背景</span></span><br><span class="line">    <span class="comment">// 为了方便在 HTML 中演示，这里直接添加到 body</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(canvas);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'已创建新的 Canvas 元素'</span>);</span><br><span class="line">    <span class="keyword">return</span> canvas;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化帧缓冲区</span></span><br><span class="line"><span class="comment">   * 使用 ImageData 对象作为屏幕的内存表示</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initializeFrameBuffer</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 创建图像数据对象（帧缓冲区）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameBuffer</span> = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">createImageData</span>(</span><br><span class="line">      <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">WIDTH</span>,</span><br><span class="line">      <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">HEIGHT</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化为白色背景</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">clearFrameBuffer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'帧缓冲区已初始化'</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 清空帧缓冲区（设置为白色，或 GameBoy 默认背景色）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">clearFrameBuffer</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">const</span> data = <span class="variable language_">this</span>.<span class="property">frameBuffer</span>.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置所有像素为白色（255, 255, 255, 255）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">BUFFER_SIZE</span>; i += <span class="number">4</span>) {</span><br><span class="line">      data[i] = <span class="number">255</span>;      <span class="comment">// R</span></span><br><span class="line">      data[i + <span class="number">1</span>] = <span class="number">255</span>;  <span class="comment">// G</span></span><br><span class="line">      data[i + <span class="number">2</span>] = <span class="number">255</span>;  <span class="comment">// B</span></span><br><span class="line">      data[i + <span class="number">3</span>] = <span class="number">255</span>;  <span class="comment">// A (透明度)</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置像素颜色（辅助函数）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">x</span> - X 坐标（0-159）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">y</span> - Y 坐标（0-143）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">r</span> - 红色分量（0-255）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">g</span> - 绿色分量（0-255）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">b</span> - 蓝色分量（0-255）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">a</span> - 透明度（0-255），默认 255</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">setPixel</span>(<span class="params">x, y, r, g, b, a = <span class="number">255</span></span>) {</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span> || x &gt;= <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">WIDTH</span> || y &lt; <span class="number">0</span> || y &gt;= <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">HEIGHT</span>) {</span><br><span class="line">      <span class="keyword">return</span>; <span class="comment">// 越界检查</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> pixelIndex = (y * <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">WIDTH</span> + x) * <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="variable language_">this</span>.<span class="property">frameBuffer</span>.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    data[pixelIndex] = r;</span><br><span class="line">    data[pixelIndex + <span class="number">1</span>] = g;</span><br><span class="line">    data[pixelIndex + <span class="number">2</span>] = b;</span><br><span class="line">    data[pixelIndex + <span class="number">3</span>] = a;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>现在，我们有一个可以操作的帧缓冲区。通过修改 <code>this.frameBuffer.data</code> 数组中的 RGBA 值，我们可以改变屏幕上任何像素的颜色。修改完成后，调用 <code>this.context.putImageData(this.frameBuffer, 0, 0)</code> 就可以将更新后的帧缓冲区内容绘制到 Canvas 上。</p>
<h2 id="32-栅格图形与显示时序"><a class="markdownIt-Anchor" href="#32-栅格图形与显示时序"></a> 3.2. 栅格图形与显示时序</h2>
<blockquote>
<p>GPU 工作原理：</p>
<p>我们可以看一下老式电视是如何显示画面的：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">电子枪从左到右扫描 →→→→→→→→→→→（一行画完）</span><br><span class="line">然后跳到下一行    ↓</span><br><span class="line">再从左到右扫描   →→→→→→→→→→→（下一行）</span><br><span class="line">...重复 144次 ...</span><br><span class="line">最后回到顶部     ↑↑↑↑↑↑↑↑↑（准备下一帧）</span><br></pre></td></tr></tbody></table></figure>
<p>GameBoy 的 GPU 完全模仿了这个过程。</p>
<p>1989 年的硬件很慢，一次只能处理一行像素，这样做也能省电省内存。当年的程序员很聪明，用最少的资源做最多的事。</p>
</blockquote>
<p>GameBoy 的显示硬件模拟了阴极射线管（CRT）的工作方式。在 CRT 显示器中，电子束逐行扫描屏幕，并在扫描完成后返回到屏幕顶部。这个扫描过程不是瞬间完成的，它包含了消隐期：</p>
<ul>
<li>水平消隐：电子束从一行的末尾移动到下一行的开头所需的时间</li>
<li>垂直消隐：在一帧结束后，电子束从屏幕底部回到屏幕左上角所需的时间。垂直消隐期通常比水平消隐期长得多，因为它需要移动更远的距离</li>
</ul>
<p>GameBoy 的显示器也遵循类似的模式，并将其工作周期细分为四个不同的 GPU 模式。这对于精确模拟非常重要，因为某些硬件操作只能在特定的 GPU 模式下进行。</p>
<table>
<thead>
<tr>
<th>周期</th>
<th>GPU 模式号</th>
<th>时间消耗（<code>t</code> 时钟周期）</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>OAM 搜索</td>
<td>2</td>
<td>80</td>
<td>GPU 扫描 OAM 获取当前扫描线上的精灵信息。</td>
</tr>
<tr>
<td>像素传输</td>
<td>3</td>
<td>172</td>
<td>GPU 从 VRAM 读取图块和地图数据并渲染像素。</td>
</tr>
<tr>
<td>水平消隐</td>
<td>0</td>
<td>204</td>
<td>当前扫描线渲染完成后的等待期。</td>
</tr>
<tr>
<td>一条扫描线总时间</td>
<td></td>
<td>456</td>
<td>（80 + 172 + 204）</td>
</tr>
<tr>
<td>垂直消隐</td>
<td>1</td>
<td>4560（10 行）</td>
<td>所有可见扫描线渲染完成后的等待期。</td>
</tr>
<tr>
<td>一帧总时间</td>
<td></td>
<td>70224</td>
<td>（456 * 154 行）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>为什么是这些数字呢？</p>
<p>GPU 像是一个画家，每天画一行像素。</p>
<ol>
<li>准备阶段（80）：看看要画什么角色（OAM 搜索）</li>
<li>绘画阶段（172）：专心画这一行（像素传输）</li>
<li>休息阶段（204）：喝口水，准备下一行（水平消隐）</li>
<li>长休息（4560）：一张画完了，休息下（垂直消隐）</li>
</ol>
<p>因此我们的游戏不能随时访问 GPU。</p>
</blockquote>
<p>为了在模拟器中保持这些时序，我们需要一个 <code>step</code> 函数，它会在 CPU 每执行一条指令后被调用，并根据 CPU 消耗的时钟周期来推进 GPU 的内部时序状态。</p>
<p>我们定义 GPU 模式和时序常量：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GPU 模式常量定义</span></span><br><span class="line"><span class="comment"> * GameBoy GPU 有 4 种不同的工作模式，模拟 CRT 显示器的扫描过程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GPU_MODES</span> = {</span><br><span class="line">  <span class="attr">HBLANK</span>: <span class="number">0</span>,        <span class="comment">// 水平消隐期（扫描线结束后）</span></span><br><span class="line">  <span class="attr">VBLANK</span>: <span class="number">1</span>,        <span class="comment">// 垂直消隐期（帧结束后）</span></span><br><span class="line">  <span class="attr">OAM_SEARCH</span>: <span class="number">2</span>,    <span class="comment">// OAM 搜索期（精灵属性扫描）</span></span><br><span class="line">  <span class="attr">PIXEL_TRANSFER</span>: <span class="number">3</span> <span class="comment">// 像素传输期（VRAM 读取和渲染）</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GPU 时序常量（以 CPU 的 T 时钟周期为单位）</span></span><br><span class="line"><span class="comment"> * CPU 频率：4194304 Hz</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GPU_TIMINGS</span> = {</span><br><span class="line">  <span class="comment">// 扫描线时序</span></span><br><span class="line">  <span class="attr">OAM_SEARCH_CYCLES</span>: <span class="number">80</span>,      <span class="comment">// 模式 2：OAM 访问时间</span></span><br><span class="line">  <span class="attr">PIXEL_TRANSFER_CYCLES</span>: <span class="number">172</span>, <span class="comment">// 模式 3：VRAM 访问时间</span></span><br><span class="line">  <span class="attr">HBLANK_CYCLES</span>: <span class="number">204</span>,         <span class="comment">// 模式 0：水平消隐时间</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算得出的时序</span></span><br><span class="line">  <span class="attr">SCANLINE_CYCLES</span>: <span class="number">456</span>,       <span class="comment">// 一条扫描线总时间（80 + 172 + 204）</span></span><br><span class="line">  <span class="attr">VBLANK_LINE_CYCLES</span>: <span class="number">456</span>,    <span class="comment">// 垂直消隐期每线时间</span></span><br><span class="line">  <span class="attr">VBLANK_TOTAL_CYCLES</span>: <span class="number">4560</span>,  <span class="comment">// 垂直消隐总时间（456 * 10）</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 帧时序</span></span><br><span class="line">  <span class="attr">VISIBLE_LINES</span>: <span class="number">144</span>,         <span class="comment">// 可见扫描线数量</span></span><br><span class="line">  <span class="attr">VBLANK_LINES</span>: <span class="number">10</span>,           <span class="comment">// 垂直消隐扫描线数量</span></span><br><span class="line">  <span class="attr">TOTAL_LINES</span>: <span class="number">154</span>,           <span class="comment">// 总扫描线数量（144 + 10）</span></span><br><span class="line">  <span class="attr">FRAME_CYCLES</span>: <span class="number">70224</span>         <span class="comment">// 完整帧时间（456 * 154）</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 显示常量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DISPLAY_CONFIG</span> = {</span><br><span class="line">  <span class="attr">WIDTH</span>: <span class="number">160</span>,                 <span class="comment">// 屏幕宽度</span></span><br><span class="line">  <span class="attr">HEIGHT</span>: <span class="number">144</span>,                <span class="comment">// 屏幕高度</span></span><br><span class="line">  <span class="attr">BYTES_PER_PIXEL</span>: <span class="number">4</span>,         <span class="comment">// RGBA 格式，每像素 4 字节</span></span><br><span class="line">  <span class="attr">TOTAL_PIXELS</span>: <span class="number">160</span> * <span class="number">144</span>,    <span class="comment">// 总像素数</span></span><br><span class="line">  <span class="attr">BUFFER_SIZE</span>: <span class="number">160</span> * <span class="number">144</span> * <span class="number">4</span>  <span class="comment">// 帧缓冲区大小</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>接下来，我们在 <code>GameBoyGPU</code> 类中初始化时序状态，并实现 <code>step</code> 方法：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 之前写的其他方法 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化时序状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">initializeTimingState</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>; <span class="comment">// 初始 GPU 模式</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;                <span class="comment">// 当前模式的时钟计数器</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="number">0</span>;              <span class="comment">// 当前扫描线号（0-153）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">totalClock</span> = <span class="number">0</span>;               <span class="comment">// GPU 总时钟计数（累积）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">frameCount</span> = <span class="number">0</span>;               <span class="comment">// 帧计数器</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = performance.<span class="title function_">now</span>(); <span class="comment">// 上次帧渲染时间（用于计算 FPS）</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 重置 GPU 到初始状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">reset</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">initializeTimingState</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">clearFrameBuffer</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">updateDisplay</span>(); <span class="comment">// 更新 Canvas 以显示清空后的画面</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'GPU 已重置'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GPU 时序步进函数</span></span><br><span class="line"><span class="comment"> * 每次 CPU 执行指令后调用，根据 CPU 消耗的时钟周期推进 GPU 状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} cycles CPU 消耗的时钟周期数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">step</span>(<span class="params">cycles</span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">modeClock</span> += cycles; <span class="comment">// 累加当前模式下的时钟</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">totalClock</span> += cycles; <span class="comment">// 累加总时钟</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据当前模式处理时序逻辑</span></span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">mode</span>) {</span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleOAMSearchMode</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_MODES</span>.<span class="property">PIXEL_TRANSFER</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handlePixelTransferMode</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_MODES</span>.<span class="property">HBLANK</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleHBlankMode</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_MODES</span>.<span class="property">VBLANK</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleVBlankMode</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`未知的 GPU 模式：<span class="subst">${<span class="variable language_">this</span>.mode}</span>`</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>; <span class="comment">// 恢复到默认模式</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理 OAM 搜索模式（模式 2）</span></span><br><span class="line"><span class="comment"> * 当模式时钟达到 OAM_SEARCH_CYCLES 时，切换到像素传输模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">handleOAMSearchMode</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">modeClock</span> &gt;= <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">OAM_SEARCH_CYCLES</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">PIXEL_TRANSFER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 在这个阶段，会进行 OAM 搜索逻辑，在第 7 章（精灵）中实现</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">searchOAM</span>();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理像素传输模式（模式 3）</span></span><br><span class="line"><span class="comment"> * 当模式时钟达到 PIXEL_TRANSFER_CYCLES 时，切换到水平消隐模式，并渲染当前扫描线</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">handlePixelTransferMode</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">modeClock</span> &gt;= <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">PIXEL_TRANSFER_CYCLES</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">HBLANK</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染当前扫描线</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderScanline</span>();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理水平消隐模式（模式 0）</span></span><br><span class="line"><span class="comment"> * 当模式时钟达到 HBLANK_CYCLES 时，递增扫描线，并根据扫描线数量决定进入 VBLANK 或下一条扫描线</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">handleHBlankMode</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">modeClock</span> &gt;= <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">HBLANK_CYCLES</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentLine</span>++; <span class="comment">// 扫描线递增</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentLine</span> === <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VISIBLE_LINES</span>) {</span><br><span class="line">      <span class="comment">// 所有可见扫描线完成（0-143），进入垂直消隐模式</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">VBLANK</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onFrameComplete</span>(); <span class="comment">// 通知一帧渲染完成</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// 继续下一条扫描线，回到 OAM 搜索模式</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理垂直消隐模式（模式 1）</span></span><br><span class="line"><span class="comment"> * VBLANK 持续 10 条扫描线的时间。当模式时钟达到 VBLANK_LINE_CYCLES 时，递增扫描线，</span></span><br><span class="line"><span class="comment"> * 直到所有 VBLANK 扫描线完成，然后开始新的一帧。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">handleVBlankMode</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">modeClock</span> &gt;= <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VBLANK_LINE_CYCLES</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentLine</span>++; <span class="comment">// 扫描线递增</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentLine</span> &gt; <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">TOTAL_LINES</span> - <span class="number">1</span>) {</span><br><span class="line">      <span class="comment">// 垂直消隐结束（总共 154 条扫描线），开始新的一帧</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">onNewFrameStart</span>(); <span class="comment">// 通知新帧开始</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OAM 搜索逻辑（占位函数）</span></span><br><span class="line"><span class="comment"> * 在第 7 章（精灵）中会实现完整的精灵处理逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">searchOAM</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 实现精灵搜索逻辑</span></span><br><span class="line">  <span class="comment">// 1. 扫描 OAM 表中的 40 个精灵</span></span><br><span class="line">  <span class="comment">// 2. 找出在当前扫描线上的精灵（最多 10 个）</span></span><br><span class="line">  <span class="comment">// 3. 按 X 坐标排序准备渲染</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 渲染当前扫描线</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> 目前是一个简单的测试渲染，在第 4 章（图形）中会实现完整的背景和精灵渲染</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">renderScanline</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">renderTestPattern</span>(); <span class="comment">// 渲染一个测试图案</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 渲染测试图案（用于验证 GPU 时序）</span></span><br><span class="line"><span class="comment"> * 在 Canvas 上显示彩色条纹，以验证扫描线渲染是否正常工作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">renderTestPattern</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> data = <span class="variable language_">this</span>.<span class="property">frameBuffer</span>.<span class="property">data</span>;</span><br><span class="line">  <span class="keyword">const</span> y = <span class="variable language_">this</span>.<span class="property">currentLine</span>; <span class="comment">// 当前要渲染的扫描线</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为每条扫描线生成不同颜色的测试图案</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">WIDTH</span>; x++) {</span><br><span class="line">    <span class="keyword">const</span> pixelIndex = (y * <span class="variable constant_">DISPLAY_CONFIG</span>.<span class="property">WIDTH</span> + x) * <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建彩色测试图案，使之随帧动画</span></span><br><span class="line">    <span class="keyword">const</span> colorPhase = (x + y + <span class="variable language_">this</span>.<span class="property">frameCount</span>) % <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (colorPhase &lt; <span class="number">16</span>) {</span><br><span class="line">      <span class="comment">// 红色渐变</span></span><br><span class="line">      data[pixelIndex] = <span class="number">255</span>;</span><br><span class="line">      data[pixelIndex + <span class="number">1</span>] = colorPhase * <span class="number">16</span>;</span><br><span class="line">      data[pixelIndex + <span class="number">2</span>] = colorPhase * <span class="number">16</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (colorPhase &lt; <span class="number">32</span>) {</span><br><span class="line">      <span class="comment">// 绿色渐变</span></span><br><span class="line">      data[pixelIndex] = (<span class="number">32</span> - colorPhase) * <span class="number">16</span>;</span><br><span class="line">      data[pixelIndex + <span class="number">1</span>] = <span class="number">255</span>;</span><br><span class="line">      data[pixelIndex + <span class="number">2</span>] = (colorPhase - <span class="number">16</span>) * <span class="number">16</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (colorPhase &lt; <span class="number">48</span>) {</span><br><span class="line">      <span class="comment">// 蓝色渐变</span></span><br><span class="line">      data[pixelIndex] = (colorPhase - <span class="number">32</span>) * <span class="number">16</span>;</span><br><span class="line">      data[pixelIndex + <span class="number">1</span>] = (<span class="number">48</span> - colorPhase) * <span class="number">16</span>;</span><br><span class="line">      data[pixelIndex + <span class="number">2</span>] = <span class="number">255</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// 白色渐变</span></span><br><span class="line">      <span class="keyword">const</span> brightness = (<span class="number">64</span> - colorPhase) * <span class="number">16</span>;</span><br><span class="line">      data[pixelIndex] = brightness;</span><br><span class="line">      data[pixelIndex + <span class="number">1</span>] = brightness;</span><br><span class="line">      data[pixelIndex + <span class="number">2</span>] = brightness;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    data[pixelIndex + <span class="number">3</span>] = <span class="number">255</span>; <span class="comment">// Alpha（完全不透明）</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 帧渲染完成回调</span></span><br><span class="line"><span class="comment"> * 当一帧的所有可见扫描线渲染完成时调用。在这里我们将帧缓冲区显示到 Canvas。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">onFrameComplete</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 将帧缓冲区内容显示到 Canvas</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">updateDisplay</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新帧计数和性能统计</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">frameCount</span>++;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">updatePerformanceStats</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 触发垂直消隐中断（在第 8 章中断中实现）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">triggerVBlankInterrupt</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`帧 <span class="subst">${<span class="variable language_">this</span>.frameCount}</span> 渲染完成`</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新帧开始回调</span></span><br><span class="line"><span class="comment"> * 当垂直消隐期结束，准备开始新的一帧渲染时调用。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">onNewFrameStart</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 为新帧做准备，例如：</span></span><br><span class="line">  <span class="comment">// 1. 重置精灵计数器</span></span><br><span class="line">  <span class="comment">// 2. 更新背景/窗口滚动寄存器</span></span><br><span class="line">  <span class="comment">// 3. 处理显示控制寄存器变化</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将帧缓冲区内容更新到 Canvas</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">updateDisplay</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">putImageData</span>(<span class="variable language_">this</span>.<span class="property">frameBuffer</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新性能统计，例如 FPS</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">updatePerformanceStats</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>();</span><br><span class="line">  <span class="keyword">const</span> frameTime = currentTime - <span class="variable language_">this</span>.<span class="property">lastFrameTime</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = currentTime;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算 FPS</span></span><br><span class="line">  <span class="keyword">const</span> fps = <span class="number">1000</span> / frameTime;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每 60 帧输出一次性能信息，避免频繁日志输出</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">frameCount</span> % <span class="number">60</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`性能统计 - FPS: <span class="subst">${fps.toFixed(<span class="number">2</span>)}</span>, 帧时间: <span class="subst">${frameTime.toFixed(<span class="number">2</span>)}</span>ms`</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 触发垂直消隐中断（占位函数）</span></span><br><span class="line"><span class="comment"> * 在第 8 章（中断）中会实现完整的中断系统，通知 CPU 进行 VBLANK 相关操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">triggerVBlankInterrupt</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 实现 V-Blank 中断</span></span><br><span class="line">  <span class="comment">// 1. 设置中断标志位（例如在 MMU 中设置 IE/IF 寄存器）</span></span><br><span class="line">  <span class="comment">// 2. 如果中断使能，通知 CPU 暂停当前执行并跳转到中断处理程序</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取当前 GPU 状态信息（用于调试）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">Object</span>} GPU 状态对象，包含模式、时钟、扫描线等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getStatus</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> {</span><br><span class="line">    <span class="attr">mode</span>: <span class="variable language_">this</span>.<span class="property">mode</span>,</span><br><span class="line">    <span class="attr">modeName</span>: <span class="variable language_">this</span>.<span class="title function_">getModeName</span>(<span class="variable language_">this</span>.<span class="property">mode</span>),</span><br><span class="line">    <span class="attr">modeClock</span>: <span class="variable language_">this</span>.<span class="property">modeClock</span>,</span><br><span class="line">    <span class="attr">currentLine</span>: <span class="variable language_">this</span>.<span class="property">currentLine</span>,</span><br><span class="line">    <span class="attr">totalClock</span>: <span class="variable language_">this</span>.<span class="property">totalClock</span>,</span><br><span class="line">    <span class="attr">frameCount</span>: <span class="variable language_">this</span>.<span class="property">frameCount</span>,</span><br><span class="line">    <span class="attr">fps</span>: <span class="variable language_">this</span>.<span class="title function_">calculateFPS</span>()</span><br><span class="line">  };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取 GPU 模式名称的辅助函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">mode</span> - 模式号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">string</span>} 模式名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getModeName</span>(<span class="params">mode</span>) {</span><br><span class="line">  <span class="keyword">const</span> modeNames = {</span><br><span class="line">    [<span class="variable constant_">GPU_MODES</span>.<span class="property">HBLANK</span>]: <span class="string">'水平消隐'</span>,</span><br><span class="line">    [<span class="variable constant_">GPU_MODES</span>.<span class="property">VBLANK</span>]: <span class="string">'垂直消隐'</span>,</span><br><span class="line">    [<span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>]: <span class="string">'OAM 搜索'</span>,</span><br><span class="line">    [<span class="variable constant_">GPU_MODES</span>.<span class="property">PIXEL_TRANSFER</span>]: <span class="string">'像素传输'</span></span><br><span class="line">  };</span><br><span class="line">  <span class="keyword">return</span> modeNames[mode] || <span class="string">'未知模式'</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算当前 FPS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">number</span>} 当前 FPS 值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">calculateFPS</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> currentTime = performance.<span class="title function_">now</span>();</span><br><span class="line">  <span class="keyword">const</span> timeDiff = currentTime - <span class="variable language_">this</span>.<span class="property">lastFrameTime</span>;</span><br><span class="line">  <span class="keyword">return</span> timeDiff &gt; <span class="number">0</span> ? <span class="number">1000</span> / timeDiff : <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取调试信息字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">string</span>} 格式化的调试信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getDebugInfo</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> status = <span class="variable language_">this</span>.<span class="title function_">getStatus</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`GPU 状态：</span></span><br><span class="line"><span class="string">模式：<span class="subst">${status.modeName}</span>（<span class="subst">${status.mode}</span>）</span></span><br><span class="line"><span class="string">模式时钟：<span class="subst">${status.modeClock}</span></span></span><br><span class="line"><span class="string">当前扫描线：<span class="subst">${status.currentLine}</span></span></span><br><span class="line"><span class="string">总时钟：<span class="subst">${status.totalClock}</span></span></span><br><span class="line"><span class="string">帧计数：<span class="subst">${status.frameCount}</span></span></span><br><span class="line"><span class="string">FPS：<span class="subst">${status.fps.toFixed(<span class="number">2</span>)}</span>`</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="4-图形渲染绘制背景与瓦片"><a class="markdownIt-Anchor" href="#4-图形渲染绘制背景与瓦片"></a> 4. 图形渲染：绘制背景与瓦片</h1>
<p>与现代显卡动辄数 GB 的显存不同，早期游戏机（如 GameBoy）的内存极其有限，无法在内存中直接存储完整的屏幕像素（即帧缓冲区）。为了解决这个问题，工程师们采用了一种非常聪明的技术 —— 瓦片系统。</p>
<p>想象一下你在用瓷砖来铺地板。你不需要为每一块地面都设计一个独一无二的图案，而是可以使用一组预先设计好的瓷砖（瓦片），通过不同的排列组合来创造出丰富的地面样式。GameBoy 的图形渲染就是基于这个原理。我们只需要存储一份「模板」，然后在需要的地方「引用」它即可。这个「模板」就是瓦片。</p>
<ul>
<li>瓦片：一个 8x8 像素的基本图形单元。游戏中的所有背景和角色（精灵）都是由这些小小的瓦片拼接而成的</li>
<li>瓦片地图：一个 32x32 的二维数组，其中每个元素都是一个指向特定瓦片的索引。它就像一张设计图纸，规定了哪个位置应该使用哪个瓦片</li>
<li>视图：GameBoy 屏幕只有 160x144 像素，而整个背景地图却有 256x256 像素（32 个瓦片 × 8 像素 / 瓦片）。屏幕就像一个「摄像机」，我们只能通过这个 160x144 的窗口看到庞大背景地图的一部分</li>
</ul>
<blockquote>
<p>做过游戏开发的，尤其是做像素风格的应该对这个都很熟悉吧。</p>
<p>还是不太理解的，可以想一下拼图。</p>
<p>你要拼一幅大画，瓦片是你的拼图块（8x8 像素的小方块）、瓦片地图是拼图说明书、视图是拼图框。</p>
<p>游戏背景制作过程：</p>
<ol>
<li>美术画了很多 8x8 的小图块</li>
<li>策划说：「草地用 1 号块、石头用 2 号块……」</li>
<li>程序：「我按照说明书拼。」（GPU 渲染）</li>
<li>玩家在游戏中看到森林</li>
</ol>
<p>1989 年光是 1MB 内存就动不动要几千块钱，直接存储一张完整图片作为背景实在是过于奢侈。使用瓦片系统不仅可以节省内存，也可以节省空间。整个游戏卡带也才 32KB，必须得精打细算。</p>
</blockquote>
<p>VRAM（视频内存）中，瓦片数据和瓦片地图的布局如下：</p>
<table>
<thead>
<tr>
<th>地址区域</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x8000</code> - <code>0x8FFF</code></td>
<td>瓦片集 #1</td>
</tr>
<tr>
<td><code>0x9000</code> - <code>0x97FF</code></td>
<td>瓦片集 #2</td>
</tr>
<tr>
<td><code>0x9800</code> - <code>0x9BFF</code></td>
<td>瓦片地图 #0</td>
</tr>
<tr>
<td><code>0x9C00</code> - <code>0x9FFF</code></td>
<td>瓦片地图 #1</td>
</tr>
</tbody>
</table>
<p>有趣的是，瓦片集 #0 和 #1 有一部分是重叠的。游戏可以通过设置寄存器来选择使用哪个瓦片集和哪个瓦片地图，从而实现不同的显示效果。</p>
<h2 id="41-背景滚动与调色板"><a class="markdownIt-Anchor" href="#41-背景滚动与调色板"></a> 4.1. 背景滚动与调色板</h2>
<p>既然背景地图比屏幕大，我们自然就可以通过移动「摄像机」的位置来实现背景滚动的效果。这在平台跳跃或飞行射击游戏中非常常见。</p>
<p>GameBoy 提供了两个特殊的 GPU 寄存器来控制滚动：</p>
<ul>
<li><code>SCY</code>（Scroll Y，地址 <code>0xFF42</code>）：定义了屏幕顶边对应在 256x256 背景地图上的垂直坐标</li>
<li><code>SCX</code>（Scroll X，地址 <code>0xFF43</code>）：定义了屏幕左边对应在 256x256 背景地图上的水平坐标</li>
</ul>
<p>通过在每一帧之间改变 <code>SCX</code> 和 <code>SCY</code> 的值，游戏就能让背景平滑地滚动起来，创造出动态的世界。</p>
<p>或许大家都会以为 GameBoy 是纯黑白的，但实际上它可以显示四种深浅不同的「灰色」（或者说是绿色，取决于屏幕材质）。这四种颜色是通过调色板系统实现的。</p>
<p>一个瓦片中的每个像素用 2 个比特来表示，可以表示四种值（00, 01, 10, 11）。但这四个值具体对应哪种颜色，是由背景调色板寄存器（<code>BGP</code>，地址 <code>0xFF47</code>）决定的。</p>
<p><code>BGP</code> 是一个 8 位寄存器，每 2 位定义一个颜色的映射关系：</p>
<ul>
<li>位 1-0：映射像素值 <code>00</code></li>
<li>位 3-2：映射像素值 <code>01</code></li>
<li>位 5-4：映射像素值 <code>10</code></li>
<li>位 7-6：映射像素值 <code>11</code></li>
</ul>
<p>例如，如果 <code>BGP</code> 的值是 <code>0xE4</code>（二进制 <code>11100100</code>），那么映射关系就是：</p>
<ul>
<li><code>00</code> → <code>00</code>（颜色 0）</li>
<li><code>01</code> → <code>01</code>（颜色 1）</li>
<li><code>10</code> → <code>10</code>（颜色 2）</li>
<li><code>11</code> → <code>11</code>（颜色 3）</li>
</ul>
<p>这是最常见的默认调色板。但如果游戏将 <code>BGP</code> 的值改为 <code>0x1E</code>（二进制 <code>00011011</code>），映射就会变成：</p>
<ul>
<li><code>00</code> → <code>11</code>（颜色 3）</li>
<li><code>01</code> → <code>10</code>（颜色 2）</li>
<li><code>10</code> → <code>01</code>（颜色 1）</li>
<li><code>11</code> → <code>00</code>（颜色 0）</li>
</ul>
<p>这样整个屏幕的颜色就瞬间反转了，能够很高效地实现特殊视觉效果（比方说闪烁、水下效果）的方式。</p>
<p>在我们的模拟器中，我们将这四种颜色定义为经典的 GameBoy 绿色调：</p>
<figure class="highlight javascript"><figcaption><span>graphics.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">DEFAULT_PALETTE</span> = [</span><br><span class="line">  [<span class="number">155</span>, <span class="number">188</span>, <span class="number">15</span>, <span class="number">255</span>],   <span class="comment">// 颜色 0: 最亮 (白)</span></span><br><span class="line">  [<span class="number">139</span>, <span class="number">172</span>, <span class="number">15</span>, <span class="number">255</span>],   <span class="comment">// 颜色 1: 亮灰 (浅绿)</span></span><br><span class="line">  [<span class="number">48</span>, <span class="number">98</span>, <span class="number">48</span>, <span class="number">255</span>],     <span class="comment">// 颜色 2: 暗灰 (深绿)</span></span><br><span class="line">  [<span class="number">15</span>, <span class="number">56</span>, <span class="number">15</span>, <span class="number">255</span>]      <span class="comment">// 颜色 3: 最暗 (黑)</span></span><br><span class="line">];</span><br></pre></td></tr></tbody></table></figure>
<h2 id="42-瓦片数据结构与缓存管理"><a class="markdownIt-Anchor" href="#42-瓦片数据结构与缓存管理"></a> 4.2. 瓦片数据结构与缓存管理</h2>
<p>在 GameBoy 中，每个瓦片的像素数据以一种特殊的方式存储。每个像素需要 2 位来表示（因为有 4 种颜色），但这 2 位并不是连续存储的。相反，一个瓦片行的 8 个像素的低位全部存储在一个字节中，高位存储在下一个字节中。</p>
<p>例如，如果一个瓦片行的像素值是 <code>[3, 2, 1, 0, 0, 1, 2, 3]</code>，那么：</p>
<ul>
<li>低位字节：<code>11100001</code>（每个像素值的最低位）</li>
<li>高位字节：<code>11000011</code>（每个像素值的最高位）</li>
</ul>
<p>这种存储方式虽然看起来复杂，但符合 GameBoy 硬件的读取方式。</p>
<blockquote>
<p>这一部分不需要完全理解，只要知道「GameBoy 有自己的存储格式，我们需要转换一下」就够了。</p>
</blockquote>
<p>为了提高模拟器的性能，我们需要将这种原始格式转换为更易于处理的格式，并建立缓存机制：</p>
<figure class="highlight javascript"><figcaption><span>graphics.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 瓦片管理器类</span></span><br><span class="line"><span class="comment"> * 负责瓦片数据的存储、更新和缓存管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TileManager</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 扩展瓦片数据缓存 - 每个瓦片预计算为 8x8 的像素数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileCache</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TOTAL_TILES</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TOTAL_TILES</span>; i++) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tileCache</span>[i] = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_HEIGHT</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_HEIGHT</span>; y++) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tileCache</span>[i][y] = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_WIDTH</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标记哪些瓦片需要更新</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirtyTiles</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新单个瓦片的缓存数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">updateTileCache</span>(<span class="params">tileIndex</span>) {</span><br><span class="line">    <span class="comment">// 计算瓦片在 VRAM 中的起始地址</span></span><br><span class="line">    <span class="keyword">const</span> baseAddr = tileIndex * <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_SIZE_BYTES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 逐行处理瓦片数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_HEIGHT</span>; y++) {</span><br><span class="line">      <span class="keyword">const</span> rowAddr = baseAddr + (y * <span class="number">2</span>); <span class="comment">// 每行占 2 字节</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (rowAddr + <span class="number">1</span> &lt; <span class="variable language_">this</span>.<span class="property">vram</span>.<span class="property">length</span>) {</span><br><span class="line">        <span class="keyword">const</span> lowByte = <span class="variable language_">this</span>.<span class="property">vram</span>[rowAddr];     <span class="comment">// 像素低位</span></span><br><span class="line">        <span class="keyword">const</span> highByte = <span class="variable language_">this</span>.<span class="property">vram</span>[rowAddr + <span class="number">1</span>]; <span class="comment">// 像素高位</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从两个字节中提取 8 个像素</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_WIDTH</span>; x++) {</span><br><span class="line">          <span class="keyword">const</span> bitMask = <span class="number">1</span> &lt;&lt; (<span class="number">7</span> - x);</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">const</span> lowBit = (lowByte &amp; bitMask) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">const</span> highBit = (highByte &amp; bitMask) ? <span class="number">2</span> : <span class="number">0</span>;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 组合成 2 位颜色值</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">tileCache</span>[tileIndex][y][x] = lowBit + highBit;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个缓存系统的核心思想是「按需更新」—— 只有当 VRAM 中的瓦片数据发生变化时，我们才重新计算对应的缓存。这样可以避免每次渲染时都进行耗时的位操作。</p>
<h2 id="43-调色板系统实现"><a class="markdownIt-Anchor" href="#43-调色板系统实现"></a> 4.3. 调色板系统实现</h2>
<p>调色板管理器负责处理颜色映射。它不仅存储当前的调色板设置，还提供了动态更新调色板的能力：</p>
<figure class="highlight javascript"><figcaption><span>graphics.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调色板管理器类</span></span><br><span class="line"><span class="comment"> * 处理 GameBoy 的 4 色调色板系统</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PaletteManager</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 背景调色板（4 种颜色，每种颜色 RGBA 4 字节）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundPalette</span> = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">PALETTE_COLORS</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 原始调色板寄存器值（用于模拟硬件寄存器）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paletteRegister</span> = <span class="number">0xFC</span>; <span class="comment">// 默认值：11 10 01 00</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setDefaultPalette</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新调色板寄存器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">updatePaletteRegister</span>(<span class="params">value</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paletteRegister</span> = value &amp; <span class="number">0xFF</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从寄存器值提取 4 个 2 位颜色映射</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">PALETTE_COLORS</span>; i++) {</span><br><span class="line">      <span class="keyword">const</span> colorIndex = (<span class="variable language_">this</span>.<span class="property">paletteRegister</span> &gt;&gt; (i * <span class="number">2</span>)) &amp; <span class="number">0x03</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">backgroundPalette</span>[i] = [...<span class="variable constant_">DEFAULT_PALETTE</span>[colorIndex]];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取映射后的颜色</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getColor</span>(<span class="params">paletteIndex</span>) {</span><br><span class="line">    <span class="keyword">if</span> (paletteIndex &lt; <span class="number">0</span> || paletteIndex &gt;= <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">PALETTE_COLORS</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable constant_">DEFAULT_PALETTE</span>[<span class="number">0</span>];</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">backgroundPalette</span>[paletteIndex];</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>例如，当游戏写入调色板寄存器 <code>0xFF47</code> 时，<code>updatePaletteRegister</code> 方法会被调用，自动重新映射所有颜色。这意味着游戏可以通过一个简单的寄存器写入操作瞬间改变整个屏幕的色调。</p>
<h2 id="44-背景滚动控制"><a class="markdownIt-Anchor" href="#44-背景滚动控制"></a> 4.4. 背景滚动控制</h2>
<p>滚动控制器管理背景的偏移位置，这是实现动态背景效果的关键：</p>
<figure class="highlight javascript"><figcaption><span>graphics.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 滚动控制器类</span></span><br><span class="line"><span class="comment"> * 管理背景的滚动位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ScrollController</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollX</span> = <span class="number">0</span>; <span class="comment">// 水平滚动位置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollY</span> = <span class="number">0</span>; <span class="comment">// 垂直滚动位置</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置滚动位置</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">setScroll</span>(<span class="params">x, y</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollX</span> = x &amp; <span class="number">0xFF</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollY</span> = y &amp; <span class="number">0xFF</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取当前滚动位置</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getScrollPosition</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">      <span class="attr">x</span>: <span class="variable language_">this</span>.<span class="property">scrollX</span>,</span><br><span class="line">      <span class="attr">y</span>: <span class="variable language_">this</span>.<span class="property">scrollY</span></span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个简单的类封装了 GameBoy 的 <code>SCX</code> 和 <code>SCY</code> 寄存器的功能。当游戏修改这些寄存器时，滚动位置会立即更新，下一帧的渲染就会反映出新的滚动位置。</p>
<h2 id="45-扫描线级背景渲染"><a class="markdownIt-Anchor" href="#45-扫描线级背景渲染"></a> 4.5. 扫描线级背景渲染</h2>
<p>背景渲染器是整个图形系统的核心，它负责将瓦片地图转换为实际的像素数据。渲染是按扫描线进行的，这模拟了 GameBoy 的真实渲染方式：</p>
<figure class="highlight javascript"><figcaption><span>graphics.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 背景渲染器类</span></span><br><span class="line"><span class="comment"> * 负责将瓦片地图渲染到帧缓冲区</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BackgroundRenderer</span> {</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 渲染单条扫描线的背景</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">renderBackgroundScanline</span>(<span class="params">lineNumber, frameBuffer</span>) {</span><br><span class="line">    <span class="comment">// 获取滚动位置</span></span><br><span class="line">    <span class="keyword">const</span> scroll = <span class="variable language_">this</span>.<span class="property">scrollController</span>.<span class="title function_">getScrollPosition</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算当前扫描线在瓦片地图中的 Y 位置</span></span><br><span class="line">    <span class="keyword">const</span> mapY = (lineNumber + scroll.<span class="property">y</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">    <span class="keyword">const</span> tileY = <span class="title class_">Math</span>.<span class="title function_">floor</span>(mapY / <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_HEIGHT</span>);</span><br><span class="line">    <span class="keyword">const</span> pixelY = mapY % <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_HEIGHT</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算瓦片地图行的起始偏移</span></span><br><span class="line">    <span class="keyword">const</span> mapBaseAddr = <span class="variable language_">this</span>.<span class="property">backgroundMapSelect</span> ? </span><br><span class="line">      <span class="variable constant_">VRAM_LAYOUT</span>.<span class="property">TILEMAP_1_START</span> : <span class="variable constant_">VRAM_LAYOUT</span>.<span class="property">TILEMAP_0_START</span>;</span><br><span class="line">    <span class="keyword">const</span> mapOffset = mapBaseAddr - <span class="variable constant_">VRAM_LAYOUT</span>.<span class="property">TILESET_1_START</span>;</span><br><span class="line">    <span class="keyword">const</span> mapLineOffset = mapOffset + (tileY * <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">MAP_WIDTH_TILES</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算起始瓦片的 X 位置</span></span><br><span class="line">    <span class="keyword">let</span> mapX = scroll.<span class="property">x</span>;</span><br><span class="line">    <span class="keyword">let</span> tileX = <span class="title class_">Math</span>.<span class="title function_">floor</span>(mapX / <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_WIDTH</span>);</span><br><span class="line">    <span class="keyword">let</span> pixelX = mapX % <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_WIDTH</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算帧缓冲区的起始位置</span></span><br><span class="line">    <span class="keyword">let</span> canvasOffset = lineNumber * <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">SCREEN_WIDTH</span> * <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取第一个瓦片</span></span><br><span class="line">    <span class="keyword">let</span> tileIndex = <span class="variable language_">this</span>.<span class="title function_">getTileIndex</span>(mapLineOffset + tileX);</span><br><span class="line">    <span class="keyword">let</span> tileData = <span class="variable language_">this</span>.<span class="property">tileManager</span>.<span class="title function_">getTileData</span>(tileIndex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 渲染整条扫描线（160 像素）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> screenX = <span class="number">0</span>; screenX &lt; <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">SCREEN_WIDTH</span>; screenX++) {</span><br><span class="line">      <span class="comment">// 获取当前像素的调色板索引</span></span><br><span class="line">      <span class="keyword">const</span> paletteIndex = tileData ? tileData[pixelY][pixelX] : <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 通过调色板获取最终颜色</span></span><br><span class="line">      <span class="keyword">const</span> color = <span class="variable language_">this</span>.<span class="property">paletteManager</span>.<span class="title function_">getColor</span>(paletteIndex);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 写入帧缓冲区</span></span><br><span class="line">      frameBuffer.<span class="property">data</span>[canvasOffset] = color[<span class="number">0</span>];     <span class="comment">// R</span></span><br><span class="line">      frameBuffer.<span class="property">data</span>[canvasOffset + <span class="number">1</span>] = color[<span class="number">1</span>]; <span class="comment">// G</span></span><br><span class="line">      frameBuffer.<span class="property">data</span>[canvasOffset + <span class="number">2</span>] = color[<span class="number">2</span>]; <span class="comment">// B</span></span><br><span class="line">      frameBuffer.<span class="property">data</span>[canvasOffset + <span class="number">3</span>] = color[<span class="number">3</span>]; <span class="comment">// A</span></span><br><span class="line">      canvasOffset += <span class="number">4</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 移动到下一个像素</span></span><br><span class="line">      pixelX++;</span><br><span class="line">      <span class="keyword">if</span> (pixelX &gt;= <span class="variable constant_">GRAPHICS_CONSTANTS</span>.<span class="property">TILE_WIDTH</span>) {</span><br><span class="line">        <span class="comment">// 移动到下一个瓦片</span></span><br><span class="line">        pixelX = <span class="number">0</span>;</span><br><span class="line">        tileX = (tileX + <span class="number">1</span>) &amp; <span class="number">31</span>; <span class="comment">// 瓦片地图是 32x32，循环</span></span><br><span class="line">        tileIndex = <span class="variable language_">this</span>.<span class="title function_">getTileIndex</span>(mapLineOffset + tileX);</span><br><span class="line">        tileData = <span class="variable language_">this</span>.<span class="property">tileManager</span>.<span class="title function_">getTileData</span>(tileIndex);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个渲染过程的关键在于理解坐标转换：</p>
<ol>
<li>从屏幕坐标转换为背景地图坐标（考虑滚动偏移）</li>
<li>从背景地图坐标转换为瓦片坐标和瓦片内像素坐标</li>
<li>从瓦片地图读取瓦片索引</li>
<li>从瓦片缓存读取像素的调色板索引</li>
<li>通过调色板获取最终的 RGBA 颜色值</li>
</ol>
<h2 id="46-图形系统集成"><a class="markdownIt-Anchor" href="#46-图形系统集成"></a> 4.6. 图形系统集成</h2>
<p>最后，图形系统主类将所有组件协调起来工作：</p>
<figure class="highlight javascript"><figcaption><span>graphics.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图形系统主类</span></span><br><span class="line"><span class="comment"> * 协调所有图形组件的工作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameBoyGraphicsSystem</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 创建各个组件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileManager</span> = <span class="keyword">new</span> <span class="title class_">TileManager</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paletteManager</span> = <span class="keyword">new</span> <span class="title class_">PaletteManager</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scrollController</span> = <span class="keyword">new</span> <span class="title class_">ScrollController</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundRenderer</span> = <span class="keyword">new</span> <span class="title class_">BackgroundRenderer</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">tileManager</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">paletteManager</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scrollController</span></span><br><span class="line">    );</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 连接到 MMU 的 VRAM</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">connectVRAM</span>(<span class="params">vramData</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tileManager</span>.<span class="title function_">setVRAM</span>(vramData);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundRenderer</span>.<span class="title function_">setVRAM</span>(vramData);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理图形寄存器写入</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">writeGraphicsRegister</span>(<span class="params">register, value</span>) {</span><br><span class="line">    <span class="keyword">switch</span> (register) {</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xFF42</span>: <span class="comment">// SCY - 垂直滚动</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scrollController</span>.<span class="title function_">setScrollY</span>(value);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xFF43</span>: <span class="comment">// SCX - 水平滚动</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scrollController</span>.<span class="title function_">setScrollX</span>(value);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xFF47</span>: <span class="comment">// BGP - 背景调色板</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">paletteManager</span>.<span class="title function_">updatePaletteRegister</span>(value);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 渲染单条扫描线</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">renderScanline</span>(<span class="params">lineNumber, frameBuffer</span>) {</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">enabled</span> || !<span class="variable language_">this</span>.<span class="property">backgroundEnabled</span>) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">backgroundRenderer</span>.<span class="title function_">renderBackgroundScanline</span>(lineNumber, frameBuffer);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个集成系统的设计遵循了模块化原则 —— 每个组件都有清晰的职责，通过明确的接口进行通信。当 GPU 需要渲染一条扫描线时，它只需调用 <code>renderScanline</code> 方法，图形系统会自动协调所有子组件完成复杂的渲染过程。</p>
<h2 id="47-图形系统集成与性能优化"><a class="markdownIt-Anchor" href="#47-图形系统集成与性能优化"></a> 4.7. 图形系统集成与性能优化</h2>
<p>在完成了瓦片管理、调色板和背景渲染等核心组件后，我们需要将图形系统与现有的 GPU 时序系统集成起来，并进行性能优化以确保流畅的渲染效果（当时测试的时候 FPS 发现连 1 都不到……）。</p>
<p>首先，我们需要在 GPU 类中添加图形系统的初始化和管理逻辑：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化图形系统</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">initializeGraphicsSystem</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 图形系统实例（如果可用）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">graphicsSystem</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">renderMode</span> = <span class="string">'test'</span>; <span class="comment">// 'test' 或 'graphics'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 尝试初始化图形系统</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">GameBoyGraphicsSystem</span> !== <span class="string">'undefined'</span>) {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphicsSystem</span> = <span class="keyword">new</span> <span class="title class_">GameBoyGraphicsSystem</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">renderMode</span> = <span class="string">'graphics'</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'图形系统已集成到 GPU'</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'图形系统初始化失败，使用测试模式:'</span>, error);</span><br><span class="line">    }</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'图形系统未加载，使用测试渲染模式'</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>接下来，我们需要建立 GPU 与图形系统之间的数据连接：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接到 MMU 的 VRAM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">connectVRAM</span>(<span class="params">vramData</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="title function_">connectVRAM</span>(vramData);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'GPU 已连接到 VRAM'</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理 VRAM 写入事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">onVRAMWrite</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="title function_">onVRAMWrite</span>(address, value);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理图形寄存器写入</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeRegister</span>(<span class="params">register, value</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="title function_">writeGraphicsRegister</span>(register, value);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>为了提供更好的调试体验和性能，我们要实现渲染模式切换：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 渲染真实的 GameBoy 背景图形</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">renderGameBoyGraphics</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">GameBoyGraphicsSystem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="title function_">renderScanline</span>(<span class="variable language_">this</span>.<span class="property">currentLine</span>, <span class="variable language_">this</span>.<span class="property">frameBuffer</span>);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="comment">// 否则使用测试图案</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderTestPattern</span>();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 切换渲染模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">setRenderMode</span>(<span class="params">mode</span>) {</span><br><span class="line">  <span class="keyword">if</span> (mode === <span class="string">'graphics'</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">'图形系统未初始化，无法切换到图形模式'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">renderMode</span> = mode;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`渲染模式已切换到：<span class="subst">${mode}</span>`</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 渲染当前扫描线</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">renderScanline</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 根据渲染模式选择渲染方式</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">renderMode</span> === <span class="string">'graphics'</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderGameBoyGraphics</span>();</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderTestPattern</span>();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>最重要的性能优化是引入了简化的帧级别渲染，避免了复杂的周期级别计算：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简化的帧级别步进</span></span><br><span class="line"><span class="comment"> * 每次调用渲染一整帧，避免复杂的周期计算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">stepFrame</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 1. 渲染所有可见扫描线 (0-143)</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> line = <span class="number">0</span>; line &lt; <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VISIBLE_LINES</span>; line++) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentLine</span> = line;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">PIXEL_TRANSFER</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderScanline</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 模拟垂直消隐期间 (144-153)</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">VBLANK</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VISIBLE_LINES</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 完成帧渲染</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">onFrameComplete</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. 重置到下一帧开始</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="5-系统集成构建完整的模拟器架构"><a class="markdownIt-Anchor" href="#5-系统集成构建完整的模拟器架构"></a> 5. 系统集成：构建完整的模拟器架构</h1>
<p>在前面的章节中，我们分别实现了 CPU 指令处理、MMU 内存管理、GPU 时序控制和图形渲染系统。虽然这些组件各自功能完善，但它们就跟分散的乐器差不多，需要一个指挥家来协调，不然是无法演奏出和谐的交响乐的。这一章的核心任务就是建立这样一个统一的系统架构，让所有硬件组件无缝协作。</p>
<h2 id="51-硬件抽象层与组件连接"><a class="markdownIt-Anchor" href="#51-硬件抽象层与组件连接"></a> 5.1. 硬件抽象层与组件连接</h2>
<p>在真实的 GameBoy 中，各个硬件组件通过物理总线连接。在我们的模拟器中，我们需要建立一个软件层面的「总线系统「，让组件间能够进行通信。MMU 作为内存管理的中心，天然地成为了这个连接中心。</p>
<p>我们为 MMU 添加硬件组件连接能力：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化硬件组件引用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">initializeHardwareReferences</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 硬件组件引用，由外部注入</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">gpu</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">inputController</span> = <span class="literal">null</span>;      <span class="comment">// 第6章添加</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">timer</span> = <span class="literal">null</span>;                <span class="comment">// 第10章添加</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interruptController</span> = <span class="literal">null</span>;  <span class="comment">// 第8章添加</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'📡 MMU 硬件接口已初始化'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接硬件组件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} componentType 组件类型（'gpu', 'input', 'timer', 'interrupt'）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">Object</span>} component 硬件组件实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">connectHardware</span>(<span class="params">componentType, component</span>) {</span><br><span class="line">  <span class="keyword">switch</span> (componentType) {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'gpu'</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">gpu</span> = component;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ GPU 已连接到 MMU'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'input'</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">inputController</span> = component;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ 输入控制器已连接到 MMU'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// ... 其他组件</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这种设计的优势在于 <strong>松耦合</strong>：每个组件都不需要知道其他组件的具体实现，只需要通过 MMU 这个「中介」进行通信。当我们要添加新的硬件组件时，只需要在 MMU 中注册即可。</p>
<h2 id="52-io-寄存器路由系统"><a class="markdownIt-Anchor" href="#52-io-寄存器路由系统"></a> 5.2. I / O 寄存器路由系统</h2>
<p>GameBoy 的硬件组件通过内存映射的 I / O 寄存器进行控制。这些寄存器位于 <code>0xFF00-0xFF7F</code> 地址范围内，不同的地址控制不同的硬件功能。我们需要建立一个路由系统，将对这些地址的读写操作转发给相应的硬件组件。</p>
<p>首先，定义一个完整的寄存器地址映射：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * I/O 寄存器映射常量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">IO_REGISTERS</span> = {</span><br><span class="line">  <span class="comment">// GPU 寄存器范围（0xFF40-0xFF7F）</span></span><br><span class="line">  <span class="attr">GPU_START</span>: <span class="number">0xFF40</span>,</span><br><span class="line">  <span class="attr">GPU_END</span>: <span class="number">0xFF7F</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 具体的 GPU 寄存器</span></span><br><span class="line">  <span class="attr">LCDC</span>: <span class="number">0xFF40</span>,    <span class="comment">// LCD 控制寄存器</span></span><br><span class="line">  <span class="attr">STAT</span>: <span class="number">0xFF41</span>,    <span class="comment">// LCD 状态寄存器</span></span><br><span class="line">  <span class="attr">SCY</span>: <span class="number">0xFF42</span>,     <span class="comment">// 垂直滚动</span></span><br><span class="line">  <span class="attr">SCX</span>: <span class="number">0xFF43</span>,     <span class="comment">// 水平滚动</span></span><br><span class="line">  <span class="attr">LY</span>: <span class="number">0xFF44</span>,      <span class="comment">// 当前扫描线（只读）</span></span><br><span class="line">  <span class="attr">BGP</span>: <span class="number">0xFF47</span>,     <span class="comment">// 背景调色板</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其他硬件寄存器</span></span><br><span class="line">  <span class="attr">JOYPAD</span>: <span class="number">0xFF00</span>,  <span class="comment">// 按键输入（第6章实现）</span></span><br><span class="line">  <span class="attr">IF</span>: <span class="number">0xFF0F</span>,      <span class="comment">// 中断标志</span></span><br><span class="line">  <span class="attr">IE</span>: <span class="number">0xFFFF</span>       <span class="comment">// 中断使能</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>MMU 中的寄存器读写方法会根据地址范围自动将请求路由到对应的硬件组件：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接硬件组件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">string</span>} <span class="variable">componentType</span> - 组件类型 ('gpu', 'input', 'timer', 'interrupt')</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">Object</span>} <span class="variable">component</span> - 硬件组件实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">connectHardware</span>(<span class="params">componentType, component</span>) {</span><br><span class="line">  <span class="keyword">switch</span> (componentType) {</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'gpu'</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">gpu</span> = component;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ GPU 已连接到 MMU'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'input'</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">inputController</span> = component;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ 输入控制器已连接到 MMU'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'timer'</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">timer</span> = component;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ 定时器已连接到 MMU'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'interrupt'</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">interruptController</span> = component;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ 中断控制器已连接到 MMU'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ 未知的硬件组件类型: <span class="subst">${componentType}</span>`</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>不同的寄存器地址控制不同的硬件功能，MMU 需要将读写操作正确路由到对应的硬件组件：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取I/O寄存器 - 支持硬件组件路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">readIORegister</span>(<span class="params">address</span>) {</span><br><span class="line">  <span class="comment">// 🎨 GPU 寄存器范围 (0xFF40-0xFF7F)</span></span><br><span class="line">  <span class="keyword">if</span> (address &gt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">GPU_START</span> &amp;&amp; address &lt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">GPU_END</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gpu</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="property">readRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="title function_">readRegister</span>(address);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ GPU 未连接，无法读取寄存器 0x<span class="subst">${address.toString(<span class="number">16</span>)}</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFF</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 以下都会在未来的章节中实现</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🎮 按键输入寄存器 (0xFF00)</span></span><br><span class="line">  <span class="keyword">if</span> (address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">JOYPAD</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">inputController</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">inputController</span>.<span class="property">readJoypadRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">inputController</span>.<span class="title function_">readJoypadRegister</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFF</span>; <span class="comment">// 默认：所有按键未按下</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ⏰ 定时器寄存器 (0xFF04-0xFF07)</span></span><br><span class="line">  <span class="keyword">if</span> (address &gt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">TIMER_DIV</span> &amp;&amp; address &lt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">TIMER_TAC</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">timer</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">timer</span>.<span class="property">readRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">timer</span>.<span class="title function_">readRegister</span>(address);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x00</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔔 中断寄存器 (0xFF0F, 0xFFFF)</span></span><br><span class="line">  <span class="keyword">if</span> (address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">IF</span> || address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">IE</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">interruptController</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">interruptController</span>.<span class="property">readRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">interruptController</span>.<span class="title function_">readRegister</span>(address);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x00</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认处理</span></span><br><span class="line">  <span class="keyword">const</span> registerIndex = address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[registerIndex] || <span class="number">0xFF</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>对应的写入路由逻辑确保了每个硬件组件都能及时收到控制指令：</p>
<figure class="highlight javascript"><figcaption><span>mmu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入I/O寄存器 - 支持硬件组件路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">address</span> - I/O寄存器地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">value</span> - 要写入的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeIORegister</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="comment">// 🎨 GPU 寄存器范围 (0xFF40-0xFF7F)</span></span><br><span class="line">  <span class="keyword">if</span> (address &gt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">GPU_START</span> &amp;&amp; address &lt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">GPU_END</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gpu</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="property">writeRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="title function_">writeRegister</span>(address, value);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ GPU 未连接，无法写入寄存器 0x<span class="subst">${address.toString(<span class="number">16</span>)}</span>`</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 同时保存到本地数组（用于后备）</span></span><br><span class="line">    <span class="keyword">const</span> registerIndex = address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>;</span><br><span class="line">    <span class="keyword">if</span> (registerIndex &gt;= <span class="number">0</span> &amp;&amp; registerIndex &lt; <span class="variable language_">this</span>.<span class="property">ioRegisters</span>.<span class="property">length</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[registerIndex] = value;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🎮 按键输入寄存器 (0xFF00) - 第6章实现</span></span><br><span class="line">  <span class="keyword">if</span> (address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">JOYPAD</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">inputController</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">inputController</span>.<span class="property">writeJoypadRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">inputController</span>.<span class="title function_">writeJoypadRegister</span>(value);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 保存到本地数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>] = value;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ⏰ 定时器寄存器 (0xFF04-0xFF07) - 第10章实现</span></span><br><span class="line">  <span class="keyword">if</span> (address &gt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">TIMER_DIV</span> &amp;&amp; address &lt;= <span class="variable constant_">IO_REGISTERS</span>.<span class="property">TIMER_TAC</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">timer</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">timer</span>.<span class="property">writeRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">timer</span>.<span class="title function_">writeRegister</span>(address, value);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>] = value;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 🔔 中断寄存器 (0xFF0F, 0xFFFF) - 第8章实现</span></span><br><span class="line">  <span class="keyword">if</span> (address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">IF</span> || address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">IE</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">interruptController</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">interruptController</span>.<span class="property">writeRegister</span> === <span class="string">'function'</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">interruptController</span>.<span class="title function_">writeRegister</span>(address, value);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 特殊处理：IE 寄存器在零页RAM中</span></span><br><span class="line">    <span class="keyword">if</span> (address === <span class="variable constant_">IO_REGISTERS</span>.<span class="property">IE</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">zram</span>[<span class="number">0x7F</span>] = value; <span class="comment">// 0xFFFF -&gt; ZRAM[0x7F]</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>] = value;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认处理：保存到本地寄存器数组</span></span><br><span class="line">  <span class="keyword">const</span> registerIndex = address - <span class="variable constant_">MEMORY_REGIONS</span>.<span class="property">IO_START</span>;</span><br><span class="line">  <span class="keyword">if</span> (registerIndex &gt;= <span class="number">0</span> &amp;&amp; registerIndex &lt; <span class="variable language_">this</span>.<span class="property">ioRegisters</span>.<span class="property">length</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ioRegisters</span>[registerIndex] = value;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ 无效的I/O寄存器写入: 0x<span class="subst">${address.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这样，当游戏代码写入 <code>0xFF40</code>（LCD 控制寄存器）时，MMU 会自动将这个写入操作转发给 GPU，GPU 就能实时更新其内部状态。</p>
<p>GPU 是 I / O 寄存器最密集的硬件组件，拥有十多个不同功能的寄存器。这些寄存器不仅控制显示行为，还影响中断、DMA 传输等关键功能。</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GPU 寄存器常量定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GPU_REGISTERS</span> = {</span><br><span class="line">  <span class="comment">// LCD 控制和状态</span></span><br><span class="line">  <span class="attr">LCDC</span>: <span class="number">0xFF40</span>,    <span class="comment">// LCD 控制寄存器</span></span><br><span class="line">  <span class="attr">STAT</span>: <span class="number">0xFF41</span>,    <span class="comment">// LCD 状态寄存器</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 滚动位置</span></span><br><span class="line">  <span class="attr">SCY</span>: <span class="number">0xFF42</span>,     <span class="comment">// 垂直滚动</span></span><br><span class="line">  <span class="attr">SCX</span>: <span class="number">0xFF43</span>,     <span class="comment">// 水平滚动</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 扫描线相关</span></span><br><span class="line">  <span class="attr">LY</span>: <span class="number">0xFF44</span>,      <span class="comment">// 当前扫描线（只读）</span></span><br><span class="line">  <span class="attr">LYC</span>: <span class="number">0xFF45</span>,     <span class="comment">// 扫描线比较值</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// DMA 传输</span></span><br><span class="line">  <span class="attr">DMA</span>: <span class="number">0xFF46</span>,     <span class="comment">// DMA 传输寄存器</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调色板</span></span><br><span class="line">  <span class="attr">BGP</span>: <span class="number">0xFF47</span>,     <span class="comment">// 背景调色板</span></span><br><span class="line">  <span class="title class_">OBP0</span>: <span class="number">0xFF48</span>,    <span class="comment">// 精灵调色板 0</span></span><br><span class="line">  <span class="title class_">OBP1</span>: <span class="number">0xFF49</span>,    <span class="comment">// 精灵调色板 1</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 窗口位置</span></span><br><span class="line">  <span class="attr">WY</span>: <span class="number">0xFF4A</span>,      <span class="comment">// 窗口 Y 位置</span></span><br><span class="line">  <span class="attr">WX</span>: <span class="number">0xFF4B</span>       <span class="comment">// 窗口 X 位置</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LCD 控制寄存器标志位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LCDC_FLAGS</span> = {</span><br><span class="line">  <span class="attr">LCD_ENABLE</span>: <span class="number">0x80</span>,        <span class="comment">// 位 7：LCD 开关</span></span><br><span class="line">  <span class="attr">WINDOW_TILEMAP</span>: <span class="number">0x40</span>,    <span class="comment">// 位 6：窗口瓦片地图选择</span></span><br><span class="line">  <span class="attr">WINDOW_ENABLE</span>: <span class="number">0x20</span>,     <span class="comment">// 位 5：窗口开关</span></span><br><span class="line">  <span class="attr">BG_TILESET</span>: <span class="number">0x10</span>,        <span class="comment">// 位 4：背景瓦片数据选择</span></span><br><span class="line">  <span class="attr">BG_TILEMAP</span>: <span class="number">0x08</span>,        <span class="comment">// 位 3：背景瓦片地图选择</span></span><br><span class="line">  <span class="attr">SPRITE_SIZE</span>: <span class="number">0x04</span>,       <span class="comment">// 位 2：精灵大小（0=8x8, 1=8x16）</span></span><br><span class="line">  <span class="attr">SPRITE_ENABLE</span>: <span class="number">0x02</span>,     <span class="comment">// 位 1：精灵开关</span></span><br><span class="line">  <span class="attr">BG_ENABLE</span>: <span class="number">0x01</span>          <span class="comment">// 位 0：背景开关</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>GPU 内部维护所有寄存器的当前状态：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化寄存器状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">initializeRegisters</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// GPU 寄存器状态</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span> = {</span><br><span class="line">    <span class="comment">// LCD 控制寄存器 (0xFF40)</span></span><br><span class="line">    <span class="attr">lcdc</span>: <span class="number">0x00</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LCD 状态寄存器 (0xFF41)</span></span><br><span class="line">    <span class="attr">stat</span>: <span class="number">0x00</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滚动寄存器</span></span><br><span class="line">    <span class="attr">scy</span>: <span class="number">0x00</span>,   <span class="comment">// 垂直滚动 (0xFF42)</span></span><br><span class="line">    <span class="attr">scx</span>: <span class="number">0x00</span>,   <span class="comment">// 水平滚动 (0xFF43)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描线寄存器</span></span><br><span class="line">    <span class="attr">ly</span>: <span class="number">0x00</span>,    <span class="comment">// 当前扫描线 (0xFF44) - 只读</span></span><br><span class="line">    <span class="attr">lyc</span>: <span class="number">0x00</span>,   <span class="comment">// 扫描线比较值 (0xFF45)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调色板寄存器</span></span><br><span class="line">    <span class="attr">bgp</span>: <span class="number">0xFC</span>,   <span class="comment">// 背景调色板 (0xFF47) - 默认值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 窗口位置寄存器</span></span><br><span class="line">    <span class="attr">wy</span>: <span class="number">0x00</span>,    <span class="comment">// 窗口 Y 位置 (0xFF4A)</span></span><br><span class="line">    <span class="attr">wx</span>: <span class="number">0x00</span>     <span class="comment">// 窗口 X 位置 (0xFF4B)</span></span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析控制标志位到独立变量（向后兼容）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">updateControlFlags</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>LCD 控制寄存器（LCDC）是一个特殊的寄存器，它的每一位都控制不同的显示功能：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从寄存器值更新控制标志位</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">updateControlFlags</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> lcdc = <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">lcdc</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// LCD 控制标志</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_lcdEnabled</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">LCD_ENABLE</span>) !== <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_windowEnabled</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">WINDOW_ENABLE</span>) !== <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_spritesEnabled</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">SPRITE_ENABLE</span>) !== <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_backgroundEnabled</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">BG_ENABLE</span>) !== <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 瓦片和地图选择</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_backgroundTileSet</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">BG_TILESET</span>) !== <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_backgroundTileMap</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">BG_TILEMAP</span>) !== <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_windowTileMap</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">WINDOW_TILEMAP</span>) !== <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_spriteSize</span> = (lcdc &amp; <span class="variable constant_">LCDC_FLAGS</span>.<span class="property">SPRITE_SIZE</span>) !== <span class="number">0</span> ? <span class="number">16</span> : <span class="number">8</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>GPU 提供完整的寄存器读写接口：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取 GPU 寄存器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">address</span> - 寄存器地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">number</span>} 寄存器值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">readRegister</span>(<span class="params">address</span>) {</span><br><span class="line">  <span class="keyword">switch</span> (address) {</span><br><span class="line">    <span class="comment">// LCD 控制寄存器 (0xFF40)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">LCDC</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">lcdc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LCD 状态寄存器 (0xFF41)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">STAT</span>:</span><br><span class="line">      <span class="comment">// 组合状态标志位和当前模式</span></span><br><span class="line">      <span class="keyword">let</span> stat = <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">stat</span> &amp; <span class="number">0xF8</span>; <span class="comment">// 保留高 5 位</span></span><br><span class="line">      stat |= (<span class="variable language_">this</span>.<span class="property">mode</span> &amp; <span class="number">0x03</span>); <span class="comment">// 添加当前模式</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 检查 LYC=LY 标志</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">ly</span> === <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">lyc</span>) {</span><br><span class="line">        stat |= <span class="variable constant_">STAT_FLAGS</span>.<span class="property">LYC_FLAG</span>;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> stat;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滚动寄存器</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">SCY</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">scy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">SCX</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">scx</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前扫描线 (只读)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">LY</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">ly</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描线比较值</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">LYC</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">lyc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DMA 寄存器 (写入专用，读取返回上次写入值)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">DMA</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">dma</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调色板寄存器</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">BGP</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">bgp</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">OBP0</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">obp0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">OBP1</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">obp1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 窗口位置寄存器</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">WY</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">wy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">WX</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">wx</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ 尝试读取未知的 GPU 寄存器: 0x<span class="subst">${address.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFF</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入 GPU 寄存器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">address</span> - 寄存器地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">value</span> - 要写入的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">writeRegister</span>(<span class="params">address, value</span>) {</span><br><span class="line">  <span class="comment">// 确保值在 8 位范围内</span></span><br><span class="line">  value &amp;= <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (address) {</span><br><span class="line">    <span class="comment">// LCD 控制寄存器 (0xFF40)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">LCDC</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">lcdc</span> = value;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateControlFlags</span>();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 当 LCD 被禁用时，重置一些状态</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lcdEnabled</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">ly</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">HBLANK</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">      }</span><br><span class="line">      </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🎛️ LCD 控制寄存器更新: 0x<span class="subst">${value.toString(<span class="number">16</span>).padStart(<span class="number">2</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LCD 状态寄存器 (0xFF41) - 只有高 5 位可写</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">STAT</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">stat</span> = (value &amp; <span class="number">0xF8</span>) | (<span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">stat</span> &amp; <span class="number">0x07</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滚动寄存器</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">SCY</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">scy</span> = value;</span><br><span class="line">      <span class="comment">// 通知图形系统滚动更新</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphicsSystem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="property">scrollController</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="property">scrollController</span>.<span class="title function_">setScrollY</span>(value);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">SCX</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">scx</span> = value;</span><br><span class="line">      <span class="comment">// 通知图形系统滚动更新</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphicsSystem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="property">scrollController</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="property">scrollController</span>.<span class="title function_">setScrollX</span>(value);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前扫描线 (只读寄存器，写入被忽略)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">LY</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ 尝试写入只读寄存器 LY: 0x<span class="subst">${value.toString(<span class="number">16</span>)}</span>`</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描线比较值</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">LYC</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">lyc</span> = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DMA 传输寄存器 (0xFF46)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">DMA</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">dma</span> = value;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">performDMATransfer</span>(value);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 背景调色板 (0xFF47)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">BGP</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">bgp</span> = value;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">updateBackgroundPalette</span>(value);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🎨 背景调色板更新: 0x<span class="subst">${value.toString(<span class="number">16</span>).padStart(<span class="number">2</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 精灵调色板寄存器</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">OBP0</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">obp0</span> = value;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> 实现精灵调色板更新 (第7章)</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">OBP1</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">obp1</span> = value;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> 实现精灵调色板更新 (第7章)</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 窗口位置寄存器</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">WY</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">wy</span> = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable constant_">GPU_REGISTERS</span>.<span class="property">WX</span>:</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">wx</span> = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`⚠️ 尝试写入未知的 GPU 寄存器: 0x<span class="subst">${address.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span> = 0x<span class="subst">${value.toString(<span class="number">16</span>).padStart(<span class="number">2</span>, <span class="string">'0'</span>)}</span>`</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>DMA（直接内存访问）是 GameBoy 的重要功能，允许快速复制精灵数据到 OAM：</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 DMA 传输</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">sourceHigh</span> - 源地址高字节</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">performDMATransfer</span>(<span class="params">sourceHigh</span>) {</span><br><span class="line">  <span class="comment">// DMA 传输：将 256 字节从 sourceHigh*0x100 复制到 OAM (0xFE00-0xFE9F)</span></span><br><span class="line">  <span class="keyword">const</span> sourceAddr = sourceHigh &lt;&lt; <span class="number">8</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🚚 DMA 传输: 0x<span class="subst">${sourceAddr.toString(<span class="number">16</span>).padStart(<span class="number">4</span>, <span class="string">'0'</span>)}</span> -&gt; OAM`</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 实现完整的 DMA 传输逻辑</span></span><br><span class="line">  <span class="comment">// 需要从 MMU 读取数据并写入 OAM</span></span><br><span class="line">  <span class="comment">// 在真实硬件中，这会锁定总线并需要特定的时序</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新背景调色板</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">paletteValue</span> - 调色板寄存器值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">updateBackgroundPalette</span>(<span class="params">paletteValue</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphicsSystem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="property">paletteManager</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphicsSystem</span>.<span class="property">paletteManager</span>.<span class="title function_">updatePaletteRegister</span>(paletteValue);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="54-系统调度器架构"><a class="markdownIt-Anchor" href="#54-系统调度器架构"></a> 5.4. 系统调度器架构</h2>
<p>现在我们有了能够相互通信的硬件组件，但还需要一个「指挥家」来协调它们的工作。这就是系统调度器 <code>gameboy.js</code> 的作用。</p>
<p>系统调度器作为顶层管理器，负责创建、连接和管理所有硬件组件：</p>
<figure class="highlight javascript"><figcaption><span>gameboy.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统常量定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SYSTEM_CONSTANTS</span> = {</span><br><span class="line">  <span class="comment">// 时序常量</span></span><br><span class="line">  <span class="attr">CPU_FREQUENCY</span>: <span class="number">4194304</span>,      <span class="comment">// 4.194304 MHz</span></span><br><span class="line">  <span class="attr">TARGET_FPS</span>: <span class="number">59.7</span>,           <span class="comment">// GameBoy 目标帧率</span></span><br><span class="line">  <span class="attr">FRAME_CYCLES</span>: <span class="number">70224</span>,        <span class="comment">// 每帧的 CPU 周期数</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 系统状态</span></span><br><span class="line">  <span class="attr">STATE_STOPPED</span>: <span class="string">'stopped'</span>,</span><br><span class="line">  <span class="attr">STATE_RUNNING</span>: <span class="string">'running'</span>,</span><br><span class="line">  <span class="attr">STATE_PAUSED</span>: <span class="string">'paused'</span>,</span><br><span class="line">  <span class="attr">STATE_ERROR</span>: <span class="string">'error'</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调度模式</span></span><br><span class="line">  <span class="attr">SCHEDULE_FRAME</span>: <span class="string">'frame'</span>,     <span class="comment">// 帧级别调度（默认）</span></span><br><span class="line">  <span class="attr">SCHEDULE_CYCLE</span>: <span class="string">'cycle'</span>,     <span class="comment">// 周期级别调度（精确）</span></span><br><span class="line">  <span class="attr">SCHEDULE_BURST</span>: <span class="string">'burst'</span>      <span class="comment">// 突发调度（性能优先）</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GameBoy 主系统类</span></span><br><span class="line"><span class="comment"> * 协调 CPU、MMU、GPU 和其他硬件组件的工作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameBoySystem</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="comment">// 系统状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">STATE_STOPPED</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scheduleMode</span> = <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">SCHEDULE_FRAME</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 硬件组件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cpu</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mmu</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpu</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调度器状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">runningInterval</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameRequestId</span> = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 性能统计</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stats</span> = {</span><br><span class="line">      <span class="attr">framesRendered</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">cyclesExecuted</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">startTime</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">currentFPS</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">averageFPS</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">errors</span>: <span class="number">0</span></span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>系统调度器的初始化过程展示了完整的组件连接流程：</p>
<figure class="highlight javascript"><figcaption><span>gameboy.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建硬件组件实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">createHardwareComponents</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 创建 MMU（内存管理单元）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mmu</span> = <span class="keyword">new</span> <span class="title class_">GameBoyMMU</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ MMU 已创建'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 GPU（图形处理单元）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">gpu</span> = <span class="keyword">new</span> <span class="title class_">GameBoyGPU</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ GPU 已创建'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取图形系统引用</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="property">graphicsSystem</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphics</span> = <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="property">graphicsSystem</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ 图形系统已连接'</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 CPU（中央处理器）</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cpu</span> = <span class="keyword">new</span> <span class="title class_">GameBoyCPU</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ CPU 已创建'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接硬件组件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">connectComponents</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 连接 GPU 到 MMU</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">connectHardware</span>(<span class="string">'gpu'</span>, <span class="variable language_">this</span>.<span class="property">gpu</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 连接 GPU 到 VRAM</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="property">vram</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="title function_">connectVRAM</span>(<span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="property">vram</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接图形系统到 VRAM</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">graphics</span>) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">graphics</span>.<span class="title function_">connectVRAM</span>(<span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="property">vram</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'🔗 硬件组件连接完成'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这个连接过程确保了：</p>
<ol>
<li>GPU 能够通过 MMU 接收寄存器访问</li>
<li>GPU 能够直接访问 VRAM 进行渲染</li>
<li>图形系统能够接收 VRAM 更新通知</li>
</ol>
<h2 id="55-帧级别时序调度"><a class="markdownIt-Anchor" href="#55-帧级别时序调度"></a> 5.5. 帧级别时序调度</h2>
<p>先前我们实现了精确的周期级别时序，但在实际运行中这种精确度往往会带来性能负担，因此我们当时引入了帧级别调度，在保持足够精度的同时大幅提升性能。现在我们完善一下当时只是简化版本的 <code>stepFrame()</code>。</p>
<figure class="highlight javascript"><figcaption><span>gpu.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每次调用渲染一整帧，避免复杂的周期计算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">stepFrame</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 如果 LCD 被禁用，不渲染</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_lcdEnabled</span>) {</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 渲染所有可见扫描线 (0-143)</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> line = <span class="number">0</span>; line &lt; <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VISIBLE_LINES</span>; line++) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentLine</span> = line;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">ly</span> = line;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">PIXEL_TRANSFER</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">renderScanline</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 模拟垂直消隐期间 (144-153)</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">VBLANK</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VISIBLE_LINES</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">ly</span> = <span class="variable constant_">GPU_TIMINGS</span>.<span class="property">VISIBLE_LINES</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 完成帧渲染</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">onFrameComplete</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. 重置到下一帧开始</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">currentLine</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">registers</span>.<span class="property">ly</span> = <span class="number">0</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = <span class="variable constant_">GPU_MODES</span>.<span class="property">OAM_SEARCH</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">modeClock</span> = <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>系统调度器支持多种调度模式以适应不同的需求：</p>
<figure class="highlight javascript"><figcaption><span>gameboy.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 帧级别调度循环（默认模式）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">startFrameLoop</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">frameLoop</span> = (<span class="params">currentTime</span>) =&gt; {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> !== <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">STATE_RUNNING</span>) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 计算时间差</span></span><br><span class="line">      <span class="keyword">const</span> deltaTime = currentTime - <span class="variable language_">this</span>.<span class="property">lastFrameTime</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果达到目标帧时间，执行一帧</span></span><br><span class="line">      <span class="keyword">if</span> (deltaTime &gt;= <span class="variable language_">this</span>.<span class="property">targetFrameTime</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">executeFrame</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">lastFrameTime</span> = currentTime;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateFPS</span>(deltaTime);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 请求下一帧</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">frameRequestId</span> = <span class="title function_">requestAnimationFrame</span>(frameLoop);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">handleError</span>(error);</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动循环</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">frameRequestId</span> = <span class="title function_">requestAnimationFrame</span>(frameLoop);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行一帧的渲染</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">executeFrame</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 简化的帧执行：直接让 GPU 渲染一帧</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gpu</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="title function_">stepFrame</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新统计</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">framesRendered</span>++;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">cyclesExecuted</span> += <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">FRAME_CYCLES</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这种设计的优势是：</p>
<ul>
<li>性能优化：避免了复杂的周期级别计算</li>
<li>稳定的帧率：使用 <code>requestAnimationFrame</code> 确保流畅的 60 FPS</li>
<li>灵活性：可以根据需要切换到其他调度模式</li>
</ul>
<h2 id="56-错误处理与系统监控"><a class="markdownIt-Anchor" href="#56-错误处理与系统监控"></a> 5.6. 错误处理与系统监控</h2>
<p>一个健壮的模拟器必须能够优雅地处理错误并提供丰富的监控信息。系统调度器实现了多层次的错误处理：</p>
<figure class="highlight javascript"><figcaption><span>gameboy.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 错误处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">handleError</span>(<span class="params">error</span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">errors</span>++;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`🚨 系统错误 #<span class="subst">${<span class="variable language_">this</span>.stats.errors}</span>:`</span>, error);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果错误过多，停止系统</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">errors</span> &gt; <span class="number">10</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'❌ 错误过多，停止系统运行'</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">stop</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">STATE_ERROR</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 尝试恢复</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">retryCount</span>++;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">retryCount</span> &lt; <span class="variable language_">this</span>.<span class="property">maxRetries</span>) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🔄 尝试恢复系统 (<span class="subst">${<span class="variable language_">this</span>.retryCount}</span>/<span class="subst">${<span class="variable language_">this</span>.maxRetries}</span>)`</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">STATE_ERROR</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reset</span>();</span><br><span class="line">      }</span><br><span class="line">    }, <span class="number">1000</span>);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'❌ 恢复失败，系统进入错误状态'</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">SYSTEM_CONSTANTS</span>.<span class="property">STATE_ERROR</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>系统提供了丰富的性能统计信息：</p>
<figure class="highlight javascript"><figcaption><span>gameboy.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新 FPS 计算</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">deltaTime</span> - 帧时间差</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">updateFPS</span>(<span class="params">deltaTime</span>) {</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">currentFPS</span> = deltaTime &gt; <span class="number">0</span> ? <span class="number">1000</span> / deltaTime : <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算平均 FPS</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">calculateAverageFPS</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> totalTime = (performance.<span class="title function_">now</span>() - <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">startTime</span>) / <span class="number">1000</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">averageFPS</span> = totalTime &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">framesRendered</span> / totalTime : <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取系统状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getStatus</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> status = {</span><br><span class="line">    <span class="attr">state</span>: <span class="variable language_">this</span>.<span class="property">state</span>,</span><br><span class="line">    <span class="attr">scheduleMode</span>: <span class="variable language_">this</span>.<span class="property">scheduleMode</span>,</span><br><span class="line">    <span class="attr">statistics</span>: { ...<span class="variable language_">this</span>.<span class="property">stats</span> },</span><br><span class="line">    <span class="attr">components</span>: {</span><br><span class="line">      <span class="attr">cpu</span>: <span class="variable language_">this</span>.<span class="property">cpu</span> ? <span class="variable language_">this</span>.<span class="property">cpu</span>.<span class="title function_">getStatusString</span>() : <span class="string">'未初始化'</span>,</span><br><span class="line">      <span class="attr">mmu</span>: <span class="variable language_">this</span>.<span class="property">mmu</span> ? <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">getMemoryStats</span>() : <span class="string">'未初始化'</span>,</span><br><span class="line">      <span class="attr">gpu</span>: <span class="variable language_">this</span>.<span class="property">gpu</span> ? <span class="variable language_">this</span>.<span class="property">gpu</span>.<span class="title function_">getStatus</span>() : <span class="string">'未初始化'</span></span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算实时统计</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">startTime</span> &gt; <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">const</span> totalTime = (performance.<span class="title function_">now</span>() - <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">startTime</span>) / <span class="number">1000</span>;</span><br><span class="line">    status.<span class="property">statistics</span>.<span class="property">totalRunTime</span> = totalTime;</span><br><span class="line">    status.<span class="property">statistics</span>.<span class="property">averageFPS</span> = totalTime &gt; <span class="number">0</span> ? <span class="variable language_">this</span>.<span class="property">stats</span>.<span class="property">framesRendered</span> / totalTime : <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取调试信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">string</span>} 格式化的调试信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getDebugInfo</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">const</span> status = <span class="variable language_">this</span>.<span class="title function_">getStatus</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> debugInfo = <span class="string">`🎮 === GameBoy 系统状态 ===</span></span><br><span class="line"><span class="string">系统状态：<span class="subst">${status.state}</span></span></span><br><span class="line"><span class="string">调度模式：<span class="subst">${status.scheduleMode}</span></span></span><br><span class="line"><span class="string">运行时间：<span class="subst">${status.statistics.totalRunTime?.toFixed(<span class="number">2</span>) || <span class="number">0</span>}</span>秒</span></span><br><span class="line"><span class="string">已渲染帧数：<span class="subst">${status.statistics.framesRendered}</span></span></span><br><span class="line"><span class="string">执行周期数：<span class="subst">${status.statistics.cyclesExecuted}</span></span></span><br><span class="line"><span class="string">当前 FPS：<span class="subst">${status.statistics.currentFPS?.toFixed(<span class="number">2</span>) || <span class="number">0</span>}</span></span></span><br><span class="line"><span class="string">平均 FPS：<span class="subst">${status.statistics.averageFPS?.toFixed(<span class="number">2</span>) || <span class="number">0</span>}</span></span></span><br><span class="line"><span class="string">错误计数：<span class="subst">${status.statistics.errors}</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">📱 硬件组件状态：`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CPU 状态</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cpu</span>) {</span><br><span class="line">    debugInfo += <span class="string">`\n\n💻 CPU 状态：\n<span class="subst">${<span class="variable language_">this</span>.cpu.getStatusString()}</span>`</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// GPU 状态</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">gpu</span>) {</span><br><span class="line">    debugInfo += <span class="string">`\n\n🎨 GPU 状态：\n<span class="subst">${<span class="variable language_">this</span>.gpu.getDebugInfo()}</span>`</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MMU 状态</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">mmu</span>) {</span><br><span class="line">    <span class="keyword">const</span> mmuStats = <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">getMemoryStats</span>();</span><br><span class="line">    debugInfo += <span class="string">`\n\n💾 MMU 状态：</span></span><br><span class="line"><span class="string">BIOS 启用：<span class="subst">${mmuStats.biosEnabled ? <span class="string">'是'</span> : <span class="string">'否'</span>}</span></span></span><br><span class="line"><span class="string">ROM 已加载：<span class="subst">${mmuStats.romLoaded ? <span class="string">'是'</span> : <span class="string">'否'</span>}</span></span></span><br><span class="line"><span class="string">硬件连接：</span></span><br><span class="line"><span class="string">GPU: <span class="subst">${mmuStats.hardwareConnections.gpu ? <span class="string">'✅'</span> : <span class="string">'❌'</span>}</span></span></span><br><span class="line"><span class="string">输入: <span class="subst">${mmuStats.hardwareConnections.input ? <span class="string">'✅'</span> : <span class="string">'❌'</span>}</span></span></span><br><span class="line"><span class="string">定时器: <span class="subst">${mmuStats.hardwareConnections.timer ? <span class="string">'✅'</span> : <span class="string">'❌'</span>}</span></span></span><br><span class="line"><span class="string">中断: <span class="subst">${mmuStats.hardwareConnections.interrupt ? <span class="string">'✅'</span> : <span class="string">'❌'</span>}</span>`</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> debugInfo;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取内存转储</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">address</span> - 起始地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">length</span> - 长度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> {<span class="type">string</span>} 内存转储</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">getMemoryDump</span>(<span class="params">address, length = <span class="number">256</span></span>) {</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">mmu</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'❌ MMU 未初始化'</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">mmu</span>.<span class="title function_">getMemoryDump</span>(address, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置调试模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">boolean</span>} <span class="variable">enabled</span> - 是否启用调试模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">setDebugMode</span>(<span class="params">enabled</span>) {</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">DEBUG_MODE</span> = enabled;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🔧 调试模式<span class="subst">${enabled ? <span class="string">'已启用'</span> : <span class="string">'已禁用'</span>}</span>`</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 销毁系统（清理资源）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">destroy</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'💥 销毁 GameBoy 系统...'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止运行</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">stop</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理组件引用</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cpu</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mmu</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">gpu</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">graphics</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理全局引用</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">MMU</span>) <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">MMU</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">GPU</span>) <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">GPU</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">CPU</span>) <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">CPU</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Graphics</span>) <span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">Graphics</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ 系统已销毁'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="57-现代化用户界面"><a class="markdownIt-Anchor" href="#57-现代化用户界面"></a> 5.7. 现代化用户界面</h2>
<details>
<summary>展开以查看</summary>
<figure class="highlight html"><figcaption><span>index.HTML</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>GameBoy 模拟器 - JavaScript 版本<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 全局样式重置 */</span></span></span><br><span class="line"><span class="language-css">    * {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-family</span>: <span class="string">'Courier New'</span>, monospace;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="number">#2c5530</span>, <span class="number">#4a7c59</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#000</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 主容器 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gameboy-container</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#8b956d</span>, <span class="number">#9bb583</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">20px</span> <span class="number">20px</span> <span class="number">60px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              <span class="number">0</span> <span class="number">20px</span> <span class="number">40px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>),</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">max-width</span>: <span class="number">700px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 顶部标题区域 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.header</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.title</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">28px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#2c5530</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-shadow</span>:</span></span><br><span class="line"><span class="language-css">              <span class="number">1px</span> <span class="number">1px</span> <span class="number">0</span> <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>),</span></span><br><span class="line"><span class="language-css">              <span class="number">2px</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">letter-spacing</span>: <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.subtitle</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#5a6b4d</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.version</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#6b7a5e</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-style</span>: italic;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 屏幕区域 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.screen-container</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#4a5c3a</span>, <span class="number">#5a6c4a</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">25px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">30px</span> auto;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">4px</span> <span class="number">8px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>),</span></span><br><span class="line"><span class="language-css">              <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: fit-content;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.screen-bezel</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#2c3624</span>, <span class="number">#3c4634</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>: inset <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* GameBoy 屏幕 Canvas */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-id">#screen</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: <span class="number">320px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">height</span>: <span class="number">288px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="number">#9bbc0f</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">image-rendering</span>: pixelated;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">image-rendering</span>: -moz-crisp-edges;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">image-rendering</span>: crisp-edges;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2px</span> <span class="number">#8bac0f</span>,</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4px</span> <span class="number">#5a6b4d</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 屏幕标签 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.screen-label</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">bottom</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">left</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">transform</span>: <span class="built_in">translateX</span>(-<span class="number">50%</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#6b7a5e</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">letter-spacing</span>: <span class="number">1px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 系统状态指示器 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.status-indicator</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">top</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">right</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">display</span>: flex;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">gap</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.indicator</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">height</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.indicator</span><span class="selector-class">.running</span> { <span class="attribute">background</span>: <span class="number">#00ff00</span>; }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.indicator</span><span class="selector-class">.stopped</span> { <span class="attribute">background</span>: <span class="number">#ff0000</span>; }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.indicator</span><span class="selector-class">.paused</span> { <span class="attribute">background</span>: <span class="number">#ffff00</span>; }</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.indicator</span><span class="selector-class">.error</span> { <span class="attribute">background</span>: <span class="number">#ff8800</span>; }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 控制面板 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.controls</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">display</span>: grid;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr <span class="number">1</span>fr;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">gap</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-top</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.control-section</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#7a8a6d</span>, <span class="number">#8a9a7d</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.1</span>),</span></span><br><span class="line"><span class="language-css">              <span class="number">0</span> <span class="number">4px</span> <span class="number">8px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.control-title</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#2c5530</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#5a6b4d</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding-bottom</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 按钮样式 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#a5b588</span>, <span class="number">#95a578</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#2c5530</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">transition</span>: all <span class="number">0.2s</span> ease;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              <span class="number">0</span> <span class="number">3px</span> <span class="number">6px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>),</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">1px</span> <span class="number">2px</span> <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.2</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">10px</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">position</span>: relative;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-pseudo">:hover</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#b5c598</span>, <span class="number">#a5b588</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">1px</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              <span class="number">0</span> <span class="number">4px</span> <span class="number">8px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>),</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">1px</span> <span class="number">2px</span> <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-pseudo">:active</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">1px</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>:</span></span><br><span class="line"><span class="language-css">              <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span>),</span></span><br><span class="line"><span class="language-css">              inset <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-pseudo">:disabled</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">opacity</span>: <span class="number">0.6</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">cursor</span>: not-allowed;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">transform</span>: none;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.primary</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#5a7c4a</span>, <span class="number">#4a6c3a</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.primary</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:disabled</span>) {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#6a8c5a</span>, <span class="number">#5a7c4a</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.danger</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#a56565</span>, <span class="number">#955555</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.danger</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:disabled</span>) {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#b57575</span>, <span class="number">#a56565</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.success</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#5a8a5a</span>, <span class="number">#4a7a4a</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.success</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">:not</span>(<span class="selector-pseudo">:disabled</span>) {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#6a9a6a</span>, <span class="number">#5a8a5a</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 按钮状态指示 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.btn</span><span class="selector-class">.loading</span><span class="selector-pseudo">::after</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">content</span>: <span class="string">''</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">right</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">top</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">height</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border</span>: <span class="number">2px</span> solid transparent;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-top</span>: <span class="number">2px</span> solid currentColor;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">animation</span>: spin <span class="number">1s</span> linear infinite;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="keyword">@keyframes</span> spin {</span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">to</span> { <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">50%</span>) <span class="built_in">rotate</span>(<span class="number">360deg</span>); }</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 状态显示区域 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.status-panel</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-top</span>: <span class="number">30px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#3c4634</span>, <span class="number">#4c5644</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>: inset <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.status-title</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#9bb583</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.status-content</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="number">#1a1a1a</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#00ff00</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-family</span>: <span class="string">'Courier New'</span>, monospace;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">11px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">6px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">height</span>: <span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">white-space</span>: pre-wrap;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 性能面板 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.performance-panel</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-top</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#2c3624</span>, <span class="number">#3c4634</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">box-shadow</span>: inset <span class="number">0</span> <span class="number">2px</span> <span class="number">6px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.performance-grid</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">display</span>: grid;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(auto-fit, <span class="built_in">minmax</span>(<span class="number">120px</span>, <span class="number">1</span>fr));</span></span><br><span class="line"><span class="language-css">      <span class="attribute">gap</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-top</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.performance-item</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.performance-value</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">display</span>: block;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">18px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#00ff00</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.performance-label</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#9bb583</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-transform</span>: uppercase;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 响应式设计 */</span></span></span><br><span class="line"><span class="language-css">    <span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) {</span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.gameboy-container</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">margin</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-id">#screen</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">240px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">216px</span>;</span></span><br><span class="line"><span class="language-css">      }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.controls</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">gap</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.title</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">font-size</span>: <span class="number">24px</span>;</span></span><br><span class="line"><span class="language-css">      }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-class">.performance-grid</span> {</span></span><br><span class="line"><span class="language-css">        <span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(<span class="number">2</span>, <span class="number">1</span>fr);</span></span><br><span class="line"><span class="language-css">      }</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 信息提示 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.info-box</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">145deg</span>, <span class="number">#6a7c5a</span>, <span class="number">#7a8c6a</span>);</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-left</span>: <span class="number">4px</span> solid <span class="number">#4a6c3a</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#2c5530</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">13px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">line-height</span>: <span class="number">1.5</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.info-box</span> <span class="selector-tag">h4</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-bottom</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#1a3520</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* 键盘快捷键显示 */</span></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.keyboard-hint</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-size</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#6b7a5e</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.key</span> {</span></span><br><span class="line"><span class="language-css">      <span class="attribute">background</span>: <span class="number">#5a6b4d</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">color</span>: <span class="number">#fff</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">padding</span>: <span class="number">2px</span> <span class="number">6px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">    }</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"gameboy-container"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 顶部标题区域 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>GAME BOY<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle"</span>&gt;</span>JavaScript 模拟器<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"version"</span>&gt;</span>版本 0.5.0 - 系统集成<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 屏幕区域 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"screen-container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"status-indicator"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"indicator stopped"</span> <span class="attr">id</span>=<span class="string">"system-indicator"</span> <span class="attr">title</span>=<span class="string">"系统状态"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"screen-bezel"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"screen"</span> <span class="attr">width</span>=<span class="string">"160"</span> <span class="attr">height</span>=<span class="string">"144"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"screen-label"</span>&gt;</span>DOT MATRIX WITH STEREO SOUND<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 控制面板 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"controls"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 系统控制 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-section"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-title"</span>&gt;</span>🎮 系统控制<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn primary"</span> <span class="attr">id</span>=<span class="string">"init-btn"</span>&gt;</span>初始化系统<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn success"</span> <span class="attr">id</span>=<span class="string">"start-btn"</span> <span class="attr">disabled</span>&gt;</span>开始运行<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"pause-btn"</span> <span class="attr">disabled</span>&gt;</span>暂停/恢复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn danger"</span> <span class="attr">id</span>=<span class="string">"stop-btn"</span> <span class="attr">disabled</span>&gt;</span>停止运行<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"reset-btn"</span> <span class="attr">disabled</span>&gt;</span>重置系统<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"keyboard-hint"</span>&gt;</span></span><br><span class="line">        快捷键：<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>Space<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 开始/暂停 <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>R<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 重置</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 程序加载 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-section"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-title"</span>&gt;</span>📦 程序加载<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"load-demo-btn"</span> <span class="attr">disabled</span>&gt;</span>加载演示程序<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"load-rom-btn"</span> <span class="attr">disabled</span>&gt;</span>加载 ROM 文件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"rom-file-input"</span> <span class="attr">accept</span>=<span class="string">".gb,.gbc"</span> <span class="attr">style</span>=<span class="string">"display: none;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"step-btn"</span> <span class="attr">disabled</span>&gt;</span>单步执行<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"keyboard-hint"</span>&gt;</span></span><br><span class="line">        快捷键：<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>L<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 加载演示 <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>S<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 单步</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 调试和图形控制 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"controls"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 调试工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-section"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-title"</span>&gt;</span>🔧 调试工具<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"show-status-btn"</span>&gt;</span>显示系统状态<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"show-memory-btn"</span>&gt;</span>内存转储<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"show-registers-btn"</span>&gt;</span>CPU 寄存器<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"toggle-debug-btn"</span>&gt;</span>切换调试模式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"keyboard-hint"</span>&gt;</span></span><br><span class="line">        快捷键：<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>D<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 调试 <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>M<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 内存</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 图形控制 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-section"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-title"</span>&gt;</span>🎨 图形控制<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"toggle-render-btn"</span>&gt;</span>切换渲染模式<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"show-graphics-btn"</span>&gt;</span>图形系统状态<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">id</span>=<span class="string">"test-graphics-btn"</span>&gt;</span>测试图形渲染<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn danger"</span> <span class="attr">id</span>=<span class="string">"clear-console-btn"</span>&gt;</span>清空控制台<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"keyboard-hint"</span>&gt;</span></span><br><span class="line">        快捷键：<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>G<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 图形模式 <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"key"</span>&gt;</span>T<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 测试</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 性能监控面板 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-panel"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"status-title"</span>&gt;</span>📊 实时性能监控<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-grid"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-item"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-value"</span> <span class="attr">id</span>=<span class="string">"fps-value"</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-label"</span>&gt;</span>FPS<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-item"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-value"</span> <span class="attr">id</span>=<span class="string">"frames-value"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-label"</span>&gt;</span>帧数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-item"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-value"</span> <span class="attr">id</span>=<span class="string">"instructions-value"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-label"</span>&gt;</span>指令数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-item"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-value"</span> <span class="attr">id</span>=<span class="string">"cycles-value"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-label"</span>&gt;</span>周期数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-item"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-value"</span> <span class="attr">id</span>=<span class="string">"errors-value"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-label"</span>&gt;</span>错误数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"performance-item"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-value"</span> <span class="attr">id</span>=<span class="string">"uptime-value"</span>&gt;</span>0s<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"performance-label"</span>&gt;</span>运行时间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 状态显示面板 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"status-panel"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"status-title"</span>&gt;</span>📋 系统控制台 &amp; 调试输出<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"console-output"</span> <span class="attr">class</span>=<span class="string">"status-content"</span>&gt;</span>GameBoy 模拟器 v0.5.0 已准备就绪...</span><br><span class="line">🎮 第五章：系统集成</span><br><span class="line">✨ 新功能：完整的系统架构、CPU 指令集、寄存器控制</span><br><span class="line"></span><br><span class="line">等待系统初始化...</span><br><span class="line"></span><br><span class="line">使用说明：</span><br><span class="line">1. 点击"初始化系统"启动模拟器</span><br><span class="line">2. 点击"加载演示程序"或加载 ROM 文件</span><br><span class="line">3. 点击"开始运行"启动系统</span><br><span class="line">4. 观察实时性能监控和调试输出</span><br><span class="line">5. 使用调试工具查看系统状态</span><br><span class="line"></span><br><span class="line">组件状态：</span><br><span class="line">- CPU: 等待初始化...</span><br><span class="line">- MMU: 等待初始化...</span><br><span class="line">- GPU: 等待初始化...</span><br><span class="line">- 图形系统: 等待初始化...</span><br><span class="line">- 系统调度器: 等待初始化...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- JavaScript 文件导入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"mmu.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"graphics.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"gpu.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"cpu.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"gameboy.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 主程序脚本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">(<span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">  <span class="string">'use strict'</span>;</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 全局变量</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> systemInstance = <span class="literal">null</span>;  <span class="comment">// 避免与 gameboy.js 中的变量冲突</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> performanceUpdateInterval = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> isDebugMode = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// UI 元素引用</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> elements = {</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 按钮</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">initBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'init-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">startBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'start-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">pauseBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'pause-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">stopBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'stop-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">resetBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'reset-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">loadDemoBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'load-demo-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">loadRomBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'load-rom-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">stepBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'step-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">showStatusBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'show-status-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">showMemoryBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'show-memory-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">showRegistersBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'show-registers-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">toggleDebugBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'toggle-debug-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">toggleRenderBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'toggle-render-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">showGraphicsBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'show-graphics-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">testGraphicsBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'test-graphics-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">clearConsoleBtn</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'clear-console-btn'</span>),</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 状态指示器</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">systemIndicator</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'system-indicator'</span>),</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 性能显示</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">fpsValue</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'fps-value'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">framesValue</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'frames-value'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">instructionsValue</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'instructions-value'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">cyclesValue</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'cycles-value'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">errorsValue</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'errors-value'</span>),</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">uptimeValue</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'uptime-value'</span>),</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 控制台输出</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">consoleOutput</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'console-output'</span>),</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 文件输入</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">romFileInput</span>: <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'rom-file-input'</span>)</span></span><br><span class="line"><span class="language-javascript">  };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 添加日志输出功能</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">addLog</span>(<span class="params">message, type = <span class="string">'info'</span></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> timestamp = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toLocaleTimeString</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> prefix = {</span></span><br><span class="line"><span class="language-javascript">      <span class="string">'info'</span>: <span class="string">'📝'</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="string">'success'</span>: <span class="string">'✅'</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="string">'warning'</span>: <span class="string">'⚠️'</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="string">'error'</span>: <span class="string">'❌'</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="string">'debug'</span>: <span class="string">'🔧'</span></span></span><br><span class="line"><span class="language-javascript">    }[type] || <span class="string">'📝'</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">consoleOutput</span>.<span class="property">textContent</span> += <span class="string">`[<span class="subst">${timestamp}</span>] <span class="subst">${prefix}</span> <span class="subst">${message}</span>\n`</span>;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">consoleOutput</span>.<span class="property">scrollTop</span> = elements.<span class="property">consoleOutput</span>.<span class="property">scrollHeight</span>;</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 重写 console.log 以在页面上显示</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> originalConsoleLog = <span class="variable language_">console</span>.<span class="property">log</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> originalConsoleError = <span class="variable language_">console</span>.<span class="property">error</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> originalConsoleWarn = <span class="variable language_">console</span>.<span class="property">warn</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="property">log</span> = <span class="keyword">function</span>(<span class="params">...args</span>) {</span></span><br><span class="line"><span class="language-javascript">    originalConsoleLog.<span class="title function_">apply</span>(<span class="variable language_">console</span>, args);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> message = args.<span class="title function_">join</span>(<span class="string">' '</span>);</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 只有重要消息才显示到页面</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> importantKeywords = [<span class="string">'✅'</span>, <span class="string">'❌'</span>, <span class="string">'⚠️'</span>, <span class="string">'🎮'</span>, <span class="string">'📊'</span>, <span class="string">'🔧'</span>, <span class="string">'初始化'</span>, <span class="string">'加载'</span>, <span class="string">'错误'</span>, <span class="string">'完成'</span>];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (importantKeywords.<span class="title function_">some</span>(<span class="function"><span class="params">keyword</span> =&gt;</span> message.<span class="title function_">includes</span>(keyword)) || isDebugMode) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(message);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="property">error</span> = <span class="keyword">function</span>(<span class="params">...args</span>) {</span></span><br><span class="line"><span class="language-javascript">    originalConsoleError.<span class="title function_">apply</span>(<span class="variable language_">console</span>, args);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(args.<span class="title function_">join</span>(<span class="string">' '</span>), <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">  };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">console</span>.<span class="property">warn</span> = <span class="keyword">function</span>(<span class="params">...args</span>) {</span></span><br><span class="line"><span class="language-javascript">    originalConsoleWarn.<span class="title function_">apply</span>(<span class="variable language_">console</span>, args);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(args.<span class="title function_">join</span>(<span class="string">' '</span>), <span class="string">'warning'</span>);</span></span><br><span class="line"><span class="language-javascript">  };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 更新系统状态指示器</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">updateSystemIndicator</span>(<span class="params">state</span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> indicator = elements.<span class="property">systemIndicator</span>;</span></span><br><span class="line"><span class="language-javascript">    indicator.<span class="property">className</span> = <span class="string">`indicator <span class="subst">${state}</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">    indicator.<span class="property">title</span> = <span class="string">`系统状态: <span class="subst">${state}</span>`</span>;</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 更新按钮状态</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">updateButtonStates</span>(<span class="params">systemState</span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> isInitialized = systemInstance !== <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> isRunning = systemState === <span class="string">'running'</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> isStopped = systemState === <span class="string">'stopped'</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">initBtn</span>.<span class="property">disabled</span> = isInitialized;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">startBtn</span>.<span class="property">disabled</span> = !isInitialized || isRunning;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">pauseBtn</span>.<span class="property">disabled</span> = !isInitialized || isStopped;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">stopBtn</span>.<span class="property">disabled</span> = !isInitialized || isStopped;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">resetBtn</span>.<span class="property">disabled</span> = !isInitialized;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">loadDemoBtn</span>.<span class="property">disabled</span> = !isInitialized;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">loadRomBtn</span>.<span class="property">disabled</span> = !isInitialized;</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">stepBtn</span>.<span class="property">disabled</span> = !isInitialized || isRunning;</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 系统初始化</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">initializeSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'正在初始化 GameBoy 系统...'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">initBtn</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">'loading'</span>);</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 使用系统控制器</span></span></span><br><span class="line"><span class="language-javascript">      systemInstance = <span class="keyword">await</span> <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">init</span>();</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateSystemIndicator</span>(<span class="string">'stopped'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateButtonStates</span>(<span class="string">'stopped'</span>);</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 启动性能监控</span></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">startPerformanceMonitoring</span>();</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'✅ GameBoy 系统初始化完成'</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 系统初始化失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateSystemIndicator</span>(<span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">finally</span> {</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">initBtn</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">'loading'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 系统控制函数</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">startSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'❌ 系统未初始化'</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">start</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateSystemIndicator</span>(<span class="string">'running'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateButtonStates</span>(<span class="string">'running'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'🚀 系统开始运行'</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 启动失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">pauseSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">togglePause</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> status = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getStatus</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateSystemIndicator</span>(status.<span class="property">state</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateButtonStates</span>(status.<span class="property">state</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`⏸️ 系统<span class="subst">${status.state === <span class="string">'paused'</span> ? <span class="string">'已暂停'</span> : <span class="string">'继续运行'</span>}</span>`</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 暂停操作失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">stopSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">stop</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateSystemIndicator</span>(<span class="string">'stopped'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateButtonStates</span>(<span class="string">'stopped'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'⏹️ 系统已停止'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 停止操作失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">resetSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">reset</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateSystemIndicator</span>(<span class="string">'stopped'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">updateButtonStates</span>(<span class="string">'stopped'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'🔄 系统已重置'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 重置失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">stepSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// <span class="doctag">TODO:</span> 实现单步执行</span></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'👣 执行单步操作...'</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 单步执行失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 程序加载函数</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">loadDemo</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'❌ 系统未初始化'</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'📦 正在加载演示程序...'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> success = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">loadDemo</span>();</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (success) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'✅ 演示程序加载完成'</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'💡 现在可以点击"开始运行"启动系统'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">      } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'❌ 演示程序加载失败'</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 加载演示程序失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">loadROMFile</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">romFileInput</span>.<span class="title function_">click</span>();</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleROMFile</span>(<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> file = event.<span class="property">target</span>.<span class="property">files</span>[<span class="number">0</span>];</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!file) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`📦 正在加载 ROM 文件: <span class="subst">${file.name}</span>`</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> arrayBuffer = <span class="keyword">await</span> file.<span class="title function_">arrayBuffer</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> success = <span class="keyword">await</span> <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">loadROM</span>(arrayBuffer);</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (success) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">`✅ ROM 文件加载完成: <span class="subst">${file.name}</span>`</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">      } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">`❌ ROM 文件加载失败: <span class="subst">${file.name}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 文件读取失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 调试工具函数</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">showSystemStatus</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'❌ 系统未初始化'</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> debugInfo = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getDebugInfo</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'📊 === 系统状态 ==='</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(debugInfo, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'================='</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 获取系统状态失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">showMemoryDump</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'❌ 系统未初始化'</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> system = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (system &amp;&amp; system.<span class="property">mmu</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'💾 === 内存转储 (0x0000-0x00FF) ==='</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> dump = system.<span class="title function_">getMemoryDump</span>(<span class="number">0x0000</span>, <span class="number">256</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(dump, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 内存转储失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">showCPURegisters</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'❌ 系统未初始化'</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> system = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (system &amp;&amp; system.<span class="property">cpu</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'💻 === CPU 寄存器状态 ==='</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(system.<span class="property">cpu</span>.<span class="title function_">getStatusString</span>(), <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 获取 CPU 状态失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">toggleDebugMode</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    isDebugMode = !isDebugMode;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">DEBUG_MODE</span> = isDebugMode;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(<span class="string">`🔧 调试模式<span class="subst">${isDebugMode ? <span class="string">'已启用'</span> : <span class="string">'已禁用'</span>}</span>`</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 图形控制函数</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">toggleRenderMode</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> system = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (system &amp;&amp; system.<span class="property">gpu</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> currentMode = system.<span class="property">gpu</span>.<span class="property">renderMode</span> || <span class="string">'test'</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> newMode = currentMode === <span class="string">'test'</span> ? <span class="string">'graphics'</span> : <span class="string">'test'</span>;</span></span><br><span class="line"><span class="language-javascript">        system.<span class="property">gpu</span>.<span class="title function_">setRenderMode</span>(newMode);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">`🎨 渲染模式已切换到：<span class="subst">${newMode === <span class="string">'test'</span> ? <span class="string">'测试模式'</span> : <span class="string">'图形模式'</span>}</span>`</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 切换渲染模式失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">showGraphicsStatus</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> system = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (system &amp;&amp; system.<span class="property">gpu</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'🎨 === 图形系统状态 ==='</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(system.<span class="property">gpu</span>.<span class="title function_">getDebugInfo</span>(), <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 获取图形状态失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">testGraphicsSystem</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> system = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getInstance</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (system &amp;&amp; system.<span class="property">gpu</span>) {</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'🧪 运行图形系统测试...'</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 创建测试数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (system.<span class="property">mmu</span> &amp;&amp; system.<span class="property">mmu</span>.<span class="property">vram</span>) {</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> vram = system.<span class="property">mmu</span>.<span class="property">vram</span>;</span></span><br><span class="line"><span class="language-javascript">          </span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 创建测试瓦片</span></span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i += <span class="number">2</span>) {</span></span><br><span class="line"><span class="language-javascript">            vram[<span class="number">0x8000</span> + i] = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">256</span>);</span></span><br><span class="line"><span class="language-javascript">            vram[<span class="number">0x8000</span> + i + <span class="number">1</span>] = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">256</span>);</span></span><br><span class="line"><span class="language-javascript">          }</span></span><br><span class="line"><span class="language-javascript">          </span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">addLog</span>(<span class="string">'✅ 测试数据已生成'</span>, <span class="string">'debug'</span>);</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 测试渲染</span></span></span><br><span class="line"><span class="language-javascript">        system.<span class="property">gpu</span>.<span class="title function_">stepFrame</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">addLog</span>(<span class="string">'✅ 图形系统测试完成'</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">      }</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">`❌ 图形系统测试失败: <span class="subst">${error.message}</span>`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">clearConsoleLog</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">consoleOutput</span>.<span class="property">textContent</span> = <span class="string">'GameBoy 模拟器控制台\n已清空...\n\n'</span>;</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 性能监控</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">startPerformanceMonitoring</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    performanceUpdateInterval = <span class="built_in">setInterval</span>(updatePerformanceDisplay, <span class="number">500</span>);</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">updatePerformanceDisplay</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!systemInstance) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> status = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getStatus</span>();</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span> (!status) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> stats = status.<span class="property">statistics</span>;</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 更新显示</span></span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">fpsValue</span>.<span class="property">textContent</span> = (stats.<span class="property">currentFPS</span> || <span class="number">0</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>);</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">framesValue</span>.<span class="property">textContent</span> = stats.<span class="property">framesRendered</span> || <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">instructionsValue</span>.<span class="property">textContent</span> = <span class="title function_">formatNumber</span>(stats.<span class="property">cyclesExecuted</span> / <span class="number">4</span> || <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">cyclesValue</span>.<span class="property">textContent</span> = <span class="title function_">formatNumber</span>(stats.<span class="property">cyclesExecuted</span> || <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">errorsValue</span>.<span class="property">textContent</span> = stats.<span class="property">errors</span> || <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">      elements.<span class="property">uptimeValue</span>.<span class="property">textContent</span> = <span class="title function_">formatTime</span>(stats.<span class="property">totalRunTime</span> || <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">catch</span> (error) {</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 静默处理性能监控错误</span></span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">formatNumber</span>(<span class="params">num</span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (num &gt;= <span class="number">1000000</span>) {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> (num / <span class="number">1000000</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">'M'</span>;</span></span><br><span class="line"><span class="language-javascript">    } <span class="keyword">else</span> <span class="keyword">if</span> (num &gt;= <span class="number">1000</span>) {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> (num / <span class="number">1000</span>).<span class="title function_">toFixed</span>(<span class="number">1</span>) + <span class="string">'K'</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> num.<span class="title function_">toString</span>();</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">formatTime</span>(<span class="params">seconds</span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (seconds &gt;= <span class="number">60</span>) {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> minutes = <span class="title class_">Math</span>.<span class="title function_">floor</span>(seconds / <span class="number">60</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> remainingSeconds = <span class="title class_">Math</span>.<span class="title function_">floor</span>(seconds % <span class="number">60</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> <span class="string">`<span class="subst">${minutes}</span>m<span class="subst">${remainingSeconds}</span>s`</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="string">`<span class="subst">${<span class="built_in">Math</span>.floor(seconds)}</span>s`</span>;</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 绑定事件监听器</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">bindEventListeners</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">initBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, initializeSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">startBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, startSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">pauseBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, pauseSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">stopBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, stopSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">resetBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, resetSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">loadDemoBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, loadDemo);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">loadRomBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, loadROMFile);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">stepBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, stepSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">showStatusBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, showSystemStatus);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">showMemoryBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, showMemoryDump);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">showRegistersBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, showCPURegisters);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">toggleDebugBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, toggleDebugMode);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">toggleRenderBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, toggleRenderMode);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">showGraphicsBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, showGraphicsStatus);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">testGraphicsBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, testGraphicsSystem);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">clearConsoleBtn</span>.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, clearConsoleLog);</span></span><br><span class="line"><span class="language-javascript">    elements.<span class="property">romFileInput</span>.<span class="title function_">addEventListener</span>(<span class="string">'change'</span>, handleROMFile);</span></span><br><span class="line"><span class="language-javascript">  }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 键盘快捷键</span></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'keydown'</span>, <span class="keyword">function</span>(<span class="params">event</span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 防止在输入框中触发快捷键</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (event.<span class="property">target</span>.<span class="property">tagName</span> === <span class="string">'INPUT'</span>) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">switch</span>(event.<span class="property">code</span>) {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'Space'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (systemInstance) {</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> status = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getStatus</span>();</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (status.<span class="property">state</span> === <span class="string">'running'</span>) {</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">pauseSystem</span>();</span></span><br><span class="line"><span class="language-javascript">          } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">startSystem</span>();</span></span><br><span class="line"><span class="language-javascript">          }</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyR'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">resetSystem</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyL'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">loadDemo</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyS'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">stepSystem</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyD'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showSystemStatus</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyM'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">showMemoryDump</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyG'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">toggleRenderMode</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">case</span> <span class="string">'KeyT'</span>:</span></span><br><span class="line"><span class="language-javascript">        event.<span class="title function_">preventDefault</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">testGraphicsSystem</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 页面加载完成后的初始化</span></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">'load'</span>, <span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">bindEventListeners</span>();</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(<span class="string">'🎮 GameBoy 模拟器 v0.5.0 已准备就绪'</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(<span class="string">'📚 当前版本：第五章 - 系统集成'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(<span class="string">'✨ 新功能：完整系统架构、CPU 指令集、寄存器控制'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">addLog</span>(<span class="string">'💡 点击"初始化系统"开始使用'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 检查组件加载状态</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> components = [</span></span><br><span class="line"><span class="language-javascript">        { <span class="attr">name</span>: <span class="string">'MMU'</span>, <span class="attr">check</span>: <span class="function">() =&gt;</span> <span class="keyword">typeof</span> <span class="title class_">GameBoyMMU</span> !== <span class="string">'undefined'</span> },</span></span><br><span class="line"><span class="language-javascript">        { <span class="attr">name</span>: <span class="string">'GPU'</span>, <span class="attr">check</span>: <span class="function">() =&gt;</span> <span class="keyword">typeof</span> <span class="title class_">GameBoyGPU</span> !== <span class="string">'undefined'</span> },</span></span><br><span class="line"><span class="language-javascript">        { <span class="attr">name</span>: <span class="string">'CPU'</span>, <span class="attr">check</span>: <span class="function">() =&gt;</span> <span class="keyword">typeof</span> <span class="title class_">GameBoyCPU</span> !== <span class="string">'undefined'</span> },</span></span><br><span class="line"><span class="language-javascript">        { <span class="attr">name</span>: <span class="string">'图形系统'</span>, <span class="attr">check</span>: <span class="function">() =&gt;</span> <span class="keyword">typeof</span> <span class="title class_">GameBoyGraphicsSystem</span> !== <span class="string">'undefined'</span> },</span></span><br><span class="line"><span class="language-javascript">        { <span class="attr">name</span>: <span class="string">'系统控制器'</span>, <span class="attr">check</span>: <span class="function">() =&gt;</span> <span class="keyword">typeof</span> <span class="title class_">GameBoySystem</span> !== <span class="string">'undefined'</span> }</span></span><br><span class="line"><span class="language-javascript">      ];</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      components.<span class="title function_">forEach</span>(<span class="function"><span class="params">comp</span> =&gt;</span> {</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (comp.<span class="title function_">check</span>()) {</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">addLog</span>(<span class="string">`✅ <span class="subst">${comp.name}</span> 组件已加载`</span>, <span class="string">'success'</span>);</span></span><br><span class="line"><span class="language-javascript">        } <span class="keyword">else</span> {</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">addLog</span>(<span class="string">`❌ <span class="subst">${comp.name}</span> 组件加载失败`</span>, <span class="string">'error'</span>);</span></span><br><span class="line"><span class="language-javascript">        }</span></span><br><span class="line"><span class="language-javascript">      });</span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">addLog</span>(<span class="string">'🔧 所有组件检查完成，可以开始初始化'</span>, <span class="string">'info'</span>);</span></span><br><span class="line"><span class="language-javascript">    }, <span class="number">500</span>);</span></span><br><span class="line"><span class="language-javascript">  });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 页面卸载时清理</span></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">'beforeunload'</span>, <span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (performanceUpdateInterval) {</span></span><br><span class="line"><span class="language-javascript">      <span class="built_in">clearInterval</span>(performanceUpdateInterval);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">    </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (systemInstance) {</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">stop</span>();</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">  });</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">})();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</details>
<p>效果（点击 <em>初始化系统</em> → <em>切换渲染模式</em> → <em>测试图形渲染</em> → <em>加载演示程序</em> → <em>开始运行</em>）：</p>
<p><img src="/posts/4148/1.png" alt="alt text"></p>
<h2 id="58-全局系统控制接口"><a class="markdownIt-Anchor" href="#58-全局系统控制接口"></a> 5.8. 全局系统控制接口</h2>
<p>为了方便外部访问和调试，我们写一个统一的全局的系统控制接口：</p>
<figure class="highlight javascript"><figcaption><span>gameboy.JS</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局系统控制函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">GameBoySystemController</span> = {</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 初始化系统</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="keyword">if</span> (!gameBoySystem) {</span><br><span class="line">				gameBoySystem = <span class="keyword">new</span> <span class="title class_">GameBoySystem</span>();</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="keyword">await</span> gameBoySystem.<span class="title function_">initialize</span>();</span><br><span class="line">			<span class="variable language_">window</span>.<span class="property">GameBoySystem</span> = gameBoySystem; <span class="comment">// 全局引用</span></span><br><span class="line">			<span class="keyword">return</span> gameBoySystem;</span><br><span class="line">		} <span class="keyword">catch</span> (error) {</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'❌ 系统初始化失败:'</span>, error);</span><br><span class="line">			<span class="keyword">throw</span> error;</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取系统实例</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">getInstance</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">return</span> gameBoySystem;</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 重置系统</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">reset</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			gameBoySystem.<span class="title function_">reset</span>();</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 启动系统</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">start</span>(<span class="params">mode</span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			gameBoySystem.<span class="title function_">start</span>(mode);</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 停止系统</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">stop</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			gameBoySystem.<span class="title function_">stop</span>();</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 暂停/恢复</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">togglePause</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			gameBoySystem.<span class="title function_">togglePause</span>();</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载 ROM</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">loadROM</span>(<span class="params">romData</span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">await</span> gameBoySystem.<span class="title function_">loadROM</span>(romData);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 加载演示</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">loadDemo</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			<span class="keyword">return</span> gameBoySystem.<span class="title function_">loadDemo</span>();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取状态</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">getStatus</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			<span class="keyword">return</span> gameBoySystem.<span class="title function_">getStatus</span>();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取调试信息</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title function_">getDebugInfo</span>(<span class="params"></span>) {</span><br><span class="line">		<span class="keyword">if</span> (gameBoySystem) {</span><br><span class="line">			<span class="keyword">return</span> gameBoySystem.<span class="title function_">getDebugInfo</span>();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'系统未初始化'</span>;</span><br><span class="line">	}</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>这个控制器接口使得前端可以通过简洁的 API 来操作整个模拟器系统，同时在浏览器控制台中也可以直接调用这些方法进行调试：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在浏览器控制台中</span></span><br><span class="line"><span class="keyword">const</span> system = <span class="variable language_">window</span>.<span class="property">GameBoySystemController</span>.<span class="title function_">getInstance</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看系统状态</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(system.<span class="title function_">getStatus</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试寄存器</span></span><br><span class="line">system.<span class="property">gpu</span>.<span class="title function_">writeRegister</span>(<span class="number">0xFF43</span>, <span class="number">50</span>); <span class="comment">// 设置水平滚动</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(system.<span class="property">gpu</span>.<span class="title function_">readRegister</span>(<span class="number">0xFF43</span>)); <span class="comment">// 读取确认</span></span><br></pre></td></tr></tbody></table></figure>
<p><img src="/posts/4148/2.png" alt="alt text"></p>
</body></html></div></article></div></main><footer><div class="paginator"><a class="prev" href="d601.html">上一篇</a><a class="next" href="5e08.html">下一篇</a></div><div class="copyright"><p>© 2025 <a href="https://cytrogen.icu">Cytrogen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/cytrogen/hexo-theme-ares" target="_blank">hexo-theme-ares</a>.</p></div></footer></div></div><a class="back-to-top" href="#top" aria-label="返回顶部"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M3.293 9.707a1 1 0 010-1.414L9.586 2a2 2 0 012.828 0l6.293 6.293a1 1 0 01-1.414 1.414L11 3.414V17a1 1 0 11-2 0V3.414L2.707 9.707a1 1 0 01-1.414 0z"></path></svg></a><script>document.addEventListener('DOMContentLoaded', function() {
  const codeBlocks = document.querySelectorAll('figure.highlight');
  
  codeBlocks.forEach(block => {
    let caption = block.querySelector('figcaption');
    if (!caption) {
      caption = document.createElement('figcaption');
      block.insertBefore(caption, block.firstChild);
    }

    const info = document.createElement('div');
    info.className = 'info';
    
    const filename = caption.querySelector('span');
    if (filename) {
      filename.className = 'filename';
      info.appendChild(filename);
    }
    
    const lang = block.className.split(' ')[1];
    if (lang) {
      const langSpan = document.createElement('span');
      langSpan.className = 'lang-name';
      langSpan.textContent = lang;
      info.appendChild(langSpan);
    }

    const sourceLink = caption.querySelector('a');
    if (sourceLink) {
      sourceLink.className = 'source-link';
      info.appendChild(sourceLink);
    }

    const actions = document.createElement('div');
    actions.className = 'actions';

    const codeHeight = block.scrollHeight;
    const threshold = 300;

    if (codeHeight > threshold) {
      block.classList.add('folded');
      
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = '展开';
      toggleBtn.addEventListener('click', () => {
        block.classList.toggle('folded');
        toggleBtn.textContent = block.classList.contains('folded') ? '展开' : '折叠';
      });
      actions.appendChild(toggleBtn);
    }

    const copyBtn = document.createElement('button');
    copyBtn.textContent = '复制';
    copyBtn.addEventListener('click', async () => {
      const codeLines = block.querySelectorAll('.code .line');
      const code = Array.from(codeLines)
        .map(line => line.textContent)
        .join('\n')
        .replace(/\n\n/g, '\n');
      
      try {
        await navigator.clipboard.writeText(code);
        copyBtn.textContent = '已复制';
        copyBtn.classList.add('copied');
        
        setTimeout(() => {
          copyBtn.textContent = '复制';
          copyBtn.classList.remove('copied');
        }, 3000);
      } catch (err) {
        console.error('复制失败:', err);
        copyBtn.textContent = '复制失败';
        
        setTimeout(() => {
          copyBtn.textContent = '复制';
        }, 3000);
      }
    });
    actions.appendChild(copyBtn);

    caption.innerHTML = '';
    caption.appendChild(info);
    caption.appendChild(actions);

    const markedLines = block.getAttribute('data-marked-lines');
    if (markedLines) {
      const lines = markedLines.split(',');
      lines.forEach(range => {
        if (range.includes('-')) {
          const [start, end] = range.split('-').map(Number);
          for (let i = start; i <= end; i++) {
            const line = block.querySelector(`.line-${i}`);
            if (line) line.classList.add('marked');
          }
        } else {
          const line = block.querySelector(`.line-${range}`);
          if (line) line.classList.add('marked');
        }
      });
    }
  });
});</script><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script><script>(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.querySelector('.theme-toggle');
    
    if (!themeToggle) return;
    
    const getCurrentTheme = () => {
      return document.documentElement.getAttribute('data-theme') || 'light';
    };
    
    const updateUI = (theme) => {
      const isDark = theme === 'dark';
      themeToggle.setAttribute('aria-pressed', isDark.toString());
    };
    
    const setTheme = (theme) => {
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.style.colorScheme = theme;
      
      const pageWrapper = document.getElementById('page-wrapper');
      if (pageWrapper) {
        pageWrapper.setAttribute('data-theme', theme);
      }
      
      // Find and remove the temporary anti-flicker style tag if it exists.
      // This ensures the main stylesheet takes full control after the initial load.
      const antiFlickerStyle = document.getElementById('anti-flicker-style');
      if (antiFlickerStyle) {
        antiFlickerStyle.remove();
      }
      
      localStorage.setItem('theme', theme);
      updateUI(theme);
    };
    
    const toggleTheme = () => {
      const current = getCurrentTheme();
      const newTheme = current === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    };
    
    updateUI(getCurrentTheme());
    
    themeToggle.addEventListener('click', toggleTheme);
    
    if (window.matchMedia) {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addEventListener('change', function(e) {
        if (!localStorage.getItem('theme')) {
          const theme = e.matches ? 'dark' : 'light';
          setTheme(theme);
        }
      });
    }
  });
})();
</script><script>(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const backToTopBtn = document.querySelector('.back-to-top');
    
    if (!backToTopBtn) return;
    
    const toggleButtonVisibility = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const shouldShow = scrollTop > 200;
      
      if (shouldShow) {
        backToTopBtn.classList.add('is-visible');
      } else {
        backToTopBtn.classList.remove('is-visible');
      }
    };
    
    let ticking = false;
    const handleScroll = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          toggleButtonVisibility();
          ticking = false;
        });
        ticking = true;
      }
    };
    
    const scrollToTop = (event) => {
      event.preventDefault();
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    };
    
    window.addEventListener('scroll', handleScroll);
    backToTopBtn.addEventListener('click', scrollToTop);
    
    toggleButtonVisibility();
  });
})();
</script><script>(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const isListPage = document.querySelector('ul.home.post-list');
    
    if (!isListPage) {
      const replyWrappers = document.querySelectorAll('.reply-content-wrapper');
      replyWrappers.forEach(wrapper => {
        const textOnly = wrapper.querySelector('.reply-text-only');
        const microformats = wrapper.querySelector('.reply-microformats');
        
        if (textOnly) textOnly.style.display = 'none';
        if (microformats) microformats.style.display = 'block';
      });
    }
  });
})();</script></body></html>