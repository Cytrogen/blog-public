<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>JS逆向网易云音乐 · Cytrogen 的个人博客</title><meta name="description" content="本文是一篇网易云音乐网页版 API 的逆向分析实战教程，旨在解决如何获取歌曲真实 .m4a 播放链接的问题。教程通过浏览器开发者工具，一步步追踪并剖析了其核心加密参数 params 和 encSecKey 的生成过程，深入分析了背后涉及的 AES 和 RSA 加密算法。最终，通过 Python 结合 PyExecJS 库调用复现的 JavaScript 加密逻辑，成功构造请求并获取到歌曲链接，同时还逆向了歌曲搜索接口。本文为对网页逆向、API分析和加解密技术感兴趣的开发者提供了一次完整的实战演练。"><link rel="icon" href="../favicon.png"><link rel="preload" href="../fonts/opensans-regular-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous"><style>@font-face {
  font-family: 'Open Sans';
  src: url('../fonts/opensans-regular-latin.woff2') format('woff2');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  size-adjust: 107%;
  ascent-override: 97%;
  descent-override: 25%;
  line-gap-override: 0%;
}
</style><link rel="stylesheet" href="../css/ares.css"><script>(function() {
  const getInitialTheme = () => {
    const saved = localStorage.getItem('theme');
    if (saved && (saved === 'light' || saved === 'dark')) {
      return saved;
    }
    
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    
    return 'light';
  };
  
  const theme = getInitialTheme();
  document.documentElement.setAttribute('data-theme', theme);
  
  document.documentElement.style.colorScheme = theme;
  
  // Add anti-flicker style for dark mode
  if (theme === 'dark') {
    const style = document.createElement('style');
    style.id = 'anti-flicker-style';
    style.innerHTML = `
      #page-wrapper[data-theme="dark"] {
        background-color: #0f172a;
        color: #f1f5f9;
      }
    `;
    document.head.appendChild(style);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const pageWrapper = document.getElementById('page-wrapper');
    if (pageWrapper) {
      pageWrapper.setAttribute('data-theme', theme);
    }
  });
})();

</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="Cytrogen 的个人博客" type="application/atom+xml">
</head><body><div id="page-wrapper"><a class="skip-link" href="#main-content">跳到主要内容</a><div class="wrap"><header><a class="logo-link" href="../index.html"><img src="../favicon.png" alt="logo"></a><nav class="site-nav"><div class="nav-main"><div class="nav-primary"><ul class="nav-list hidden-mobile"><li class="nav-item"><a class="nav-link" href="../index.html">首页</a></li></ul><div class="nav-tools"><div class="language-menu"><button class="language-toggle" type="button"><svg class="icon icon-globe" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855A7.97 7.97 0 0 0 10.855 12H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"></path></svg><span>中文</span></button><div class="language-dropdown"></div></div></div><div class="nav-controls"><div class="more-menu hidden-mobile"><button class="more-toggle" type="button"><span>更多</span><svg class="icon icon-chevron-down" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" aria-hidden="true" focusable="false"><path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1s.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0s.3.8 0 1.1l-3.3 3.3c-.1.1-.3.2-.5.2z"></path></svg></button><div class="more-dropdown"><ul class="dropdown-list"><li class="dropdown-item"><a class="nav-link" href="../archives">归档</a></li><li class="dropdown-item"><a class="nav-link" href="../categories">分类</a></li><li class="dropdown-item"><a class="nav-link" href="../tags">标签</a></li><li class="dropdown-item"><a class="nav-link" href="../about">关于</a></li><li class="dropdown-item"><a class="nav-link" href="../friends">友链</a></li><li class="dropdown-item"><a class="nav-link" href="../atom.xml">RSS订阅</a></li><li class="dropdown-item"><a class="dropdown-link" href="https://portfolio.cytrogen.icu" target="_blank" rel="noopener noreferrer">作品集<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li><li class="dropdown-item"><a class="dropdown-link" href="https://github.com/cytrogen" target="_blank" rel="noopener noreferrer">GitHub<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li></ul></div></div><div class="theme-switcher"><button class="theme-toggle" type="button" role="switch" aria-pressed="false" aria-label="切换主题"><div class="theme-icon moon-icon"><svg class="icon icon-moon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path></svg></div><div class="theme-icon sun-icon"><svg class="icon icon-sun" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></svg></div></button></div><details class="mobile-menu-details hidden-desktop"><summary class="hamburger-menu" aria-label="nav.menu"><svg class="icon icon-bars" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" focusable="false"><path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"></path></svg><span class="menu-text">nav.menu</span></summary><div class="mobile-menu-dropdown"><ul class="mobile-nav-list"><li class="mobile-nav-item"><a class="mobile-nav-link" href="../index.html">首页</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../archives">归档</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../categories">分类</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../tags">标签</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../about">关于</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../friends">友链</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="../atom.xml">RSS订阅</a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="https://portfolio.cytrogen.icu" target="_blank" rel="noopener noreferrer">作品集<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li><li class="mobile-nav-item"><a class="mobile-nav-link" href="https://github.com/cytrogen" target="_blank" rel="noopener noreferrer">GitHub<svg class="icon icon-external-link" width="14" height="14" viewBox="0 0 14 14" fill="currentColor" aria-hidden="true" focusable="false"><path d="M8.636 2.364A1 1 0 0 1 10 1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L10.586 2H9a1 1 0 0 1-1.364-1.636zM2 3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V9a1 1 0 1 1 2 0v3a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h3a1 1 0 1 1 0 2H2z"></path></svg></a></li></ul></div></details></div></div></div></nav></header><main class="container" id="main-content" tabindex="-1"><div class="post"><article class="post-block"><h1 class="post-title">JS逆向网易云音乐</h1><div class="post-info">11/27/2023</div><div class="post-content"><p>该文章记录了我如何逆向网易云<s>并制作一个简易的播放器（鸽了）</s>。</p>
<span id="more"></span>
<h1 id="逆向网易云"><a class="markdownIt-Anchor" href="#逆向网易云"></a> 逆向网易云</h1>
<p>用浏览器打开网易云的网站，随意挑选一首歌曲进行播放，同时检查网络选项卡中的响应。我们能看到媒体类型中有一个<code>.m4a</code>文件。直接用Python的requests爬取下来进行播放，够厚道，爬下来就能听。</p>
<p><img src="/posts/f8ce/1.png" alt><br>
<img src="/posts/f8ce/2.png" alt></p>
<p>当然在页面源代码里找这个<code>.m4a</code>文件是找不到的，不然也不会说要<strong>逆向</strong>网易云了。我们该如何找到这个<code>.m4a</code>文件的URL呢？继续看看网络选项卡里的请求：</p>
<p><img src="/posts/f8ce/3.png" alt></p>
<p>赫然出现这么一个请求，返回的JSON数据中有<code>.m4a</code>的链接。嗯，就是你了！看看负载：</p>
<p><img src="/posts/f8ce/4.png" alt></p>
<p><code>csrf_token</code>为空，重点是表单数据的<code>params</code>和<code>encSecKey</code>。其中的内容都是一大串反正不是明文的东西，那么逆向的目标就是找到这两个参数的生成方式。</p>
<p>原本想要直接在源代码里一个个找过去这两个参数，后来突然想到客户端反正都会朝<code>https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=</code>发送请求，那么直接在XHR/提取断点里选择所有包含着<code>v1?csrf_token=</code>的URL不就行了。</p>
<p>关注<code>arguments</code>的构造此时成为了我们的目标。</p>
<p><img src="/posts/f8ce/5.png" alt></p>
<p>用调用堆栈陆续向上查看，发现<code>params</code>和<code>encSecKey</code>依旧是加密过后的。哎，加把劲吧，继续向上查看。</p>
<p><img src="/posts/f8ce/6.png" alt></p>
<p>一直到这一步……观察其前面的代码能发现一个非常有意思的事情：</p>
<p><img src="/posts/f8ce/7.png" alt></p>
<ol>
<li>变量<code>bKC1x</code>被赋值</li>
<li><code>e1x.data</code>被赋值时，<code>bKC1x</code>被用到了，参数中还赫然写着<code>params</code>和<code>encSecKey</code></li>
<li>根据我们之前查看的调用堆栈，<code>chF5K(X2x, e1x)</code>的第二个参数必定是<code>params</code>和<code>encSecKey</code>的组合</li>
</ol>
<p>这说明什么？说明<code>bKC1x</code>就是生成<code>params</code>和<code>encSecKey</code>的关键！我们仔细分析一下它的构造：</p>
<pre><code class="language-js">var bKC1x = window.asrsea(JSON.stringify(i1x), bvh3x([&quot;流泪&quot;, &quot;强&quot;]), bvh3x(Rf5k.md), bvh3x([&quot;爱心&quot;, &quot;女孩&quot;, &quot;惊恐&quot;, &quot;大笑&quot;]));</code></pre>
<p>其中第三个参数所使用的<code>Rf5k.md</code>的内容如下：</p>
<p><img src="/posts/f8ce/10.png" alt></p>
<blockquote>
<p>很想吐槽……这些字符串的意义是什么？？？</p>
</blockquote>
<p><code>bKC1x</code>本身会生成一个字典，其中包含<code>encText</code>和<code>encSecKey</code>两个键。而屡次出现的<code>bvh3x()</code>函数的构造如下：</p>
<pre><code class="language-js">var bvh3x = function(chL5Q) &#123;
    var m1x = [];
    j1x.bg2x(chL5Q, function(chK5P) &#123;
        m1x.push(Rf5k.emj[chK5P])
    &#125;);
    return m1x.join(&quot;&quot;)
&#125;;</code></pre>
<p><img src="/posts/f8ce/8.png" alt></p>
<p>它的运作差不多是这样子的。</p>
<p><code>Rf5k.emj</code>是一个字典，构造非常激寒：</p>
<p><img src="/posts/f8ce/9.png" alt></p>
<blockquote>
<p>……谁来告诉我这些键到底都是什么意思？？？</p>
</blockquote>
<p>也就是说<code>bvh3x()</code>函数接收参数，按照每个元素的字符串、对比<code>Rf5k.emj</code>字典中的键来返回对应的值，最后拼接成一个列表。</p>
<p>知道了<code>bKC1x</code>中后三个参数的生成方式，我们便只需要知道第一个参数——<code>JSON.stringify(i1x)</code>——是什么来头的了：</p>
<p><img src="/posts/f8ce/11.png" alt></p>
<p>手到擒来，这个id不就是歌曲id么？！</p>
<p>参数已经全部知晓，最后要看网易云如何加密它们。<code>window.asrsea()</code>函数作为加密这些参数的老大哥，它的构造如下：</p>
<pre><code class="language-js">function d(d, e, f, g) &#123;
    var h = &#123;&#125;
        , i = a(16);
    return h.encText = b(d, g),
    h.encText = b(h.encText, i),
    h.encSecKey = c(i, e, f),
    h
&#125;</code></pre>
<p><code>d()</code>函数需要好好说道说道。接收的四个参数我们已述说过，这里不废话了。<code>d()</code>先创建了一个空字典<code>h</code>，接着创建了一个<code>i</code>。要知道<code>i</code>的值，我们需要知道<code>a()</code>的内容：</p>
<pre><code class="language-js">function a(a) &#123;
    var d, e, b = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;, c = &quot;&quot;;
    for (d = 0; a &gt; d; d += 1)
        e = Math.random() * b.length,
        e = Math.floor(e),
        c += b.charAt(e);
    return c
&#125;</code></pre>
<ul>
<li>变量<code>d</code>、<code>e</code>、<code>b</code>都是字符串</li>
<li><code>for</code>循环中<code>d</code>变成整数0，每次循环加1，直到<code>a</code>的值，也就是上面<code>d()</code>函数中传入的整数16</li>
<li><code>e</code>在每次循环都是一个随机数，有着<code>b</code>的长度，并且会被<code>Math.floor()</code>函数取整</li>
<li><code>c</code>是一个空字符串，每次循环都会被<code>b</code>的第<code>e</code>个字符所填充</li>
</ul>
<p>用人话来说便是：<code>a()</code>函数会<strong>生成一个长度为16的随机字符串</strong>。</p>
<p>回到<code>d()</code>函数，<code>h.encText</code>的值是<code>b(d, g)</code>，而<code>b()</code>函数的构造如下：</p>
<pre><code class="language-js">function b(a, b) &#123;
    var c = CryptoJS.enc.Utf8.parse(b)
        , d = CryptoJS.enc.Utf8.parse(&quot;0102030405060708&quot;)
        , e = CryptoJS.enc.Utf8.parse(a)
        , f = CryptoJS.AES.encrypt(e, c, &#123;
        iv: d,
        mode: CryptoJS.mode.CBC
    &#125;);
    return f.toString()
&#125;</code></pre>
<blockquote>
<p><code>CryptoJS</code>是一个JavaScript的加密算法库，这里不做过多介绍，后面会讲到如何引用。</p>
</blockquote>
<p>该函数先是声明了变量<code>c</code>、<code>d</code>和<code>e</code>这三个由不同的值被UTF-8编码后的字符串。接着声明了变量<code>f</code>——一个由AES.CBC模式加密的<code>e</code>——其密钥为<code>c</code>、偏移量为<code>d</code>。返回的<code>f</code>的字符串形式最终变成了我们的<code>encText</code>。</p>
<p>值得注意的是，在<code>d()</code>函数里，<code>h.encText</code><strong>又</strong>被塞进<code>b()</code>函数里加密了一次。</p>
<p>而<code>h.encSecKey</code>由<code>c()</code>函数生成，它的构造如下：</p>
<pre><code class="language-js">function c(a, b, c) &#123;
    var d, e;
    return setMaxDigits(131),
    d = new RSAKeyPair(b,&quot;&quot;,c),
    e = encryptedString(d, a)
&#125;</code></pre>
<p>在<code>c()</code>函数里，先是调用了<code>setMaxDigits()</code>函数；这个函数接收一个需要加密的字符串<code>a</code>，一个公钥<code>b</code>，以及生成RSA密钥对所需的另一个参数<code>c</code>。它先是使用 <code>setMaxDigits()</code>函数设置了<code>BigInt</code>可操作的最大位数为131。然后使用提供的公钥<code>b</code>和参数<code>c</code>生成RSA密钥对<code>d</code>。最后，它使用生成的密钥对加密了字符串<code>a</code>。</p>
<p>问题又双叒叕来了，什么是<code>setMaxDigits()</code>？什么是<code>BigInt</code>？莫急，再再再来看一眼网易云的源代码：</p>
<p><img src="/posts/f8ce/12.png" alt></p>
<p><code>setMaxDigits()</code>和以上提到的函数们有一个天大的区别：它是全局函数，无论在哪里都能被调用。而这种全局函数的定义在网易云的源代码中只有一处：第89行。我们可以直接把这第89行的内容全部复制粘贴下来使用。</p>
<details>
<summary>展开</summary>
<pre><code class="language-js">function RSAKeyPair(a, b, c) &#123;
    this.e = biFromHex(a),
    this.d = biFromHex(b),
    this.m = biFromHex(c),
    this.chunkSize = 2 * biHighIndex(this.m),
    this.radix = 16,
    this.barrett = new BarrettMu(this.m)
&#125;
function twoDigit(a) &#123;
    return (10 &gt; a ? &quot;0&quot; : &quot;&quot;) + String(a)
&#125;
function encryptedString(a, b) &#123;
    for (var f, g, h, i, j, k, l, c = new Array, d = b.length, e = 0; d &gt; e; )
        c[e] = b.charCodeAt(e),
        e++;
    for (; 0 != c.length % a.chunkSize; )
        c[e++] = 0;
    for (f = c.length,
    g = &quot;&quot;,
    e = 0; f &gt; e; e += a.chunkSize) &#123;
        for (j = new BigInt,
        h = 0,
        i = e; i &lt; e + a.chunkSize; ++h)
            j.digits[h] = c[i++],
            j.digits[h] += c[i++] &lt;&lt; 8;
        k = a.barrett.powMod(j, a.e),
        l = 16 == a.radix ? biToHex(k) : biToString(k, a.radix),
        g += l + &quot; &quot;
    &#125;
    return g.substring(0, g.length - 1)
&#125;
function decryptedString(a, b) &#123;
    var e, f, g, h, c = b.split(&quot; &quot;), d = &quot;&quot;;
    for (e = 0; e &lt; c.length; ++e)
        for (h = 16 == a.radix ? biFromHex(c[e]) : biFromString(c[e], a.radix),
        g = a.barrett.powMod(h, a.d),
        f = 0; f &lt;= biHighIndex(g); ++f)
            d += String.fromCharCode(255 &amp; g.digits[f], g.digits[f] &gt;&gt; 8);
    return 0 == d.charCodeAt(d.length - 1) &amp;&amp; (d = d.substring(0, d.length - 1)),
    d
&#125;
function setMaxDigits(a) &#123;
    maxDigits = a,
    ZERO_ARRAY = new Array(maxDigits);
    for (var b = 0; b &lt; ZERO_ARRAY.length; b++)
        ZERO_ARRAY[b] = 0;
    bigZero = new BigInt,
    bigOne = new BigInt,
    bigOne.digits[0] = 1
&#125;
function BigInt(a) &#123;
    this.digits = &quot;boolean&quot; == typeof a &amp;&amp; 1 == a ? null : ZERO_ARRAY.slice(0),
    this.isNeg = !1
&#125;
function biFromDecimal(a) &#123;
    for (var d, e, f, b = &quot;-&quot; == a.charAt(0), c = b ? 1 : 0; c &lt; a.length &amp;&amp; &quot;0&quot; == a.charAt(c); )
        ++c;
    if (c == a.length)
        d = new BigInt;
    else &#123;
        for (e = a.length - c,
        f = e % dpl10,
        0 == f &amp;&amp; (f = dpl10),
        d = biFromNumber(Number(a.substr(c, f))),
        c += f; c &lt; a.length; )
            d = biAdd(biMultiply(d, lr10), biFromNumber(Number(a.substr(c, dpl10)))),
            c += dpl10;
        d.isNeg = b
    &#125;
    return d
&#125;
function biCopy(a) &#123;
    var b = new BigInt(!0);
    return b.digits = a.digits.slice(0),
    b.isNeg = a.isNeg,
    b
&#125;
function biFromNumber(a) &#123;
    var c, b = new BigInt;
    for (b.isNeg = 0 &gt; a,
    a = Math.abs(a),
    c = 0; a &gt; 0; )
        b.digits[c++] = a &amp; maxDigitVal,
        a &gt;&gt;= biRadixBits;
    return b
&#125;
function reverseStr(a) &#123;
    var c, b = &quot;&quot;;
    for (c = a.length - 1; c &gt; -1; --c)
        b += a.charAt(c);
    return b
&#125;
function biToString(a, b) &#123;
    var d, e, c = new BigInt;
    for (c.digits[0] = b,
    d = biDivideModulo(a, c),
    e = hexatrigesimalToChar[d[1].digits[0]]; 1 == biCompare(d[0], bigZero); )
        d = biDivideModulo(d[0], c),
        digit = d[1].digits[0],
        e += hexatrigesimalToChar[d[1].digits[0]];
    return (a.isNeg ? &quot;-&quot; : &quot;&quot;) + reverseStr(e)
&#125;
function biToDecimal(a) &#123;
    var c, d, b = new BigInt;
    for (b.digits[0] = 10,
    c = biDivideModulo(a, b),
    d = String(c[1].digits[0]); 1 == biCompare(c[0], bigZero); )
        c = biDivideModulo(c[0], b),
        d += String(c[1].digits[0]);
    return (a.isNeg ? &quot;-&quot; : &quot;&quot;) + reverseStr(d)
&#125;
function digitToHex(a) &#123;
    var b = 15
      , c = &quot;&quot;;
    for (i = 0; 4 &gt; i; ++i)
        c += hexToChar[a &amp; b],
        a &gt;&gt;&gt;= 4;
    return reverseStr(c)
&#125;
function biToHex(a) &#123;
    var d, b = &quot;&quot;;
    for (biHighIndex(a),
    d = biHighIndex(a); d &gt; -1; --d)
        b += digitToHex(a.digits[d]);
    return b
&#125;
function charToHex(a) &#123;
    var h, b = 48, c = b + 9, d = 97, e = d + 25, f = 65, g = 90;
    return h = a &gt;= b &amp;&amp; c &gt;= a ? a - b : a &gt;= f &amp;&amp; g &gt;= a ? 10 + a - f : a &gt;= d &amp;&amp; e &gt;= a ? 10 + a - d : 0
&#125;
function hexToDigit(a) &#123;
    var d, b = 0, c = Math.min(a.length, 4);
    for (d = 0; c &gt; d; ++d)
        b &lt;&lt;= 4,
        b |= charToHex(a.charCodeAt(d));
    return b
&#125;
function biFromHex(a) &#123;
    var d, e, b = new BigInt, c = a.length;
    for (d = c,
    e = 0; d &gt; 0; d -= 4,
    ++e)
        b.digits[e] = hexToDigit(a.substr(Math.max(d - 4, 0), Math.min(d, 4)));
    return b
&#125;
function biFromString(a, b) &#123;
    var g, h, i, j, c = &quot;-&quot; == a.charAt(0), d = c ? 1 : 0, e = new BigInt, f = new BigInt;
    for (f.digits[0] = 1,
    g = a.length - 1; g &gt;= d; g--)
        h = a.charCodeAt(g),
        i = charToHex(h),
        j = biMultiplyDigit(f, i),
        e = biAdd(e, j),
        f = biMultiplyDigit(f, b);
    return e.isNeg = c,
    e
&#125;
function biDump(a) &#123;
    return (a.isNeg ? &quot;-&quot; : &quot;&quot;) + a.digits.join(&quot; &quot;)
&#125;
function biAdd(a, b) &#123;
    var c, d, e, f;
    if (a.isNeg != b.isNeg)
        b.isNeg = !b.isNeg,
        c = biSubtract(a, b),
        b.isNeg = !b.isNeg;
    else &#123;
        for (c = new BigInt,
        d = 0,
        f = 0; f &lt; a.digits.length; ++f)
            e = a.digits[f] + b.digits[f] + d,
            c.digits[f] = 65535 &amp; e,
            d = Number(e &gt;= biRadix);
        c.isNeg = a.isNeg
    &#125;
    return c
&#125;
function biSubtract(a, b) &#123;
    var c, d, e, f;
    if (a.isNeg != b.isNeg)
        b.isNeg = !b.isNeg,
        c = biAdd(a, b),
        b.isNeg = !b.isNeg;
    else &#123;
        for (c = new BigInt,
        e = 0,
        f = 0; f &lt; a.digits.length; ++f)
            d = a.digits[f] - b.digits[f] + e,
            c.digits[f] = 65535 &amp; d,
            c.digits[f] &lt; 0 &amp;&amp; (c.digits[f] += biRadix),
            e = 0 - Number(0 &gt; d);
        if (-1 == e) &#123;
            for (e = 0,
            f = 0; f &lt; a.digits.length; ++f)
                d = 0 - c.digits[f] + e,
                c.digits[f] = 65535 &amp; d,
                c.digits[f] &lt; 0 &amp;&amp; (c.digits[f] += biRadix),
                e = 0 - Number(0 &gt; d);
            c.isNeg = !a.isNeg
        &#125; else
            c.isNeg = a.isNeg
    &#125;
    return c
&#125;
function biHighIndex(a) &#123;
    for (var b = a.digits.length - 1; b &gt; 0 &amp;&amp; 0 == a.digits[b]; )
        --b;
    return b
&#125;
function biNumBits(a) &#123;
    var e, b = biHighIndex(a), c = a.digits[b], d = (b + 1) * bitsPerDigit;
    for (e = d; e &gt; d - bitsPerDigit &amp;&amp; 0 == (32768 &amp; c); --e)
        c &lt;&lt;= 1;
    return e
&#125;
function biMultiply(a, b) &#123;
    var d, h, i, k, c = new BigInt, e = biHighIndex(a), f = biHighIndex(b);
    for (k = 0; f &gt;= k; ++k) &#123;
        for (d = 0,
        i = k,
        j = 0; e &gt;= j; ++j,
        ++i)
            h = c.digits[i] + a.digits[j] * b.digits[k] + d,
            c.digits[i] = h &amp; maxDigitVal,
            d = h &gt;&gt;&gt; biRadixBits;
        c.digits[k + e + 1] = d
    &#125;
    return c.isNeg = a.isNeg != b.isNeg,
    c
&#125;
function biMultiplyDigit(a, b) &#123;
    var c, d, e, f;
    for (result = new BigInt,
    c = biHighIndex(a),
    d = 0,
    f = 0; c &gt;= f; ++f)
        e = result.digits[f] + a.digits[f] * b + d,
        result.digits[f] = e &amp; maxDigitVal,
        d = e &gt;&gt;&gt; biRadixBits;
    return result.digits[1 + c] = d,
    result
&#125;
function arrayCopy(a, b, c, d, e) &#123;
    var g, h, f = Math.min(b + e, a.length);
    for (g = b,
    h = d; f &gt; g; ++g,
    ++h)
        c[h] = a[g]
&#125;
function biShiftLeft(a, b) &#123;
    var e, f, g, h, c = Math.floor(b / bitsPerDigit), d = new BigInt;
    for (arrayCopy(a.digits, 0, d.digits, c, d.digits.length - c),
    e = b % bitsPerDigit,
    f = bitsPerDigit - e,
    g = d.digits.length - 1,
    h = g - 1; g &gt; 0; --g,
    --h)
        d.digits[g] = d.digits[g] &lt;&lt; e &amp; maxDigitVal | (d.digits[h] &amp; highBitMasks[e]) &gt;&gt;&gt; f;
    return d.digits[0] = d.digits[g] &lt;&lt; e &amp; maxDigitVal,
    d.isNeg = a.isNeg,
    d
&#125;
function biShiftRight(a, b) &#123;
    var e, f, g, h, c = Math.floor(b / bitsPerDigit), d = new BigInt;
    for (arrayCopy(a.digits, c, d.digits, 0, a.digits.length - c),
    e = b % bitsPerDigit,
    f = bitsPerDigit - e,
    g = 0,
    h = g + 1; g &lt; d.digits.length - 1; ++g,
    ++h)
        d.digits[g] = d.digits[g] &gt;&gt;&gt; e | (d.digits[h] &amp; lowBitMasks[e]) &lt;&lt; f;
    return d.digits[d.digits.length - 1] &gt;&gt;&gt;= e,
    d.isNeg = a.isNeg,
    d
&#125;
function biMultiplyByRadixPower(a, b) &#123;
    var c = new BigInt;
    return arrayCopy(a.digits, 0, c.digits, b, c.digits.length - b),
    c
&#125;
function biDivideByRadixPower(a, b) &#123;
    var c = new BigInt;
    return arrayCopy(a.digits, b, c.digits, 0, c.digits.length - b),
    c
&#125;
function biModuloByRadixPower(a, b) &#123;
    var c = new BigInt;
    return arrayCopy(a.digits, 0, c.digits, 0, b),
    c
&#125;
function biCompare(a, b) &#123;
    if (a.isNeg != b.isNeg)
        return 1 - 2 * Number(a.isNeg);
    for (var c = a.digits.length - 1; c &gt;= 0; --c)
        if (a.digits[c] != b.digits[c])
            return a.isNeg ? 1 - 2 * Number(a.digits[c] &gt; b.digits[c]) : 1 - 2 * Number(a.digits[c] &lt; b.digits[c]);
    return 0
&#125;
function biDivideModulo(a, b) &#123;
    var f, g, h, i, j, k, l, m, n, o, p, q, r, s, c = biNumBits(a), d = biNumBits(b), e = b.isNeg;
    if (d &gt; c)
        return a.isNeg ? (f = biCopy(bigOne),
        f.isNeg = !b.isNeg,
        a.isNeg = !1,
        b.isNeg = !1,
        g = biSubtract(b, a),
        a.isNeg = !0,
        b.isNeg = e) : (f = new BigInt,
        g = biCopy(a)),
        new Array(f,g);
    for (f = new BigInt,
    g = a,
    h = Math.ceil(d / bitsPerDigit) - 1,
    i = 0; b.digits[h] &lt; biHalfRadix; )
        b = biShiftLeft(b, 1),
        ++i,
        ++d,
        h = Math.ceil(d / bitsPerDigit) - 1;
    for (g = biShiftLeft(g, i),
    c += i,
    j = Math.ceil(c / bitsPerDigit) - 1,
    k = biMultiplyByRadixPower(b, j - h); -1 != biCompare(g, k); )
        ++f.digits[j - h],
        g = biSubtract(g, k);
    for (l = j; l &gt; h; --l) &#123;
        for (m = l &gt;= g.digits.length ? 0 : g.digits[l],
        n = l - 1 &gt;= g.digits.length ? 0 : g.digits[l - 1],
        o = l - 2 &gt;= g.digits.length ? 0 : g.digits[l - 2],
        p = h &gt;= b.digits.length ? 0 : b.digits[h],
        q = h - 1 &gt;= b.digits.length ? 0 : b.digits[h - 1],
        f.digits[l - h - 1] = m == p ? maxDigitVal : Math.floor((m * biRadix + n) / p),
        r = f.digits[l - h - 1] * (p * biRadix + q),
        s = m * biRadixSquared + (n * biRadix + o); r &gt; s; )
            --f.digits[l - h - 1],
            r = f.digits[l - h - 1] * (p * biRadix | q),
            s = m * biRadix * biRadix + (n * biRadix + o);
        k = biMultiplyByRadixPower(b, l - h - 1),
        g = biSubtract(g, biMultiplyDigit(k, f.digits[l - h - 1])),
        g.isNeg &amp;&amp; (g = biAdd(g, k),
        --f.digits[l - h - 1])
    &#125;
    return g = biShiftRight(g, i),
    f.isNeg = a.isNeg != e,
    a.isNeg &amp;&amp; (f = e ? biAdd(f, bigOne) : biSubtract(f, bigOne),
    b = biShiftRight(b, i),
    g = biSubtract(b, g)),
    0 == g.digits[0] &amp;&amp; 0 == biHighIndex(g) &amp;&amp; (g.isNeg = !1),
    new Array(f,g)
&#125;
function biDivide(a, b) &#123;
    return biDivideModulo(a, b)[0]
&#125;
function biModulo(a, b) &#123;
    return biDivideModulo(a, b)[1]
&#125;
function biMultiplyMod(a, b, c) &#123;
    return biModulo(biMultiply(a, b), c)
&#125;
function biPow(a, b) &#123;
    for (var c = bigOne, d = a; ; ) &#123;
        if (0 != (1 &amp; b) &amp;&amp; (c = biMultiply(c, d)),
        b &gt;&gt;= 1,
        0 == b)
            break;
        d = biMultiply(d, d)
    &#125;
    return c
&#125;
function biPowMod(a, b, c) &#123;
    for (var d = bigOne, e = a, f = b; ; ) &#123;
        if (0 != (1 &amp; f.digits[0]) &amp;&amp; (d = biMultiplyMod(d, e, c)),
        f = biShiftRight(f, 1),
        0 == f.digits[0] &amp;&amp; 0 == biHighIndex(f))
            break;
        e = biMultiplyMod(e, e, c)
    &#125;
    return d
&#125;
function BarrettMu(a) &#123;
    this.modulus = biCopy(a),
    this.k = biHighIndex(this.modulus) + 1;
    var b = new BigInt;
    b.digits[2 * this.k] = 1,
    this.mu = biDivide(b, this.modulus),
    this.bkplus1 = new BigInt,
    this.bkplus1.digits[this.k + 1] = 1,
    this.modulo = BarrettMu_modulo,
    this.multiplyMod = BarrettMu_multiplyMod,
    this.powMod = BarrettMu_powMod
&#125;
function BarrettMu_modulo(a) &#123;
    var i, b = biDivideByRadixPower(a, this.k - 1), c = biMultiply(b, this.mu), d = biDivideByRadixPower(c, this.k + 1), e = biModuloByRadixPower(a, this.k + 1), f = biMultiply(d, this.modulus), g = biModuloByRadixPower(f, this.k + 1), h = biSubtract(e, g);
    for (h.isNeg &amp;&amp; (h = biAdd(h, this.bkplus1)),
    i = biCompare(h, this.modulus) &gt;= 0; i; )
        h = biSubtract(h, this.modulus),
        i = biCompare(h, this.modulus) &gt;= 0;
    return h
&#125;
function BarrettMu_multiplyMod(a, b) &#123;
    var c = biMultiply(a, b);
    return this.modulo(c)
&#125;
function BarrettMu_powMod(a, b) &#123;
    var d, e, c = new BigInt;
    for (c.digits[0] = 1,
    d = a,
    e = b; ; ) &#123;
        if (0 != (1 &amp; e.digits[0]) &amp;&amp; (c = this.multiplyMod(c, d)),
        e = biShiftRight(e, 1),
        0 == e.digits[0] &amp;&amp; 0 == biHighIndex(e))
            break;
        d = this.multiplyMod(d, d)
    &#125;
    return c
&#125;
var maxDigits, ZERO_ARRAY, bigZero, bigOne, dpl10, lr10, hexatrigesimalToChar, hexToChar, highBitMasks, lowBitMasks, biRadixBase = 2, biRadixBits = 16, bitsPerDigit = biRadixBits, biRadix = 65536, biHalfRadix = biRadix &gt;&gt;&gt; 1, biRadixSquared = biRadix * biRadix, maxDigitVal = biRadix - 1, maxInteger = 9999999999999998;
setMaxDigits(20),
dpl10 = 15,
lr10 = biFromNumber(1e15),
hexatrigesimalToChar = new Array(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;,&quot;f&quot;,&quot;g&quot;,&quot;h&quot;,&quot;i&quot;,&quot;j&quot;,&quot;k&quot;,&quot;l&quot;,&quot;m&quot;,&quot;n&quot;,&quot;o&quot;,&quot;p&quot;,&quot;q&quot;,&quot;r&quot;,&quot;s&quot;,&quot;t&quot;,&quot;u&quot;,&quot;v&quot;,&quot;w&quot;,&quot;x&quot;,&quot;y&quot;,&quot;z&quot;),
hexToChar = new Array(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;,&quot;f&quot;),
highBitMasks = new Array(0,32768,49152,57344,61440,63488,64512,65024,65280,65408,65472,65504,65520,65528,65532,65534,65535),
lowBitMasks = new Array(0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535);</code></pre>
</details>
<p>至此，整个网易云逆向的思路已清晰。我们可以开始用Python来实现它了。</p>
<h1 id="用js生成数据"><a class="markdownIt-Anchor" href="#用js生成数据"></a> 用JS生成数据</h1>
<p>既然我们已经明白了网易云的加密方式，那么我们就可以先用JS来生成<code>params</code>和<code>encSecKey</code>，然后再传到Python来发出请求。</p>
<blockquote>
<p>我使用的是PyCharm；你可以新建一个<code>.js</code>文件并且使用<code>node.exe</code>来运行JS代码。</p>
</blockquote>
<p>首要的便是引入<code>CryptoJS</code>，与Python导包一样，我们需要先下载它。在终端中输入：</p>
<pre><code class="language-bash">npm install crypto-js</code></pre>
<p>之后便是引入它：</p>
<pre><code class="language-js">var CryptoJS = require(&quot;crypto-js&quot;);</code></pre>
<p>接着复制粘贴之前说的那一大串全局函数以及<code>a()</code>、<code>b()</code>、<code>c()</code>、<code>d()</code>函数下去。</p>
<p><code>d()</code>函数所需要的变量中有三个是固定的，我们可以先定义好：</p>
<pre><code class="language-js">key_2 = &#x27;010001&#x27;;
key_3 = &#x27;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&#x27;;
key_4 = &#x27;0CoJUm6Qyw8W8jud&#x27;;</code></pre>
<p>而第一个参数中歌曲的id是动态的，我们可以先填写一个固定的id进去：</p>
<pre><code class="language-js">key_1 = &#x27;&#123;&quot;ids&quot;: &quot;[2094817741]&quot;, &quot;level&quot;: &quot;standard&quot;, &quot;encodeType&quot;: &quot;aac&quot;, &quot;csrf_token&quot;: &quot;&quot;&#125;&#x27;</code></pre>
<p>最后打印一下结果：</p>
<pre><code class="language-js">console.log(d(key_1, key_2, key_3, key_4));</code></pre>
<p><code>params</code>和<code>encSecKey</code>就这么简单地生成出来了。不过仅是生成出来是不够的，我们还需要把它们传到Python里去。</p>
<h1 id="用python发出请求"><a class="markdownIt-Anchor" href="#用python发出请求"></a> 用Python发出请求</h1>
<p>为了让Python那边取到的数据即拿即用，我悄咪咪地加了一个函数：</p>
<pre><code class="language-js">function main(key) &#123;
    result = d(key, key_2, key_3, key_4);
    return &#123;
        &#x27;params&#x27;: result[&#x27;encText&#x27;],
        &#x27;encSecKey&#x27;: result[&#x27;encSecKey&#x27;]
    &#125;
&#125;</code></pre>
<blockquote>
<p>参数<code>key</code>的内容会在Python中进行修改。</p>
</blockquote>
<p>那么要如何让Python调用这个函数呢？我们可以使用<code>PyExecJS</code>这个库：</p>
<pre><code class="language-python">import execjs

js_code = open(&#x27;文件.js&#x27;, mode=&#x27;r&#x27;, encoding=&#x27;utf-8&#x27;).read()
ctx = execjs.compile(js_code)</code></pre>
<p>这样我们便可以调用<code>.js</code>文件中的<code>main()</code>函数了：</p>
<pre><code class="language-python">song_id = input(&#x27;输入歌曲id：&#x27;)
key = &#x27;&#123;&quot;ids&quot;: &quot;[%s]&quot;, &quot;level&quot;: &quot;standard&quot;, &quot;encodeType&quot;: &quot;aac&quot;, &quot;csrf_token&quot;: &quot;&quot;&#125;&#x27; % song_id
result = ctx.call(&#x27;main&#x27;, key)</code></pre>
<p>给网易云发送请求：</p>
<pre><code class="language-python">form_data = &#123;
    &#x27;params&#x27;: result[&#x27;params&#x27;],
    &#x27;encSecKey&#x27;: result[&#x27;encSecKey&#x27;]
&#125;
response = requests.post(
    url=&#x27;https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&#x27;,
    headers=headers,  # 自己定义
    data=form_data
).json()
m4a_url = response[&#x27;data&#x27;][0][&#x27;url&#x27;]</code></pre>
<p>拿到了我们的<code>.m4a</code>链接后，该怎么做嘛……我想也不用多说了吧。</p>
<pre><code class="language-python">m4a_response = requests.get(m4a_url, headers=headers).content
if not os.path.exists(&#x27;music&#x27;):
    os.mkdir(&#x27;music&#x27;)
with open(&#x27;music/%s.m4a&#x27; % song_id, mode=&#x27;wb&#x27;) as fp:
    fp.write(m4a_response)</code></pre>
<p>网易云逆向大功告成！</p>
<h1 id="顺便逆向个歌曲id不过分吧"><a class="markdownIt-Anchor" href="#顺便逆向个歌曲id不过分吧"></a> 顺便逆向个歌曲id不过分吧</h1>
<p>在网易云中，当用户进行搜索时会出现这么一个请求：<code>https://music.163.com/weapi/search/suggest/web?csrf_token=</code>。和<code>.m4a</code>文件请求一样，这个请求也需要<code>params</code>和<code>encSecKey</code>两个参数。我们可以使用同样的方法来生成它们。</p>
<p>该请求会根据用户输入的关键词返回搜索结果：</p>
<pre><code class="language-python">title = input(&#x27;请输入歌曲名：&#x27;)
search_key = &#x27;&#123;&quot;s&quot;: &quot;%s&quot;, &quot;limit&quot;: &quot;8&quot;, &quot;csrf_token&quot;: &quot;&quot;&#125;&#x27; % title
result = ctx.call(&#x27;main&#x27;, search_key)</code></pre>
<p>然后我们就可以拿到搜索结果了：</p>
<pre><code class="language-python">response = requests.post(
    url=&#x27;https://music.163.com/weapi/search/suggest/web?csrf_token=&#x27;,
    params=result,
    headers=headers
).json()
return response[&#x27;result&#x27;][&#x27;songs&#x27;]  # 返回歌曲列表，response[&#x27;result&#x27;][&#x27;songs&#x27;][数字][&#x27;id&#x27;]就是我们上面自己定义的song_id，完全可以串起来用</code></pre></div></article></div></main><footer><div class="paginator"><a class="prev" href="2f6a.html">上一篇</a><a class="next" href="a4b5.html">下一篇</a></div><div class="copyright"><p>© 2022 - 2025 <a href="https://cytrogen.icu">Cytrogen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/cytrogen/hexo-theme-ares" target="_blank">hexo-theme-ares</a>.</p></div></footer></div></div><a class="back-to-top" href="#top" aria-label="返回顶部"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M3.293 9.707a1 1 0 010-1.414L9.586 2a2 2 0 012.828 0l6.293 6.293a1 1 0 01-1.414 1.414L11 3.414V17a1 1 0 11-2 0V3.414L2.707 9.707a1 1 0 01-1.414 0z"></path></svg></a><script>document.addEventListener('DOMContentLoaded', function() {
  const codeBlocks = document.querySelectorAll('figure.highlight');
  
  codeBlocks.forEach(block => {
    let caption = block.querySelector('figcaption');
    if (!caption) {
      caption = document.createElement('figcaption');
      block.insertBefore(caption, block.firstChild);
    }

    const info = document.createElement('div');
    info.className = 'info';
    
    const filename = caption.querySelector('span');
    if (filename) {
      filename.className = 'filename';
      info.appendChild(filename);
    }
    
    const lang = block.className.split(' ')[1];
    if (lang) {
      const langSpan = document.createElement('span');
      langSpan.className = 'lang-name';
      langSpan.textContent = lang;
      info.appendChild(langSpan);
    }

    const sourceLink = caption.querySelector('a');
    if (sourceLink) {
      sourceLink.className = 'source-link';
      info.appendChild(sourceLink);
    }

    const actions = document.createElement('div');
    actions.className = 'actions';

    const codeHeight = block.scrollHeight;
    const threshold = 300;

    if (codeHeight > threshold) {
      block.classList.add('folded');
      
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = '展开';
      toggleBtn.addEventListener('click', () => {
        block.classList.toggle('folded');
        toggleBtn.textContent = block.classList.contains('folded') ? '展开' : '折叠';
      });
      actions.appendChild(toggleBtn);
    }

    const copyBtn = document.createElement('button');
    copyBtn.textContent = '复制';
    copyBtn.addEventListener('click', async () => {
      const codeLines = block.querySelectorAll('.code .line');
      const code = Array.from(codeLines)
        .map(line => line.textContent)
        .join('\n')
        .replace(/\n\n/g, '\n');
      
      try {
        await navigator.clipboard.writeText(code);
        copyBtn.textContent = '已复制';
        copyBtn.classList.add('copied');
        
        setTimeout(() => {
          copyBtn.textContent = '复制';
          copyBtn.classList.remove('copied');
        }, 3000);
      } catch (err) {
        console.error('复制失败:', err);
        copyBtn.textContent = '复制失败';
        
        setTimeout(() => {
          copyBtn.textContent = '复制';
        }, 3000);
      }
    });
    actions.appendChild(copyBtn);

    caption.innerHTML = '';
    caption.appendChild(info);
    caption.appendChild(actions);

    const markedLines = block.getAttribute('data-marked-lines');
    if (markedLines) {
      const lines = markedLines.split(',');
      lines.forEach(range => {
        if (range.includes('-')) {
          const [start, end] = range.split('-').map(Number);
          for (let i = start; i <= end; i++) {
            const line = block.querySelector(`.line-${i}`);
            if (line) line.classList.add('marked');
          }
        } else {
          const line = block.querySelector(`.line-${range}`);
          if (line) line.classList.add('marked');
        }
      });
    }
  });
});</script><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-4PVPZXE0QQ"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4PVPZXE0QQ');</script><script>(function() {
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.querySelector('.theme-toggle');
    
    if (!themeToggle) return;
    
    // Get current theme
    const getCurrentTheme = () => {
      return document.documentElement.getAttribute('data-theme') || 'light';
    };
    
    // Update UI to match current theme
    const updateUI = (theme) => {
      const isDark = theme === 'dark';
      themeToggle.setAttribute('aria-pressed', isDark.toString());
    };
    
    // Simplified theme setter - CSS handles all animations
    const setTheme = (theme) => {
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.style.colorScheme = theme; // Update native UI elements
      
      // Also update page-wrapper for animation support
      const pageWrapper = document.getElementById('page-wrapper');
      if (pageWrapper) {
        pageWrapper.setAttribute('data-theme', theme);
      }
      
      // Find and remove the temporary anti-flicker style tag if it exists.
      // This ensures the main stylesheet takes full control after the initial load.
      const antiFlickerStyle = document.getElementById('anti-flicker-style');
      if (antiFlickerStyle) {
        antiFlickerStyle.remove();
      }
      
      localStorage.setItem('theme', theme);
      updateUI(theme);
    };
    
    // Simple theme toggle - letting CSS handle the smooth transitions
    const toggleTheme = () => {
      const current = getCurrentTheme();
      const newTheme = current === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    };
    
    // Initialize UI on page load
    updateUI(getCurrentTheme());
    
    // Add click event listener
    themeToggle.addEventListener('click', toggleTheme);
    
    // Listen for system theme changes
    if (window.matchMedia) {
      const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQuery.addEventListener('change', function(e) {
        // Only update if no manual preference is saved
        if (!localStorage.getItem('theme')) {
          const theme = e.matches ? 'dark' : 'light';
          setTheme(theme);
        }
      });
    }
  });
})();
</script><script>(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const backToTopBtn = document.querySelector('.back-to-top');
    
    if (!backToTopBtn) return;
    
    // Show/hide button based on scroll position
    const toggleButtonVisibility = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const shouldShow = scrollTop > 200; // Show after scrolling 200px
      
      if (shouldShow) {
        backToTopBtn.classList.add('is-visible');
      } else {
        backToTopBtn.classList.remove('is-visible');
      }
    };
    
    // Throttle scroll events for better performance
    let ticking = false;
    const handleScroll = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          toggleButtonVisibility();
          ticking = false;
        });
        ticking = true;
      }
    };
    
    // Smooth scroll to top when clicked
    const scrollToTop = (event) => {
      event.preventDefault();
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    };
    
    // Add event listeners
    window.addEventListener('scroll', handleScroll);
    backToTopBtn.addEventListener('click', scrollToTop);
    
    // Check initial scroll position
    toggleButtonVisibility();
  });
})();</script></body></html>