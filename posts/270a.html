<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>React + NestJS购物平台练习【5】用户登录功能 · Cytrogen 的个人博客</title><meta name="description" content="本文是 React + NestJS 全栈购物平台实践的第五篇，专注于实现完整的用户登录功能。前端部分，教程详细讲解了如何使用 Formik 和 Yup 构建登录表单，并结合 React Query 和 Zustand 实现“记住我”功能与自动登录检查。后端部分，则深入实现了基于 JWT 的双令牌（Access Token + Refresh Token）认证机制，包括令牌的生成、验证、刷新和注销。本教程为构建一个安全、用户体验友好的全栈登录系统提供了从前端交互到后端认证的完整实战指南。"><link rel="icon" href="../favicon.png"><link rel="stylesheet" href="../css/ares.css"><link rel="search" type="application/opensearchdescription+xml" href="https://cytrogen.icu/atom.xml" title="Cytrogen 的个人博客"><script src="https://kit.fontawesome.com/0011a09a95.js" crossorigin="anonymous"></script><script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="Cytrogen 的个人博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="../index.html"><img src="../favicon.png" alt="logo"></a><nav class="site-nav"><div class="nav-main"><div class="nav-primary"><ul class="nav-list hidden-mobile"><li class="nav-item"><a class="nav-link" href="../index.html">首页</a></li></ul><div class="nav-tools"><div class="language-menu"><button class="language-toggle" type="button"><i class="fas fa-globe"></i><span>中文</span></button><div class="language-dropdown hidden"></div></div><button id="search-btn" type="button" aria-label="nav.search"><i class="fas fa-search"></i></button></div><div class="nav-controls"><div class="more-menu hidden-mobile"><button class="more-toggle" type="button"><span>更多</span><i class="fas fa-chevron-down"></i></button><div class="more-dropdown hidden"><ul class="dropdown-list"><li class="dropdown-item"><a class="nav-link" href="../archives">归档</a></li><li class="dropdown-item"><a class="nav-link" href="../categories">分类</a></li><li class="dropdown-item"><a class="nav-link" href="../tags">标签</a></li><li class="dropdown-item"><a class="nav-link" href="../about">关于</a></li><li class="dropdown-item"><a class="nav-link" href="../friends">友链</a></li><li class="dropdown-item"><a class="nav-link" href="../atom.xml">RSS订阅</a></li><li class="dropdown-item"><a class="dropdown-link" href="https://portfolio.cytrogen.icu" target="_blank" rel="noopener noreferrer">作品集<i class="fas fa-external-link-alt"></i></a></li><li class="dropdown-item"><a class="dropdown-link" href="https://github.com/cytrogen" target="_blank" rel="noopener noreferrer">GitHub<i class="fas fa-external-link-alt"></i></a></li></ul></div></div><button class="hamburger-menu hidden-desktop" type="button" aria-label="nav.menu"><i class="fas fa-bars"></i></button></div></div></div><div class="search-overlay hidden" id="search-popup"><button class="search-close" id="search-close" type="button" aria-label="search.close"><i class="fas fa-times"></i></button><div class="search-container"><div class="search-input-wrapper"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..."></div><div class="search-result" id="local-search-result"></div></div></div><div class="mobile-menu-container"><div class="menu-header"><button class="menu-close" type="button" aria-label="关闭"><i class="fas fa-times"></i></button></div><div class="menu-content"><ul class="nav-list"><li class="nav-item"><a class="nav-link" href="../index.html">首页</a></li><li class="nav-item"><a class="nav-link" href="../archives">归档</a></li><li class="nav-item"><a class="nav-link" href="../categories">分类</a></li><li class="nav-item"><a class="nav-link" href="../tags">标签</a></li><li class="nav-item"><a class="nav-link" href="../about">关于</a></li><li class="nav-item"><a class="nav-link" href="../friends">友链</a></li><li class="nav-item"><a class="nav-link" href="../atom.xml">RSS订阅</a></li><li class="nav-item"><a class="nav-link" href="https://portfolio.cytrogen.icu" target="_blank" rel="noopener noreferrer">作品集<i class="fas fa-external-link-alt"></i></a></li><li class="nav-item"><a class="nav-link" href="https://github.com/cytrogen" target="_blank" rel="noopener noreferrer">GitHub<i class="fas fa-external-link-alt"></i></a></li></ul></div></div></nav></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">React + NestJS购物平台练习【5】用户登录功能</h1><div class="post-info">2/12/2025</div><div class="post-content"><p>在构建电商平台的过程中，用户登录是一个不可或缺的核心功能。</p>
<p>本文将详细介绍如何在 React 前端实现登录表单组件，并结合 NestJS 后端完成完整的用户认证流程，包括 JWT 认证、记住我功能以及登录状态持久化等关键特性。</p>
<span id="more"></span>
<h1 id="1-小改动"><a class="markdownIt-Anchor" href="#1-小改动"></a> 1. 小改动</h1>
<h2 id="11-改变量字段名字"><a class="markdownIt-Anchor" href="#11-改变量字段名字"></a> 1.1. 改变量/字段名字</h2>
<p>将 React 项目的 <code>src/stores/user/types.ts</code> 中的 <code>LoginCredentials</code> 的 <code>email</code> 修改为 <code>username</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">LoginCredentials</span> &#123; </span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>; </span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-修改依赖数组"><a class="markdownIt-Anchor" href="#12-修改依赖数组"></a> 1.2. 修改依赖数组</h2>
<p>在 <code>src/pages/VerifyEmail.tsx</code> 中的 <code>useEffect</code> 的依赖数组内加一个 <code>location.search</code>：</p>
<figure class="highlight tsx"><figcaption><span>VerifyEmail.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> searchParams = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(location.<span class="property">search</span>);</span><br><span class="line">  <span class="keyword">const</span> token = searchParams.<span class="title function_">get</span>(<span class="string">&#x27;token&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> currentToken = useUserStore.<span class="title function_">getState</span>().<span class="property">verificationToken</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (token &amp;&amp; !verificationInProgress &amp;&amp; !emailVerified &amp;&amp; token !== currentToken) &#123;</span><br><span class="line">    <span class="title function_">handleVerification</span>(token).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (r.<span class="property">success</span> &amp;&amp; <span class="string">&#x27;message&#x27;</span> <span class="keyword">in</span> r) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;邮箱验证成功：&#x27;</span>, r.<span class="property">message</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [handleVerification, verificationInProgress, emailVerified, location.<span class="property">search</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="13-新建-email-verificationinterfacets"><a class="markdownIt-Anchor" href="#13-新建-email-verificationinterfacets"></a> 1.3. 新建 <code>email-verification.interface.ts</code></h2>
<p>将原本放在 <code>users.service.ts</code> 内的这段内容单独放在一个文件里：</p>
<figure class="highlight ts"><figcaption><span>email-verification.interface.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> <span class="title class_">EmailVerificationError</span> &#123;</span><br><span class="line">  <span class="variable constant_">TOKEN_INVALID</span> = <span class="string">&#x27;TOKEN_INVALID&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">TOKEN_EXPIRED</span> = <span class="string">&#x27;TOKEN_EXPIRED&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">ALREADY_VERIFIED</span> = <span class="string">&#x27;ALREADY_VERIFIED&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">VerificationResponse</span> &#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">message</span>: <span class="built_in">string</span>;</span><br><span class="line">  error?: <span class="title class_">EmailVerificationError</span>;</span><br><span class="line">  userId?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-统一查找用户的方法"><a class="markdownIt-Anchor" href="#14-统一查找用户的方法"></a> 1.4. 统一查找用户的方法</h2>
<p>原先我们只写了靠 ID 来查找用户的方法，如果要进行扩展的话，一个方法一个方法写太麻烦了，干脆写一个更灵活的查找方法、支持通过任何唯一字段查找用户：</p>
<figure class="highlight ts"><figcaption><span>users.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findUser</span>(<span class="params"><span class="attr">criteria</span>: <span class="title class_">UserSearchCriteria</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">debug</span>(<span class="string">`开始查找用户，条件：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(criteria)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> whereClause = <span class="title class_">Object</span>.<span class="title function_">entries</span>(criteria)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function">(<span class="params">[, value]</span>) =&gt;</span> value !== <span class="literal">undefined</span>)</span><br><span class="line">    .<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, [key, value]</span>) =&gt;</span> (&#123; ...acc, [key]: value &#125;), &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(whereClause).<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">warn</span>(<span class="string">&#x27;查询条件为空&#x27;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;至少需要一个查询条件&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">usersRepository</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: whereClause</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">    <span class="keyword">const</span> [[key, value]] = <span class="title class_">Object</span>.<span class="title function_">entries</span>(whereClause);</span><br><span class="line">    <span class="keyword">const</span> fieldMap = &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">      <span class="attr">username</span>: <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">      <span class="attr">email</span>: <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">      <span class="attr">verificationToken</span>: <span class="string">&#x27;验证令牌&#x27;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> errorMessage = <span class="string">`未找到<span class="subst">$&#123;fieldMap[key]&#125;</span>为 <span class="subst">$&#123;value&#125;</span> 的用户`</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">warn</span>(<span class="string">`查找用户失败：<span class="subst">$&#123;errorMessage&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotFoundException</span>(errorMessage);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">debug</span>(<span class="string">`用户查找成功：<span class="subst">$&#123;user.id&#125;</span>，用户详细信息：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(user)&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><figcaption><span>users.interface.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">UserSearchCriteria</span> = <span class="title class_">Partial</span>&lt;&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">verificationToken</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;&gt;;</span><br></pre></td></tr></table></figure>
<p><code>UsersController</code> 的查找用户 API 也可以修改成类似的样子：</p>
<figure class="highlight ts"><figcaption><span>users.controller.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(&#123; <span class="attr">summary</span>: <span class="string">&#x27;根据不同字段查找用户&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@ApiParam</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;field&#x27;</span>, <span class="attr">enum</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>], <span class="attr">description</span>: <span class="string">&#x27;查找字段&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@ApiParam</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;value&#x27;</span>, <span class="attr">description</span>: <span class="string">&#x27;查找值&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@ApiResponse</span>(&#123; <span class="attr">status</span>: <span class="title class_">HttpStatus</span>.<span class="property">OK</span>, <span class="attr">description</span>: <span class="string">&#x27;获取用户信息成功&#x27;</span>, <span class="attr">type</span>: <span class="title class_">Users</span> &#125;)</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="title class_">HttpStatus</span>.<span class="property">OK</span>)</span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;:field/:value&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findByField</span>(<span class="meta">@Param</span>(<span class="string">&#x27;field&#x27;</span>) <span class="attr">field</span>: <span class="string">&#x27;id&#x27;</span> | <span class="string">&#x27;username&#x27;</span> | <span class="string">&#x27;email&#x27;</span>, <span class="meta">@Param</span>(<span class="string">&#x27;value&#x27;</span>) <span class="attr">value</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Users</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> validFields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (!validFields.<span class="title function_">includes</span>(field)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">`不支持通过 <span class="subst">$&#123;field&#125;</span> 字段查找用户`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">usersService</span>.<span class="title function_">findUser</span>(&#123; [field]: value &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="15-jwt-payload-修复"><a class="markdownIt-Anchor" href="#15-jwt-payload-修复"></a> 1.5. <code>JWT Payload</code> 修复</h2>
<figure class="highlight ts"><figcaption><span>jwt-payload.interface.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 过去的接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">JWTPayload</span> &#123;</span><br><span class="line">  <span class="attr">sub</span>: <span class="built_in">number</span>;  <span class="comment">// 错误的类型</span></span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">role</span>: <span class="built_in">string</span>;</span><br><span class="line">  iat?: <span class="built_in">number</span>;</span><br><span class="line">  exp?: <span class="built_in">number</span>;</span><br><span class="line">  aud?: <span class="built_in">string</span>;</span><br><span class="line">  iss?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在的接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">JWTPayload</span> &#123;</span><br><span class="line">  <span class="attr">sub</span>: <span class="built_in">string</span>;  <span class="comment">// 修正为 string 类型，因为使用 UUID</span></span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">role</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">verified</span>: <span class="built_in">boolean</span>;  <span class="comment">// 新增字段，用于邮箱验证状态</span></span><br><span class="line">  iat?: <span class="built_in">number</span>;</span><br><span class="line">  exp?: <span class="built_in">number</span>;</span><br><span class="line">  aud?: <span class="built_in">string</span>;</span><br><span class="line">  iss?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="16-布局组件优化"><a class="markdownIt-Anchor" href="#16-布局组件优化"></a> 1.6. 布局组件优化</h2>
<p>为了更好地适应不同的页面布局需求，我们需要增加主布局组件的灵活性。原有的 <code>MainLayout</code> 组件只支持路由渲染：</p>
<figure class="highlight tsx"><figcaption><span>MainLayout.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">MainLayout</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">header</span> <span class="attr">className</span>=<span class="string">&quot;bg-primary shadow&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">nav</span> <span class="attr">className</span>=<span class="string">&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;/* TODO: 导航内容 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们对其进行了改造，使其同时支持直接的子组件渲染：</p>
<figure class="highlight tsx"><figcaption><span>MainLayout.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Outlet</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">MainLayoutProps</span> &#123;</span><br><span class="line">  children?: <span class="title class_">React</span>.<span class="property">ReactNode</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MainLayout</span> = (<span class="params">&#123; children &#125;: <span class="title class_">MainLayoutProps</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">header</span> <span class="attr">className</span>=<span class="string">&quot;bg-primary shadow&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">nav</span> <span class="attr">className</span>=<span class="string">&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;/* TODO: 导航内容 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;max-w-7xl mx-auto px-4 sm:px-6 lg:px-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123; children ? children : <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span> &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MainLayout</span>;</span><br></pre></td></tr></table></figure>
<h1 id="2-实现登录表单组件"><a class="markdownIt-Anchor" href="#2-实现登录表单组件"></a> 2. 实现登录表单组件</h1>
<p>在电商平台中，我们需要一个用户友好的登录界面，让用户能够：</p>
<ul>
<li>输入用户名和密码进行登录</li>
<li>在输入过程中获得适当的表单验证反馈</li>
<li>看到登录状态的加载提示</li>
<li>收到登陆成功或者失败的明确提示</li>
</ul>
<ol>
<li>
<p>让我们先在 <code>src/pages</code> 目录下创建 <code>Login.tsx</code>：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123; useFormik &#125; <span class="keyword">from</span> <span class="string">&#x27;formik&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Yup</span> <span class="keyword">from</span> <span class="string">&#x27;yup&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123; useNavigate &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123; useUserStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AuthLayout</span> <span class="keyword">from</span> <span class="string">&#x27;../layouts/AuthLayout&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> logo <span class="keyword">from</span> <span class="string">&#x27;../assets/ShoppingNest.png&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Login</span> = (<span class="params"></span>) =&gt; &#123; </span><br><span class="line">  <span class="keyword">const</span> navigate = <span class="title function_">useNavigate</span>(); </span><br><span class="line">  <span class="keyword">const</span> login = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">login</span>); </span><br><span class="line">  <span class="keyword">const</span> isLoading = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">isLoading</span>); </span><br><span class="line">  <span class="keyword">const</span> error = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">error</span>); </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Login</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用 Formik 管理表单状态和处理提交：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formik = <span class="title function_">useFormik</span>(&#123; </span><br><span class="line">  <span class="attr">initialValues</span>: &#123; </span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span> </span><br><span class="line">  &#125;, </span><br><span class="line">  validationSchema, </span><br><span class="line">  <span class="attr">onSubmit</span>: <span class="title function_">async</span> (values) =&gt; &#123; </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">      <span class="keyword">const</span> &#123; username, password &#125; = values; </span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">login</span>(&#123; username, password &#125;); </span><br><span class="line">      <span class="title function_">navigate</span>(<span class="string">&#x27;/&#x27;</span>, &#123; </span><br><span class="line">        <span class="attr">state</span>: &#123; </span><br><span class="line">          <span class="attr">message</span>: <span class="string">&#x27;登陆成功！&#x27;</span> </span><br><span class="line">        &#125; </span><br><span class="line">      &#125;) </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123; </span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;登录失败：&#x27;</span>, error); </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用 Yup 进行表单验证，确保用户名和密码不为空：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validationSchema = <span class="title class_">Yup</span>.<span class="title function_">object</span>().<span class="title function_">shape</span>(&#123;</span><br><span class="line">  <span class="attr">username</span>: <span class="title class_">Yup</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(<span class="string">&#x27;请输入用户名！&#x27;</span>),</span><br><span class="line">  <span class="attr">password</span>: <span class="title class_">Yup</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(<span class="string">&#x27;请输入密码！&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>以下是页面的基本结构：</p>
 <figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ( </span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">AuthLayout</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;logo&#125;</span> <span class="attr">className</span>=<span class="string">&quot;w-1/4 mx-auto&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Shopping Nest的Logo&quot;</span> /&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">&quot;text-2xl font-bold text-center m-6 text-neutral-content&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">      登录用户 </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">h2</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    &#123;error &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;mb-4 p-3 text-sm text-error-content bg-error rounded-lg&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        &#123;error&#125; </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">    )&#125; </span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;formik.handleSubmit&#125;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;mb-4&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">className</span>=<span class="string">&quot;block text-sm font-semibold text-neutral-content&quot;</span> <span class="attr">htmlFor</span>=<span class="string">&quot;username&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          用户名 </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">label</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">className</span>=<span class="string">&#123;</span>`<span class="attr">w-full</span> <span class="attr">mt-2</span> <span class="attr">p-2</span> <span class="attr">border</span> <span class="attr">rounded-lg</span> <span class="attr">bg-base-300</span> $&#123; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">formik.touched.username</span> &amp;&amp; <span class="attr">formik.errors.username</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              ? &quot;<span class="attr">border-error</span>&quot; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">:</span> &quot;<span class="attr">border-neutral-600</span>&quot; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          &#125; <span class="attr">text-base-content</span>`&#125; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;formik.values.username&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;formik.handleChange&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onBlur</span>=<span class="string">&#123;formik.handleBlur&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">disabled</span>=<span class="string">&#123;isLoading&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span> </span></span><br><span class="line"><span class="language-xml">        &#123;formik.touched.username &amp;&amp; formik.errors.username &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;text-sm text-error mt-1&quot;</span>&gt;</span>&#123;formik.errors.username&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        )&#125; </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;mb-4&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">className</span>=<span class="string">&quot;block text-sm font-semibold text-neutral-content&quot;</span> <span class="attr">htmlFor</span>=<span class="string">&quot;password&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          密码 </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">label</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">className</span>=<span class="string">&#123;</span>`<span class="attr">w-full</span> <span class="attr">mt-2</span> <span class="attr">p-2</span> <span class="attr">border</span> <span class="attr">rounded-lg</span> <span class="attr">bg-base-300</span> $&#123; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">formik.touched.password</span> &amp;&amp; <span class="attr">formik.errors.password</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              ? &quot;<span class="attr">border-error</span>&quot; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">:</span> &quot;<span class="attr">border-neutral-600</span>&quot; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          &#125; <span class="attr">text-base-content</span>`&#125; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;formik.values.password&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;formik.handleChange&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onBlur</span>=<span class="string">&#123;formik.handleBlur&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">disabled</span>=<span class="string">&#123;isLoading&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span> </span></span><br><span class="line"><span class="language-xml">        &#123;formik.touched.password &amp;&amp; formik.errors.password &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;text-sm text-error mt-1&quot;</span>&gt;</span>&#123;formik.errors.password&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        )&#125; </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">className</span>=<span class="string">&quot;w-full bg-primary text-primary-content py-2 rounded-lg mt-4 hover:brightness-90 disabled:opacity-50&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">disabled</span>=<span class="string">&#123;isLoading&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      &gt;</span> </span></span><br><span class="line"><span class="language-xml">        &#123;isLoading ? &quot;登录中…&quot; : &quot;登录&quot;&#125; </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">AuthLayout</span>&gt;</span></span> </span><br><span class="line">) </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 <code>src/router.tsx</code> 中添加 <code>/login</code> 路由：</p>
 <figure class="highlight tsx"><figcaption><span>router.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Login</span> <span class="keyword">from</span> <span class="string">&#x27;./pages/Login&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createBrowserRouter</span>([ </span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>, </span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Login</span> /&gt;</span></span> </span><br><span class="line">  &#125;</span><br><span class="line">]); </span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="3-配置-jwt-认证"><a class="markdownIt-Anchor" href="#3-配置-jwt-认证"></a> 3. 配置 JWT 认证</h1>
<p>在实现用户登录功能时，我们需要一个安全可靠的身份验证机制，以确保用户身份的真实性并保护系统的安全。</p>
<p>JWT（JSON Web Token）是一个开放标准，它提供了一种紧凑且自包含的方式，在各方之间安全地传输信息。</p>
<p>通过 JWT，我们可以生成安全的访问令牌、验证用户的身份和权限、保护需要认证的 API 端点，并在服务端对令牌的有效性进行校验。</p>
<p>要实现 JWT 认证机制，我们需要从多个方面入手：</p>
<ol>
<li>配置认证模块、JWT 模块的签名密钥以及相关选项</li>
<li>集成用户模块，以便进行用户身份验证</li>
<li>实现认证服务，该服务需要负责验证用户凭据、生成 JWT 令牌、处理令牌刷新以及检查令牌的有效性，确保认证流程的完整性和安全性</li>
<li>创建一个认证控制器，专门处理用户的登录请求，并返回认证结果和 JWT 令牌，确保前端能够正确接收和使用身份验证信息</li>
<li>实现 JWT 策略和守卫：从请求中提取 JWT 令牌，并验证其有效性，以此来保护系统中需要认证的路由，确保只有经过身份经验的用户才能访问受保护的资源</li>
</ol>
<h2 id="31-安装依赖"><a class="markdownIt-Anchor" href="#31-安装依赖"></a> 3.1. 安装依赖</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add @nestjs/jwt @nestjs/passport passport passport-jwt</span><br><span class="line">yarn add -D @types/passport-jwt</span><br></pre></td></tr></table></figure>
<h2 id="32-认证模块"><a class="markdownIt-Anchor" href="#32-认证模块"></a> 3.2. 认证模块</h2>
<p>在 <code>src</code> 目录下创建 <code>auth</code> 目录，并创建 <code>auth.module.ts</code>：</p>
<figure class="highlight ts"><figcaption><span>auth.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PassportModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/passport&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthController</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtStrategy</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./jwt.strategy&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UsersModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../users/users.module&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">PassportModule</span>.<span class="title function_">register</span>(&#123;</span><br><span class="line">      <span class="attr">defaultStrategy</span>: <span class="string">&#x27;jwt&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title class_">JwtModule</span>.<span class="title function_">registerAsync</span>(&#123;</span><br><span class="line">      <span class="attr">inject</span>: [<span class="title class_">ConfigService</span>],</span><br><span class="line">      <span class="attr">useFactory</span>: <span class="title function_">async</span> (<span class="attr">configService</span>: <span class="title class_">ConfigService</span>) =&gt; (&#123;</span><br><span class="line">        <span class="attr">secret</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_SECRET&#x27;</span>),</span><br><span class="line">        <span class="attr">signOptions</span>: &#123;</span><br><span class="line">          <span class="attr">audience</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">          <span class="attr">issuer</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>),</span><br><span class="line">          <span class="attr">expiresIn</span>: configService.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title class_">UsersModule</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AuthController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AuthService</span>, <span class="title class_">JwtStrategy</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">AuthService</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="33-用户验证和令牌生成"><a class="markdownIt-Anchor" href="#33-用户验证和令牌生成"></a> 3.3. 用户验证和令牌生成</h2>
<p>创建 <code>auth.service.ts</code>：</p>
<figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> bcrypt <span class="keyword">from</span> <span class="string">&#x27;bcrypt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../users/users.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JWTPayload</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces/jwt-payload.interface&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">jwtService</span>: <span class="title class_">JwtService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">usersService</span>: <span class="title class_">UsersService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">configService</span>: <span class="title class_">ConfigService</span></span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>验证用户：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">validateUser</span>(<span class="params"><span class="attr">username</span>: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">usersService</span>.<span class="title function_">findUser</span>(&#123; <span class="attr">username</span>: username &#125;);</span><br><span class="line">  <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;用户名或密码错误&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!user.<span class="property">verified</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;请先验证邮箱后再登录&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isPasswordValid = <span class="keyword">await</span> bcrypt.<span class="title function_">compare</span>(password, user.<span class="property">password</span>);</span><br><span class="line">  <span class="keyword">if</span> (!isPasswordValid) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;用户名或密码错误&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>用户登录：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"><span class="attr">user</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">payload</span>: <span class="title class_">JWTPayload</span> = &#123;</span><br><span class="line">    <span class="attr">sub</span>: user.<span class="property">sub</span>,</span><br><span class="line">    <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">    <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">    <span class="attr">role</span>: user.<span class="property">role</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>首先构建 JWT 载荷。</p>
<blockquote>
<p>JWT 基本上由三个部分组成，使用 <code>.</code> 分割：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">头.载荷.签名</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>头包含了令牌类型和使用的签名算法：</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span>  <span class="comment">// 使用的算法</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>载荷包含了我们存储的实际数据：</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1234567890&quot;</span><span class="punctuation">,</span>  <span class="comment">// 用户 ID</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;john_doe&quot;</span><span class="punctuation">,</span>  <span class="comment">// 用户名</span></span><br><span class="line">  <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;john@doe.com&quot;</span><span class="punctuation">,</span>  <span class="comment">// 邮箱</span></span><br><span class="line">  <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span>  <span class="comment">// 角色</span></span><br><span class="line">  <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1516239022</span><span class="punctuation">,</span>       <span class="comment">// 签发时间</span></span><br><span class="line">  <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1516242622</span>        <span class="comment">// 过期时间</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>签名则使用密钥、对头和载荷进行签名：</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">HMACSHA256</span>(</span><br><span class="line">  <span class="title function_">base64UrlEncode</span>(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  <span class="title function_">base64UrlEncode</span>(payload),</span><br><span class="line">  secret  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> accessToken = <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(payload, &#123;</span><br><span class="line">  <span class="comment">// 令牌接收方</span></span><br><span class="line">  <span class="attr">audience</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">  <span class="comment">// 令牌发行方</span></span><br><span class="line">  <span class="attr">issuer</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>),</span><br><span class="line">  <span class="comment">// 令牌有效期</span></span><br><span class="line">  <span class="attr">expiresIn</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用 <code>JwtService</code> 生成签名令牌。</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">access_token</span>: accessToken,</span><br><span class="line">    <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">    <span class="attr">expires_in</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>),</span><br><span class="line">    <span class="attr">user</span>: &#123;</span><br><span class="line">      <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">      <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">      <span class="attr">role</span>: user.<span class="property">role</span>,</span><br><span class="line">      <span class="attr">verified</span>: user.<span class="property">verified</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里说一下令牌类型 <code>Bearer</code>，它是 OAuth 2.0 的标准组成部分。</p>
</li>
<li>
<p>在令牌过期前更新令牌：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">refreshToken</span>(<span class="params"><span class="attr">user</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">payload</span>: <span class="title class_">JWTPayload</span> = &#123;</span><br><span class="line">    <span class="attr">sub</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">    <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">    <span class="attr">role</span>: user.<span class="property">role</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">access_token</span>: <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(payload)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当现有访问令牌即将过期时，服务器会生成一个新的访问令牌。</p>
<p>使用与原始登录相同的用户信息构建新的载荷，这样用户就不需要重新登陆，可以无缝继续使用系统。</p>
</li>
<li>
<p>验证令牌：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">verifyToken</span>(<span class="params"><span class="attr">token</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">verify</span>(token);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;无效的令牌，错误：&#x27;</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法负责验证传入的 JWT 令牌的有效性。</p>
<p><code>JwtService.verify()</code> 方法会检查令牌是否：</p>
<ul>
<li>签名有效（未被篡改）</li>
<li>未过期</li>
<li>是由我们的系统签发的</li>
</ul>
</li>
</ol>
<p>在 <code>auth</code> 目录下创建 <code>interfaces/jwt-payload.interface.ts</code> 文件，定义 JWT 载荷的 TypeScript 接口：</p>
<figure class="highlight ts"><figcaption><span>jwt-payload.interface.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">JWTPayload</span> &#123;</span><br><span class="line">  <span class="attr">sub</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">role</span>: <span class="built_in">string</span>;</span><br><span class="line">  iat?: <span class="built_in">number</span>;</span><br><span class="line">  exp?: <span class="built_in">number</span>;</span><br><span class="line">  aud?: <span class="built_in">string</span>;</span><br><span class="line">  iss?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="34-认证控制器"><a class="markdownIt-Anchor" href="#34-认证控制器"></a> 3.4. 认证控制器</h2>
<p>我们先来写一下登录所需要的 DTO。</p>
<ol>
<li>
<p>定义登录请求的数据结构：</p>
 <figure class="highlight ts"><figcaption><span>login.dto.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiProperty</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IsNotEmpty</span>, <span class="title class_">IsString</span>, <span class="title class_">MinLength</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;class-validator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginDto</span> &#123;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">example</span>: <span class="string">&#x27;johndoe&#x27;</span>, <span class="attr">description</span>: <span class="string">&#x27;用户名&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@IsString</span>()</span><br><span class="line">  <span class="meta">@IsNotEmpty</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;用户名不能为空&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">example</span>: <span class="string">&#x27;password123&#x27;</span>, <span class="attr">description</span>: <span class="string">&#x27;密码&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@IsString</span>()</span><br><span class="line">  <span class="meta">@IsNotEmpty</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;密码不能为空&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@MinLength</span>(<span class="number">6</span>, &#123; <span class="attr">message</span>: <span class="string">&#x27;密码长度不能小于6位&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>登录响应 DTO：</p>
 <figure class="highlight ts"><figcaption><span>login-response.dto.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiProperty</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginResponseDto</span> &#123;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">description</span>: <span class="string">&#x27;访问令牌&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">access_token</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">description</span>: <span class="string">&#x27;令牌类型&#x27;</span>, <span class="attr">example</span>: <span class="string">&#x27;Bearer&#x27;</span> &#125;)</span><br><span class="line">  <span class="attr">token_type</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123; <span class="attr">description</span>: <span class="string">&#x27;过期时间（秒）&#x27;</span>, <span class="attr">example</span>: <span class="number">3600</span> &#125;)</span><br><span class="line">  <span class="attr">expires_in</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123;</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;用户信息&#x27;</span>,</span><br><span class="line">    <span class="attr">example</span>: &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">      <span class="attr">username</span>: <span class="string">&#x27;johndoe&#x27;</span>,</span><br><span class="line">      <span class="attr">email</span>: <span class="string">&#x27;john@example.com&#x27;</span>,</span><br><span class="line">      <span class="attr">role</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">      <span class="attr">verified</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="attr">user</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">role</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">verified</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>创建 <code>auth.controller.ts</code>：</p>
<figure class="highlight ts"><figcaption><span>auth.controller.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Post</span>, <span class="title class_">Body</span>, <span class="title class_">HttpCode</span>, <span class="title class_">HttpStatus</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApiTags</span>, <span class="title class_">ApiOperation</span>, <span class="title class_">ApiResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/login.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginResponseDto</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./dto/login-response.dto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> winstonLogger <span class="keyword">from</span> <span class="string">&#x27;../loggers/winston.logger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;认证&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;auth&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> logger = winstonLogger;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="attr">authService</span>: <span class="title class_">AuthService</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation</span>(&#123; <span class="attr">summary</span>: <span class="string">&#x27;用户登录&#x27;</span> &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="title class_">HttpStatus</span>.<span class="property">OK</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;登录成功&#x27;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">LoginResponseDto</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="meta">@ApiResponse</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="title class_">HttpStatus</span>.<span class="property">UNAUTHORIZED</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;登录失败&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="meta">@HttpCode</span>(<span class="title class_">HttpStatus</span>.<span class="property">OK</span>)</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">login</span>(<span class="meta">@Body</span>() <span class="attr">loginDto</span>: <span class="title class_">LoginDto</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">LoginResponseDto</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">validateUser</span>(loginDto.<span class="property">username</span>, loginDto.<span class="property">password</span>);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">debug</span>(<span class="string">`用户 <span class="subst">$&#123;loginDto.username&#125;</span> 验证通过，正在生成令牌`</span>);</span><br><span class="line">      <span class="keyword">const</span> loginResult = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">login</span>(user);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">`用户 <span class="subst">$&#123;loginDto.username&#125;</span> 登录成功`</span>);</span><br><span class="line">      <span class="keyword">return</span> loginResult;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">`用户 <span class="subst">$&#123;loginDto.username&#125;</span> 登录失败: <span class="subst">$&#123;error.message&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="35-策略实现"><a class="markdownIt-Anchor" href="#35-策略实现"></a> 3.5. 策略实现</h2>
<p><code>AuthService.validateUser()</code> 方法仅是用于登录时的用户验证，以及生成初始的 JWT 令牌。</p>
<p>那后续请求该由谁来验证呢？</p>
<blockquote>
<p>可以想象成有这么一个商场。</p>
<p>你在前台登记（登录），工作人员会验证你的身份（<code>AuthService.validateUser()</code>），验证成功后给了你一个特殊的通行证（JWT 令牌）。</p>
<p>你在商场里遛弯，发现有一个 VIP 区域（访问受保护的 API），门口站一保安。你说你想进去，保安说别急先看看你的通行证（JWT 令牌）。</p>
<p>保安需要看到的是：</p>
<ul>
<li>这个通行证是不是商场发的（JWT 签名验证）</li>
<li>通行证有没有过期（JWT 过期检查）</li>
<li>你的会员资格是否还有效（接下来要写的方法）</li>
</ul>
<p>JWT 策略实现就是这个保安。</p>
</blockquote>
<p>创建 <code>jwt.strategy.ts</code>：</p>
<figure class="highlight ts"><figcaption><span>jwt.strategy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PassportStrategy</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/passport&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Strategy</span>, <span class="title class_">ExtractJwt</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;passport-jwt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../users/users.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtStrategy</span> <span class="keyword">extends</span> <span class="title class_ inherited__">PassportStrategy</span>(<span class="title class_">Strategy</span>) &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">configService</span>: <span class="title class_">ConfigService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">usersService</span>: <span class="title class_">UsersService</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(&#123;</span><br><span class="line">      <span class="attr">jwtFromRequest</span>: <span class="title class_">ExtractJwt</span>.<span class="title function_">fromAuthHeaderAsBearerToken</span>(),</span><br><span class="line">      <span class="attr">ignoreExpiration</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">secretOrKey</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_SECRET&#x27;</span>),</span><br><span class="line">      <span class="attr">audience</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">      <span class="attr">issuer</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>检查用户是否还是“有效会员”：</p>
<figure class="highlight ts"><figcaption><span>jwt.strategy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">async</span> <span class="title function_">validate</span>(<span class="params"><span class="attr">payload</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">usersService</span>.<span class="title function_">findUser</span>(&#123; <span class="attr">id</span>: payload.<span class="property">sub</span> &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;用户不存在&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!user.<span class="property">verified</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;用户未验证&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">      <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">      <span class="attr">role</span>: user.<span class="property">role</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="36-jwt-守卫"><a class="markdownIt-Anchor" href="#36-jwt-守卫"></a> 3.6. JWT 守卫</h2>
<blockquote>
<p>先前的商场例子里，提到了“受保护的 API”。</p>
<p>那么要如何创建这么个“VIP 区域”呢？我们就需要用到 JWT 守卫。</p>
</blockquote>
<p>创建 <code>jwt-auth.guard.ts</code>：</p>
<figure class="highlight ts"><figcaption><span>jwt-auth.guard.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtAuthGuard</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AuthGuard</span>(<span class="string">&#x27;jwt&#x27;</span>) &#123;</span><br><span class="line">  <span class="title function_">handleRequest</span>(<span class="params"><span class="attr">error</span>: <span class="built_in">any</span>, <span class="attr">user</span>: <span class="built_in">any</span>, <span class="attr">info</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error || !user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;验证失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>守卫的工作流程：</p>
<ol>
<li>收到请求时，检查 <code>Authorization</code> 头部是否包含 JWT 令牌</li>
<li>如果没有令牌或令牌无效，直接拦截请求并返回 <code>401</code> 错误</li>
<li>如果令牌有效，让请求通过并继续处理</li>
</ol>
<p>使用方式也很简单：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;orders&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">OrdersController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">ordersService</span>: <span class="title class_">OrdersService</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 无需登录即可访问的公开 API</span></span><br><span class="line">  <span class="comment">// 例如获取热门商品</span></span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;popular&#x27;</span>)</span><br><span class="line">  <span class="title function_">getPopularOrders</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ordersService</span>.<span class="title function_">getPopularOrders</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 需要登录才能访问的 API</span></span><br><span class="line">  <span class="comment">// 例如用户的订单</span></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">JwtAuthGuard</span>)</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;my-orders&#x27;</span>)</span><br><span class="line">  <span class="title function_">getMyOrders</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ordersService</span>.<span class="title function_">getOrdersByUserId</span>(user.<span class="property">id</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户下单</span></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">JwtAuthGuard</span>)</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&#x27;create&#x27;</span>)</span><br><span class="line">  <span class="title function_">createOrder</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="built_in">any</span>, <span class="meta">@Body</span>() <span class="attr">orderData</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ordersService</span>.<span class="title function_">createOrder</span>(user.<span class="property">id</span>, orderData);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以直接保护控制器的所有路由：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">JwtAuthGuard</span>)  <span class="comment">// 保护个人信息路由</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ProfileController</span> &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">getProfile</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Put</span>()</span><br><span class="line">  <span class="title function_">updateProfile</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="built_in">any</span>, <span class="meta">@Body</span>() <span class="attr">updateData</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">profileService</span>.<span class="title function_">update</span>(user.<span class="property">id</span>, updateData);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="37-用户装饰器"><a class="markdownIt-Anchor" href="#37-用户装饰器"></a> 3.7. 用户装饰器</h2>
<p>假设我们有一个购物车的 API，需要获取当前用户的购物车信息：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;cart&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CartController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">cartService</span>: <span class="title class_">CartService</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">JwtAuthGuard</span>)</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;my-cart&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getMyCart</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">// user 对象包含了 JWT 令牌中的用户信息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cartService</span>.<span class="title function_">getCartByUserId</span>(user.<span class="property">id</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有 <code>CurrentUser</code> 装饰器，我们需要：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;my-cart&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getMyCart</span>(<span class="params"><span class="meta">@Request</span>() <span class="attr">req</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = req.<span class="property">user</span>;  <span class="comment">// 从 request 对象中手动获取用户信息</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cartService</span>.<span class="title function_">getCartByUserId</span>(user.<span class="property">id</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CurrentUser</code> 装饰器的实现：</p>
<figure class="highlight ts"><figcaption><span>current-user.decorator.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createParamDecorator, <span class="title class_">ExecutionContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">CurrentUser</span> = <span class="title function_">createParamDecorator</span>(<span class="function">(<span class="params"><span class="attr">data</span>: <span class="built_in">unknown</span>, <span class="attr">ctx</span>: <span class="title class_">ExecutionContext</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> request = ctx.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">  <span class="keyword">return</span> request.<span class="property">user</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>它的好处在于：</p>
<ul>
<li>简化代码：不需要手动从 <code>request</code> 中提取用户信息</li>
<li>类型安全：可以明确知道返回的是用户对象</li>
<li>可重用性：在任何需要当前用户信息的地方都可以使用</li>
<li>关注点分离：控制器方法只需要关心用户信息，不需要关心它是如何获取的</li>
</ul>
<p>像是还可以有这样的使用场景：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UsersController</span> &#123;</span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">JwtAuthGuard</span>)</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line">  <span class="title function_">getProfile</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> user;  <span class="comment">// 直接返回用户信息</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-添加记住我功能"><a class="markdownIt-Anchor" href="#4-添加记住我功能"></a> 4. 添加记住我功能</h1>
<p>在现代电商平台中，用户体验是至关重要的。用户希望能够快速、便捷地访问他们的账户，而不需要每次都重新输入用户名和密码。这就是“记住我”功能的用武之地。</p>
<p>通过“记住我”功能，用户可以选择在登录时保持一段时间的登录状态，即使关闭浏览器或重新打开应用，用户仍然可以自动登录，无需再次输入凭证。</p>
<h2 id="41-技术方案设计"><a class="markdownIt-Anchor" href="#41-技术方案设计"></a> 4.1. 技术方案设计</h2>
<p>我们采用 <code>RefreshToken</code> + <code>AccessToken</code> 的双令牌认证方案：</p>
<ul>
<li><code>AccessToken</code>：短期令牌，用于访问 API</li>
<li><code>RefreshToken</code>：长期令牌，用于刷新 <code>AccessToken</code></li>
</ul>
<p>这种方案的优势在于：</p>
<ul>
<li>安全性高：<code>AccessToken</code> 短期有效，即使泄露风险也较小</li>
<li>用户体验好：<code>RefreshToken</code> 可以静默刷新 <code>AccessToken</code>，用户无感知</li>
<li>可控性强：可以随时注销 <code>RefreshToken</code>，确保账户安全</li>
</ul>
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewbox="-8 -8 466.64453125 879.421875" style="max-width: 466.64453125px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1753546536757"><style>#mermaid-1753546536757{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1753546536757 .error-icon{fill:#552222;}#mermaid-1753546536757 .error-text{fill:#552222;stroke:#552222;}#mermaid-1753546536757 .edge-thickness-normal{stroke-width:2px;}#mermaid-1753546536757 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1753546536757 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1753546536757 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1753546536757 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1753546536757 .marker{fill:#333333;stroke:#333333;}#mermaid-1753546536757 .marker.cross{stroke:#333333;}#mermaid-1753546536757 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1753546536757 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-1753546536757 .cluster-label text{fill:#333;}#mermaid-1753546536757 .cluster-label span,#mermaid-1753546536757 p{color:#333;}#mermaid-1753546536757 .label text,#mermaid-1753546536757 span,#mermaid-1753546536757 p{fill:#333;color:#333;}#mermaid-1753546536757 .node rect,#mermaid-1753546536757 .node circle,#mermaid-1753546536757 .node ellipse,#mermaid-1753546536757 .node polygon,#mermaid-1753546536757 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1753546536757 .flowchart-label text{text-anchor:middle;}#mermaid-1753546536757 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-1753546536757 .node .label{text-align:center;}#mermaid-1753546536757 .node.clickable{cursor:pointer;}#mermaid-1753546536757 .arrowheadPath{fill:#333333;}#mermaid-1753546536757 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1753546536757 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1753546536757 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1753546536757 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1753546536757 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-1753546536757 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1753546536757 .cluster text{fill:#333;}#mermaid-1753546536757 .cluster span,#mermaid-1753546536757 p{color:#333;}#mermaid-1753546536757 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1753546536757 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1753546536757 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="6" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546536757_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="4.5" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546536757_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5" refx="11" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546536757_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5" refx="-1" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546536757_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5.2" refx="12" viewbox="0 0 11 11" class="marker cross flowchart" id="mermaid-1753546536757_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5.2" refx="-1" viewbox="0 0 11 11" class="marker cross flowchart" id="mermaid-1753546536757_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-B" id="L-A-B-0" d="M197.184,36L197.184,40.167C197.184,44.333,197.184,52.667,197.25,60.2C197.316,67.734,197.448,74.467,197.514,77.834L197.58,81.201"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-C" id="L-B-C-0" d="M166.012,169.828L152.2,180.94C138.388,192.052,110.764,214.276,96.952,230.421C83.141,246.567,83.141,256.633,83.141,261.667L83.141,266.7"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-D" id="L-B-D-0" d="M229.356,169.828L243.001,180.94C256.646,192.052,283.936,214.276,297.581,230.421C311.227,246.567,311.227,256.633,311.227,261.667L311.227,266.7"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-C LE-E" id="L-C-E-0" d="M83.141,308L83.141,312.167C83.141,316.333,83.141,324.667,93.365,332.688C103.589,340.71,124.037,348.42,134.261,352.275L144.485,356.13"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-D LE-E" id="L-D-E-0" d="M311.227,308L311.227,312.167C311.227,316.333,311.227,324.667,301.002,332.688C290.778,340.71,270.33,348.42,260.106,352.275L249.882,356.13"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-E LE-F" id="L-E-F-0" d="M197.184,394L197.184,398.167C197.184,402.333,197.184,410.667,197.184,418.117C197.184,425.567,197.184,432.133,197.184,435.417L197.184,438.7"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-F LE-G" id="L-F-G-0" d="M197.184,480L197.184,484.167C197.184,488.333,197.184,496.667,197.25,504.2C197.316,511.734,197.448,518.467,197.514,521.834L197.58,525.201"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-G LE-H" id="L-G-H-0" d="M161.205,634.443L148.148,646.356C135.091,658.269,108.977,682.096,95.92,699.042C82.863,715.989,82.863,726.055,82.863,731.089L82.863,736.122"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-G LE-I" id="L-G-I-0" d="M234.163,634.443L247.053,646.356C259.943,658.269,285.723,682.096,298.614,699.042C311.504,715.989,311.504,726.055,311.504,731.089L311.504,736.122"/><path marker-end="url(#mermaid-1753546536757_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-I LE-J" id="L-I-J-0" d="M311.504,777.422L311.504,781.589C311.504,785.755,311.504,794.089,311.504,801.539C311.504,808.989,311.504,815.555,311.504,818.839L311.504,822.122"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g transform="translate(83.140625, 236.5)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">是</span></div></foreignObject></g></g><g transform="translate(311.2265625, 236.5)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">否</span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g transform="translate(82.86328125, 705.921875)" class="edgeLabel"><g transform="translate(-16, -10.5)" class="label"><foreignObject height="21" width="32"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">有效</span></div></foreignObject></g></g><g transform="translate(311.50390625, 705.921875)" class="edgeLabel"><g transform="translate(-16, -10.5)" class="label"><foreignObject height="21" width="32"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">无效</span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(197.18359375, 18)" data-id="A" data-node="true" id="flowchart-A-0" class="node default default flowchart-label"><rect height="36" width="79" y="-18" x="-39.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">用户登录</span></div></foreignObject></g></g><g transform="translate(197.18359375, 143.5)" data-id="B" data-node="true" id="flowchart-B-1" class="node default default flowchart-label"><polygon style="" transform="translate(-57.5,57.5)" class="label-container" points="57.5,0 115,-57.5 57.5,-115 0,-57.5"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">记住我？</span></div></foreignObject></g></g><g transform="translate(83.140625, 290)" data-id="C" data-node="true" id="flowchart-C-3" class="node default default flowchart-label"><rect height="36" width="166.28125" y="-18" x="-83.140625" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-75.640625, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="151.28125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">生成7天RefreshToken</span></div></foreignObject></g></g><g transform="translate(311.2265625, 290)" data-id="D" data-node="true" id="flowchart-D-5" class="node default default flowchart-label"><rect height="36" width="189.890625" y="-18" x="-94.9453125" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-87.4453125, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="174.890625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">生成会话级RefreshToken</span></div></foreignObject></g></g><g transform="translate(197.18359375, 376)" data-id="E" data-node="true" id="flowchart-E-7" class="node default default flowchart-label"><rect height="36" width="238.671875" y="-18" x="-119.3359375" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-111.8359375, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="223.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">返回AccessToken+RefreshToken</span></div></foreignObject></g></g><g transform="translate(197.18359375, 462)" data-id="F" data-node="true" id="flowchart-F-11" class="node default default flowchart-label"><rect height="36" width="190.203125" y="-18" x="-95.1015625" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-87.6015625, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="175.203125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">访问API携带AccessToken</span></div></foreignObject></g></g><g transform="translate(197.18359375, 600.2109375)" data-id="G" data-node="true" id="flowchart-G-13" class="node default default flowchart-label"><polygon style="" transform="translate(-70.2109375,70.2109375)" class="label-container" points="70.2109375,0 140.421875,-70.2109375 70.2109375,-140.421875 0,-70.2109375"/><g transform="translate(-44.7109375, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="89.421875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Token有效？</span></div></foreignObject></g></g><g transform="translate(82.86328125, 759.421875)" data-id="H" data-node="true" id="flowchart-H-15" class="node default default flowchart-label"><rect height="36" width="79" y="-18" x="-39.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">正常访问</span></div></foreignObject></g></g><g transform="translate(311.50390625, 759.421875)" data-id="I" data-node="true" id="flowchart-I-17" class="node default default flowchart-label"><rect height="36" width="278.28125" y="-18" x="-139.140625" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-131.640625, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="263.28125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">使用RefreshToken获取新AccessToken</span></div></foreignObject></g></g><g transform="translate(311.50390625, 845.421875)" data-id="J" data-node="true" id="flowchart-J-19" class="node default default flowchart-label"><rect height="36" width="133.8125" y="-18" x="-66.90625" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-59.40625, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="118.8125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">重新尝试API请求</span></div></foreignObject></g></g></g></g></g></svg>
<h2 id="42-环境配置"><a class="markdownIt-Anchor" href="#42-环境配置"></a> 4.2. 环境配置</h2>
<h4 id="421-修改环境变量"><a class="markdownIt-Anchor" href="#421-修改环境变量"></a> 4.2.1. 修改环境变量</h4>
<p>首先需要在 <code>.env</code> 文件中添加新的配置项：</p>
<figure class="highlight plaintext"><figcaption><span>.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># JWT </span><br><span class="line">JWT_ACCESS_SECRET=access_secret </span><br><span class="line">JWT_REFRESH_SECRET=refresh_secret </span><br><span class="line">JWT_TOKEN_AUDIENCE=localhost:4000 </span><br><span class="line">JWT_TOKEN_ISSUER=localhost:4000 </span><br><span class="line">JWT_ACCESS_TOKEN_TTL=3600 </span><br><span class="line">JWT_REFRESH_TOKEN_TTL=604800</span><br></pre></td></tr></table></figure>
<p>配置说明：</p>
<ul>
<li><code>JWT_ACCESS_SECRET</code>：访问令牌密钥</li>
<li><code>JWT_REFRESH_SECRET</code>：刷新令牌密钥</li>
<li><code>JWT_ACCESS_TOKEN_TTL</code>：访问令牌有效期（1 小时）</li>
<li><code>JWT_REFRESH_TOKEN_TTL</code>：刷新令牌有效期（7 天）</li>
</ul>
<h4 id="422-更新配置验证"><a class="markdownIt-Anchor" href="#422-更新配置验证"></a> 4.2.2. 更新配置验证</h4>
<p>在 <code>AppModule</code> 中更新 <code>ConfigModule</code> 的配置验证：</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">ConfigModule</span>.<span class="title function_">forRoot</span>(&#123;</span><br><span class="line">      <span class="attr">validationSchema</span>: <span class="title class_">Joi</span>.<span class="title function_">object</span>(&#123;</span><br><span class="line">        <span class="comment">// ... 其他配置项 ...</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// JWT 配置</span></span><br><span class="line">        <span class="attr">JWT_ACCESS_SECRET</span>: <span class="title class_">Joi</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(),</span><br><span class="line">        <span class="attr">JWT_REFRESH_SECRET</span>: <span class="title class_">Joi</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(),</span><br><span class="line">        <span class="attr">JWT_TOKEN_AUDIENCE</span>: <span class="title class_">Joi</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(),</span><br><span class="line">        <span class="attr">JWT_TOKEN_ISSUER</span>: <span class="title class_">Joi</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(),</span><br><span class="line">        <span class="attr">JWT_ACCESS_TOKEN_TTL</span>: <span class="title class_">Joi</span>.<span class="title function_">number</span>().<span class="title function_">default</span>(<span class="number">3600</span>),</span><br><span class="line">        <span class="attr">JWT_REFRESH_TOKEN_TTL</span>: <span class="title class_">Joi</span>.<span class="title function_">number</span>().<span class="title function_">default</span>(<span class="number">604800</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="423-更新认证模块"><a class="markdownIt-Anchor" href="#423-更新认证模块"></a> 4.2.3. 更新认证模块</h4>
<p>在 <code>AuthModule</code> 中更新 <code>JwtModule</code> 的配置：</p>
<figure class="highlight ts"><figcaption><span>app.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">JwtModule</span>.<span class="title function_">registerAsync</span>(&#123;</span><br><span class="line">      <span class="attr">inject</span>: [<span class="title class_">ConfigService</span>],</span><br><span class="line">      <span class="attr">useFactory</span>: <span class="title function_">async</span> (<span class="attr">configService</span>: <span class="title class_">ConfigService</span>) =&gt; (&#123;</span><br><span class="line">        <span class="attr">secret</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_ACCESS_SECRET&#x27;</span>),</span><br><span class="line">        <span class="attr">signOptions</span>: &#123;</span><br><span class="line">          <span class="attr">audience</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">          <span class="attr">issuer</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>),</span><br><span class="line">          <span class="attr">expiresIn</span>: configService.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="424-更新-jwt-策略"><a class="markdownIt-Anchor" href="#424-更新-jwt-策略"></a> 4.2.4. 更新 JWT 策略</h4>
<p>修改 <code>JwtStrategy</code> 的配置：</p>
<figure class="highlight ts"><figcaption><span>jwt.strategy.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtStrategy</span> <span class="keyword">extends</span> <span class="title class_ inherited__">PassportStrategy</span>(<span class="title class_">Strategy</span>) &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">configService</span>: <span class="title class_">ConfigService</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(&#123;</span><br><span class="line">      <span class="attr">jwtFromRequest</span>: <span class="title class_">ExtractJwt</span>.<span class="title function_">fromAuthHeaderAsBearerToken</span>(),</span><br><span class="line">      <span class="attr">ignoreExpiration</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">secretOrKey</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_ACCESS_SECRET&#x27;</span>),</span><br><span class="line">      <span class="attr">audience</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">      <span class="attr">issuer</span>: configService.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="43-令牌生成与签名实现"><a class="markdownIt-Anchor" href="#43-令牌生成与签名实现"></a> 4.3. 令牌生成与签名实现</h2>
<h4 id="431-jwt-配置抽离"><a class="markdownIt-Anchor" href="#431-jwt-配置抽离"></a> 4.3.1. JWT 配置抽离</h4>
<p>为了更好地管理 JWT 相关的配置，我们首先创建了一个专门的配置文件 <code>jwt.config.ts</code>：</p>
<figure class="highlight ts"><figcaption><span>jwt.config.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getJWTVerifyOptions</span> = (<span class="params"><span class="attr">configService</span>: <span class="title class_">ConfigService</span></span>) =&gt; (&#123;</span><br><span class="line">  <span class="attr">accessToken</span>: &#123;</span><br><span class="line">    <span class="attr">secret</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_ACCESS_SECRET&#x27;</span>),</span><br><span class="line">    <span class="attr">audience</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">    <span class="attr">issuer</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>),</span><br><span class="line">    <span class="attr">expiresIn</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">refreshToken</span>: &#123;</span><br><span class="line">    <span class="attr">secret</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_REFRESH_SECRET&#x27;</span>),</span><br><span class="line">    <span class="attr">audience</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">    <span class="attr">issuer</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>),</span><br><span class="line">    <span class="attr">expiresIn</span>: configService.<span class="title function_">get</span>(<span class="string">&#x27;JWT_REFRESH_TOKEN_TTL&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样做的好处是：</p>
<ul>
<li>集中管理 JWT 配置</li>
<li>方便在不同地方复用配置</li>
<li>确保配置的一致性</li>
</ul>
<h4 id="432-数据结构调整"><a class="markdownIt-Anchor" href="#432-数据结构调整"></a> 4.3.2. 数据结构调整</h4>
<ol>
<li>
<p>在 <code>Users</code> 实体中添加 <code>refreshToken</code> 字段，用于存储刷新令牌：</p>
 <figure class="highlight ts"><figcaption><span>users.entity.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">refreshToken?: <span class="built_in">string</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 <code>LoginDto</code> 中添加“记住我”选项：</p>
 <figure class="highlight ts"><figcaption><span>login.dto.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiProperty</span>(&#123; <span class="attr">example</span>: <span class="literal">false</span>, <span class="attr">required</span>: <span class="literal">false</span>, <span class="attr">description</span>: <span class="string">&#x27;是否记住我&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@IsBoolean</span>()</span><br><span class="line"><span class="meta">@IsOptional</span>()</span><br><span class="line">rememberMe?: <span class="built_in">boolean</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在 <code>LoginResponseDto</code> 中新增刷新令牌字段：</p>
 <figure class="highlight ts"><figcaption><span>login-response.dto.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiProperty</span>(&#123; <span class="attr">description</span>: <span class="string">&#x27;刷新令牌&#x27;</span> &#125;)</span><br><span class="line"><span class="attr">refresh_token</span>: <span class="built_in">string</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="433-认证服务实现"><a class="markdownIt-Anchor" href="#433-认证服务实现"></a> 4.3.3. 认证服务实现</h4>
<p>在 <code>AuthService</code> 中，我们需要进行以下主要改动：</p>
<ol>
<li>
<p>为了支持“记住我”功能，需要在用户登录时生成两种令牌：访问令牌（<code>accessToken</code>）和刷新令牌（<code>refreshToken</code>）。</p>
<ol>
<li>
<p>将原有的令牌生成逻辑修改为：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 之前的代码</span></span><br><span class="line"><span class="keyword">const</span> accessToken = <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(payload, &#123;</span><br><span class="line">  <span class="attr">audience</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">  <span class="attr">issuer</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>),</span><br><span class="line">  <span class="attr">expiresIn</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改后的代码</span></span><br><span class="line"><span class="keyword">const</span> accessToken = <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(payload);</span><br><span class="line"><span class="keyword">const</span> refreshToken = <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(</span><br><span class="line">  payload, </span><br><span class="line">  <span class="title function_">getJWTVerifyOptions</span>(<span class="variable language_">this</span>.<span class="property">configService</span>).<span class="property">refreshToken</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在登录响应中添加刷新令牌：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 之前的返回结果</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="attr">access_token</span>: accessToken,</span><br><span class="line">  <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">  <span class="attr">expires_in</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>),</span><br><span class="line">  <span class="attr">user</span>: &#123; ... &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改后的返回结果</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="attr">access_token</span>: accessToken,</span><br><span class="line">  <span class="attr">refresh_token</span>: refreshToken,  <span class="comment">// 新增</span></span><br><span class="line">  <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">  <span class="attr">expires_in</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_ACCESS_TOKEN_TTL&#x27;</span>),</span><br><span class="line">  <span class="attr">user</span>: &#123; ... &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li>
<p>新增令牌刷新功能，用于在访问令牌过期后获取新的访问令牌：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">refresh</span>(<span class="params"><span class="attr">refreshToken</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">debug</span>(<span class="string">`刷新访问令牌`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证刷新令牌</span></span><br><span class="line">  <span class="keyword">const</span> refreshPayload = <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">verify</span>(</span><br><span class="line">    refreshToken, </span><br><span class="line">    <span class="title function_">getJWTVerifyOptions</span>(<span class="variable language_">this</span>.<span class="property">configService</span>).<span class="property">refreshToken</span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 查找用户</span></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">usersService</span>.<span class="title function_">findUser</span>(&#123; <span class="attr">id</span>: refreshPayload.<span class="property">sub</span> &#125;);</span><br><span class="line">  <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">warn</span>(<span class="string">`刷新失败，未找到用户：<span class="subst">$&#123;user.username&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;用户不存在&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成新的访问令牌</span></span><br><span class="line">  <span class="keyword">const</span> newAccessToken = <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">sign</span>(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">sub</span>: user.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">      <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">      <span class="attr">role</span>: user.<span class="property">role</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">getJWTVerifyOptions</span>(<span class="variable language_">this</span>.<span class="property">configService</span>).<span class="property">accessToken</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">`已为用户刷新访问令牌：<span class="subst">$&#123;user.username&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">access_token</span>: newAccessToken,</span><br><span class="line">    <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">    <span class="attr">expires_in</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;JWT_REFRESH_TOKEN_TTL&#x27;</span>)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>添加登出功能，用于清除用户的刷新令牌：</p>
 <figure class="highlight ts"><figcaption><span>auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">logout</span>(<span class="attr">userId</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">usersService</span>.<span class="title function_">update</span>(userId, &#123; <span class="attr">refreshToken</span>: <span class="literal">null</span> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="434-控制器层改造"><a class="markdownIt-Anchor" href="#434-控制器层改造"></a> 4.3.4. 控制器层改造</h4>
<p>在 <code>AuthController</code> 中，我们需要添加新的接口来支持“记住我”功能：</p>
<figure class="highlight ts"><figcaption><span>auth.controller.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(&#123; <span class="attr">summary</span>: <span class="string">&#x27;刷新访问令牌&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">JwtRefreshGuard</span>)</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="title class_">HttpStatus</span>.<span class="property">OK</span>)</span><br><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;refresh&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">refresh</span>(<span class="params"><span class="meta">@Body</span>() <span class="attr">body</span>: &#123; refreshToken: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">refresh</span>(body.<span class="property">refreshToken</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">`刷新 Token 失败：<span class="subst">$&#123;error.message&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;刷新 Token 失败&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时添加获取当前用户信息和登出的接口：</p>
<figure class="highlight ts"><figcaption><span>auth.controller.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(&#123; <span class="attr">summary</span>: <span class="string">&#x27;获取当前用户信息&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="title class_">HttpStatus</span>.<span class="property">OK</span>)</span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;me&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getCurrentUser</span>(<span class="params"><span class="meta">@CurrentUser</span>() <span class="attr">user</span>: <span class="title class_">JWTPayload</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">getCurrentUser</span>(user.<span class="property">sub</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation</span>(&#123; <span class="attr">summary</span>: <span class="string">&#x27;登出用户&#x27;</span> &#125;)</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="title class_">HttpStatus</span>.<span class="property">OK</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">JwtAuthGuard</span>)</span><br><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;logout&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">logout</span>(<span class="params"><span class="meta">@Req</span>() <span class="attr">req</span>: <span class="title class_">Request</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> user = req.<span class="property">user</span> <span class="keyword">as</span> <span class="title class_">JWTPayload</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">logout</span>(user.<span class="property">sub</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">message</span>: <span class="string">&#x27;已登出&#x27;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="435-守卫机制完善"><a class="markdownIt-Anchor" href="#435-守卫机制完善"></a> 4.3.5. 守卫机制完善</h4>
<ol>
<li>
<p>访问令牌守卫</p>
<p>原来的 <code>JwtAuthGuard</code> 实现存在几个问题：</p>
<ul>
<li>没有直接验证 <code>token</code> 的有效性</li>
<li>没有正确处理 <code>audience</code> 和 <code>issuer</code> 的验证</li>
</ul>
<p>看一眼原本的代码：</p>
 <figure class="highlight ts"><figcaption><span>jwt-auth.guard.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtAuthGuard</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AuthGuard</span>(<span class="string">&#x27;jwt&#x27;</span>) &#123;</span><br><span class="line">  <span class="title function_">handleRequest</span>(<span class="params"><span class="attr">error</span>: <span class="built_in">any</span>, <span class="attr">user</span>: <span class="built_in">any</span>, <span class="attr">info</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error || !user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;验证失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，我们重新实现了这个守卫，提供了更严格的验证和更好的错误处理：</p>
 <figure class="highlight ts"><figcaption><span>jwt-auth.guard.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CanActivate</span>, <span class="title class_">ExecutionContext</span>, <span class="title class_">Injectable</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TokenUtils</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/token.utils&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> winstonLogger <span class="keyword">from</span> <span class="string">&#x27;../../loggers/winston.logger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtAuthGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> logger = winstonLogger;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">jwtService</span>: <span class="title class_">JwtService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">configService</span>: <span class="title class_">ConfigService</span></span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">canActivate</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="title class_">TokenUtils</span>.<span class="title function_">extractTokenFromContext</span>(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">warn</span>(<span class="string">`未提供访问令牌：<span class="subst">$&#123;context&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;未提供访问令牌&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> request = context.<span class="title function_">switchToHttp</span>().<span class="title function_">getRequest</span>();</span><br><span class="line">      request.<span class="property">user</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">verifyAsync</span>(token, &#123;</span><br><span class="line">        <span class="attr">audience</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_AUDIENCE&#x27;</span>),</span><br><span class="line">        <span class="attr">issuer</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;JWT_TOKEN_ISSUER&#x27;</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">`验证访问令牌失败：<span class="subst">$&#123;error.message&#125;</span>`</span>, error.<span class="property">stack</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;无效的访问令牌&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>刷新令牌守卫</p>
<p>新增 <code>JwtRefreshGuard</code> 专门用于处理刷新令牌的验证：</p>
 <figure class="highlight ts"><figcaption><span>jwt-refresh.guard.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ExecutionContext</span>, <span class="title class_">Injectable</span>, <span class="title class_">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TokenUtils</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/token.utils&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getJWTVerifyOptions &#125; <span class="keyword">from</span> <span class="string">&#x27;../../config/jwt.config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> winstonLogger <span class="keyword">from</span> <span class="string">&#x27;../../loggers/winston.logger&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">JwtRefreshGuard</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> logger = winstonLogger;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">jwtService</span>: <span class="title class_">JwtService</span>,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">configService</span>: <span class="title class_">ConfigService</span></span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">canActivate</span>(<span class="params"><span class="attr">context</span>: <span class="title class_">ExecutionContext</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="title class_">TokenUtils</span>.<span class="title function_">extractTokenFromContext</span>(context);</span><br><span class="line">    <span class="keyword">const</span> options = <span class="title function_">getJWTVerifyOptions</span>(<span class="variable language_">this</span>.<span class="property">configService</span>).<span class="property">refreshToken</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">verify</span>(token, options);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">`验证刷新令牌失败：<span class="subst">$&#123;error.message&#125;</span>`</span>, error.<span class="property">stack</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&#x27;无效的刷新令牌&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="436-工具类支持"><a class="markdownIt-Anchor" href="#436-工具类支持"></a> 4.3.6. 工具类支持</h4>
<p>在之前的实现中，令牌提取的逻辑分散在各处，容易导致处理不一致。为了统一处理令牌的提取逻辑，新增 <code>TokenUtils</code> 工具类：</p>
<figure class="highlight ts"><figcaption><span>token.utils.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ExecutionContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TokenUtils</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">extractToken</span>(<span class="attr">request</span>: <span class="title class_">Request</span>): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [<span class="keyword">type</span>, token] = request.<span class="property">headers</span>.<span class="property">authorization</span>?.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>) ?? [];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">type</span> === <span class="string">&#x27;Bearer&#x27;</span> ? token : <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">extractTokenFromContext</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.<span class="title function_">switchToHttp</span>().<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">extractToken</span>(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="44-客户端功能实现"><a class="markdownIt-Anchor" href="#44-客户端功能实现"></a> 4.4. 客户端功能实现</h2>
<h4 id="441-api-请求封装"><a class="markdownIt-Anchor" href="#441-api-请求封装"></a> 4.4.1. API 请求封装</h4>
<p>在用户登录后，我们需要确保所有 API 请求都能正确携带身份验证信息。然而，<code>accessToken</code> 可能会过期，如果没有自动刷新机制，用户将频繁被登出，影响体验。我们希望实现一个自动处理令牌的方案，使得：</p>
<ul>
<li>每个请求都自动携带 <code>accessToken</code> 进行身份验证。</li>
<li>当 <code>accessToken</code> 过期时，自动使用 <code>refreshToken</code> 获取新的 <code>accessToken</code>，并重试原请求。</li>
<li>如果 <code>refreshToken</code> 也失效，则清除令牌并让用户重新登录。</li>
</ul>
<p>我们使用 Axios 拦截器 来实现这一机制，主要分为两部分：</p>
<ol>
<li>
<p>请求拦截器：</p>
<ul>
<li>在每个请求发送前，自动读取 <code>accessToken</code>，并将其添加到请求头。</li>
<li>如果 <code>accessToken</code> 不存在，则直接发送请求。</li>
</ul>
</li>
<li>
<p>响应拦截器：</p>
<ul>
<li>监听 API 响应，如果返回 <code>401 Unauthorized</code>，说明 <code>accessToken</code> 可能已过期。</li>
<li>如果 <code>refreshToken</code> 仍然有效，则使用它请求新的 <code>accessToken</code>，然后重试原始请求。</li>
<li>如果 <code>refreshToken</code> 失效，则清除所有令牌，并要求用户重新登录。</li>
</ul>
</li>
</ol>
<p>这是客户端请求与响应拦截逻辑的流程：</p>
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewbox="-7.5 -8 597.109375 278.1171875" style="max-width: 597.109375px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1753546538007"><style>#mermaid-1753546538007{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1753546538007 .error-icon{fill:#552222;}#mermaid-1753546538007 .error-text{fill:#552222;stroke:#552222;}#mermaid-1753546538007 .edge-thickness-normal{stroke-width:2px;}#mermaid-1753546538007 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1753546538007 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1753546538007 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1753546538007 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1753546538007 .marker{fill:#333333;stroke:#333333;}#mermaid-1753546538007 .marker.cross{stroke:#333333;}#mermaid-1753546538007 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1753546538007 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-1753546538007 .cluster-label text{fill:#333;}#mermaid-1753546538007 .cluster-label span,#mermaid-1753546538007 p{color:#333;}#mermaid-1753546538007 .label text,#mermaid-1753546538007 span,#mermaid-1753546538007 p{fill:#333;color:#333;}#mermaid-1753546538007 .node rect,#mermaid-1753546538007 .node circle,#mermaid-1753546538007 .node ellipse,#mermaid-1753546538007 .node polygon,#mermaid-1753546538007 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1753546538007 .flowchart-label text{text-anchor:middle;}#mermaid-1753546538007 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-1753546538007 .node .label{text-align:center;}#mermaid-1753546538007 .node.clickable{cursor:pointer;}#mermaid-1753546538007 .arrowheadPath{fill:#333333;}#mermaid-1753546538007 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1753546538007 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1753546538007 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1753546538007 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1753546538007 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-1753546538007 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1753546538007 .cluster text{fill:#333;}#mermaid-1753546538007 .cluster span,#mermaid-1753546538007 p{color:#333;}#mermaid-1753546538007 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1753546538007 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1753546538007 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="6" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546538007_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="4.5" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546538007_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5" refx="11" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546538007_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5" refx="-1" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546538007_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5.2" refx="12" viewbox="0 0 11 11" class="marker cross flowchart" id="mermaid-1753546538007_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5.2" refx="-1" viewbox="0 0 11 11" class="marker cross flowchart" id="mermaid-1753546538007_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(-7.5, -8)" class="root"><g class="clusters"><g id="请求拦截" class="cluster default flowchart-label"><rect height="262.1171875" width="581.109375" y="8" x="8" ry="0" rx="0" style=""/><g transform="translate(266.5546875, 8)" class="cluster-label"><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">请求拦截</span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid-1753546538007_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-B" id="L-A-B-0" d="M112,139.059L116.167,139.059C120.333,139.059,128.667,139.059,136.2,139.125C143.734,139.191,150.467,139.323,153.834,139.389L157.201,139.455"/><path marker-end="url(#mermaid-1753546538007_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-C" id="L-B-C-0" d="M315.647,116.471L324.912,113.069C334.176,109.667,352.705,102.863,366.586,99.461C380.468,96.059,389.701,96.059,394.318,96.059L398.934,96.059"/><path marker-end="url(#mermaid-1753546538007_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-D" id="L-B-D-0" d="M315.647,162.646L324.912,165.881C334.176,169.117,352.705,175.588,373.326,178.823C393.947,182.059,416.659,182.059,428.016,182.059L439.372,182.059"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g transform="translate(371.234375, 96.05859375)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">是</span></div></foreignObject></g></g><g transform="translate(371.234375, 182.05859375)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">否</span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(250.1171875, 139.05859375)" data-id="B" data-node="true" id="flowchart-B-1" class="node default default flowchart-label"><polygon style="" transform="translate(-88.1171875,88.1171875)" class="label-container" points="88.1171875,0 176.234375,-88.1171875 88.1171875,-176.234375 0,-88.1171875"/><g transform="translate(-62.6171875, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="125.234375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">存在accessToken?</span></div></foreignObject></g></g><g transform="translate(72.5, 139.05859375)" data-id="A" data-node="true" id="flowchart-A-0" class="node default default flowchart-label"><rect height="36" width="79" y="-18" x="-39.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">发起请求</span></div></foreignObject></g></g><g transform="translate(484.171875, 96.05859375)" data-id="C" data-node="true" id="flowchart-C-3" class="node default default flowchart-label"><rect height="36" width="159.875" y="-18" x="-79.9375" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-72.4375, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="144.875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">添加Authorization头</span></div></foreignObject></g></g><g transform="translate(484.171875, 182.05859375)" data-id="D" data-node="true" id="flowchart-D-5" class="node default default flowchart-label"><rect height="36" width="79" y="-18" x="-39.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">直接发送</span></div></foreignObject></g></g></g></g></g></g></g></svg>
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewbox="-7.5 -8 1177 399.54296875" style="max-width: 1177px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1753546539094"><style>#mermaid-1753546539094{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1753546539094 .error-icon{fill:#552222;}#mermaid-1753546539094 .error-text{fill:#552222;stroke:#552222;}#mermaid-1753546539094 .edge-thickness-normal{stroke-width:2px;}#mermaid-1753546539094 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1753546539094 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1753546539094 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1753546539094 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1753546539094 .marker{fill:#333333;stroke:#333333;}#mermaid-1753546539094 .marker.cross{stroke:#333333;}#mermaid-1753546539094 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1753546539094 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-1753546539094 .cluster-label text{fill:#333;}#mermaid-1753546539094 .cluster-label span,#mermaid-1753546539094 p{color:#333;}#mermaid-1753546539094 .label text,#mermaid-1753546539094 span,#mermaid-1753546539094 p{fill:#333;color:#333;}#mermaid-1753546539094 .node rect,#mermaid-1753546539094 .node circle,#mermaid-1753546539094 .node ellipse,#mermaid-1753546539094 .node polygon,#mermaid-1753546539094 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1753546539094 .flowchart-label text{text-anchor:middle;}#mermaid-1753546539094 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-1753546539094 .node .label{text-align:center;}#mermaid-1753546539094 .node.clickable{cursor:pointer;}#mermaid-1753546539094 .arrowheadPath{fill:#333333;}#mermaid-1753546539094 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1753546539094 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1753546539094 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1753546539094 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1753546539094 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-1753546539094 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1753546539094 .cluster text{fill:#333;}#mermaid-1753546539094 .cluster span,#mermaid-1753546539094 p{color:#333;}#mermaid-1753546539094 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1753546539094 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1753546539094 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="6" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546539094_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="4.5" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546539094_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5" refx="11" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546539094_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5" refx="-1" viewbox="0 0 10 10" class="marker flowchart" id="mermaid-1753546539094_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5.2" refx="12" viewbox="0 0 11 11" class="marker cross flowchart" id="mermaid-1753546539094_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerheight="11" markerwidth="11" markerunits="userSpaceOnUse" refy="5.2" refx="-1" viewbox="0 0 11 11" class="marker cross flowchart" id="mermaid-1753546539094_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(-7.5, -8)" class="root"><g class="clusters"><g id="响应拦截" class="cluster default flowchart-label"><rect height="383.54296875" width="1161" y="8" x="8" ry="0" rx="0" style=""/><g transform="translate(556.5, 8)" class="cluster-label"><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">响应拦截</span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-E LE-F" id="L-E-F-0" d="M112,237.602L116.167,237.602C120.333,237.602,128.667,237.602,136.2,237.668C143.734,237.734,150.467,237.866,153.834,237.932L157.201,237.998"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-F LE-G" id="L-F-G-0" d="M271.569,208.733L281.88,200.989C292.192,193.245,312.815,177.757,327.826,170.084C342.838,162.41,352.238,162.55,356.938,162.62L361.638,162.69"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-G LE-H" id="L-G-H-0" d="M508.122,138.626L517.563,134.614C527.003,130.601,545.884,122.576,559.942,118.563C573.999,114.551,583.232,114.551,587.849,114.551L592.466,114.551"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-H LE-I" id="L-H-I-0" d="M708.766,114.551L714.266,114.551C719.766,114.551,730.766,114.551,740.966,114.621C751.166,114.691,760.566,114.831,765.266,114.902L769.966,114.972"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-I LE-J" id="L-I-J-0" d="M884.956,103.866L892.237,102.11C899.517,100.355,914.079,96.843,925.976,95.088C937.874,93.332,947.107,93.332,951.724,93.332L956.341,93.332"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-I LE-K" id="L-I-K-0" d="M869.976,141.215L879.753,148.66C889.531,156.105,909.086,170.994,930.928,183.075C952.771,195.155,976.901,204.428,988.966,209.064L1001.031,213.7"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-G LE-K" id="L-G-K-0" d="M496.877,198.158L508.192,206.607C519.507,215.056,542.136,231.954,568.201,240.403C594.266,248.852,623.766,248.852,653.266,248.852C682.766,248.852,712.266,248.852,742.589,248.852C772.911,248.852,804.057,248.852,835.203,248.852C866.349,248.852,897.495,248.852,924.971,247.39C952.447,245.928,976.253,243.004,988.157,241.543L1000.06,240.081"/><path marker-end="url(#mermaid-1753546539094_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-F LE-L" id="L-F-L-0" d="M271.569,267.47L281.88,275.047C292.192,282.625,312.815,297.779,334.937,305.356C357.059,312.934,380.68,312.934,392.491,312.934L404.302,312.934"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g transform="translate(333.4375, 162.26953125)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">是</span></div></foreignObject></g></g><g transform="translate(564.765625, 114.55078125)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">是</span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g transform="translate(928.640625, 93.33203125)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">是</span></div></foreignObject></g></g><g transform="translate(928.640625, 185.8828125)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">否</span></div></foreignObject></g></g><g transform="translate(741.765625, 248.8515625)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">否</span></div></foreignObject></g></g><g transform="translate(333.4375, 312.93359375)" class="edgeLabel"><g transform="translate(-8, -10.5)" class="label"><foreignObject height="21" width="16"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">否</span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(231.21875, 237.6015625)" data-id="F" data-node="true" id="flowchart-F-1" class="node default default flowchart-label"><polygon style="" transform="translate(-69.21875,69.21875)" class="label-container" points="69.21875,0 138.4375,-69.21875 69.21875,-138.4375 0,-69.21875"/><g transform="translate(-43.71875, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="87.4375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">状态码=401?</span></div></foreignObject></g></g><g transform="translate(72.5, 237.6015625)" data-id="E" data-node="true" id="flowchart-E-0" class="node default default flowchart-label"><rect height="36" width="79" y="-18" x="-39.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">接收响应</span></div></foreignObject></g></g><g transform="translate(449.1015625, 162.26953125)" data-id="G" data-node="true" id="flowchart-G-3" class="node default default flowchart-label"><polygon style="" transform="translate(-82.6640625,82.6640625)" class="label-container" points="82.6640625,0 165.328125,-82.6640625 82.6640625,-165.328125 0,-82.6640625"/><g transform="translate(-57.1640625, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="114.328125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">有refreshToken?</span></div></foreignObject></g></g><g transform="translate(653.265625, 114.55078125)" data-id="H" data-node="true" id="flowchart-H-5" class="node default default flowchart-label"><rect height="36" width="111" y="-18" x="-55.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-48, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="96"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">发起刷新请求</span></div></foreignObject></g></g><g transform="translate(835.203125, 114.55078125)" data-id="I" data-node="true" id="flowchart-I-7" class="node default default flowchart-label"><polygon style="" transform="translate(-60.4375,60.4375)" class="label-container" points="60.4375,0 120.875,-60.4375 60.4375,-120.875 0,-60.4375"/><g transform="translate(-34.9375, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="69.875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">刷新成功?</span></div></foreignObject></g></g><g transform="translate(1052.8203125, 93.33203125)" data-id="J" data-node="true" id="flowchart-J-9" class="node default default flowchart-label"><rect height="36" width="182.359375" y="-18" x="-91.1796875" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-83.6796875, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="167.359375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">更新accessToken并重试</span></div></foreignObject></g></g><g transform="translate(1052.8203125, 233.6015625)" data-id="K" data-node="true" id="flowchart-K-11" class="node default default flowchart-label"><rect height="36" width="95" y="-18" x="-47.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-40, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="80"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">跳转登录页</span></div></foreignObject></g></g><g transform="translate(449.1015625, 312.93359375)" data-id="L" data-node="true" id="flowchart-L-15" class="node default default flowchart-label"><rect height="36" width="79" y="-18" x="-39.5" ry="0" rx="0" style="" class="basic label-container"/><g transform="translate(-32, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">正常处理</span></div></foreignObject></g></g></g></g></g></g></g></svg>
<figure class="highlight ts"><figcaption><span>api.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> api = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">baseURL</span>: process.<span class="property">env</span>.<span class="property">REACT_APP_API_URL</span>,</span><br><span class="line">  <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">10000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求拦截器：添加令牌</span></span><br><span class="line">api.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> token = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;accessToken&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      config.<span class="property">headers</span> = <span class="title class_">AxiosHeaders</span>.<span class="title function_">from</span>(config.<span class="property">headers</span>);</span><br><span class="line">      config.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&#x27;Authorization&#x27;</span>, <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应拦截器：处理令牌刷新</span></span><br><span class="line">api.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">response</span>) =&gt;</span> response,</span><br><span class="line">  <span class="title function_">async</span> (error) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> originalRequest = error.<span class="property">config</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 401 错误和令牌刷新</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">response</span>?.<span class="property">status</span> === <span class="number">401</span> &amp;&amp; !originalRequest.<span class="property">_retry</span>) &#123;</span><br><span class="line">      originalRequest.<span class="property">_retry</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">const</span> refreshToken = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (refreshToken) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> axios.<span class="title function_">post</span>(</span><br><span class="line">            <span class="string">`<span class="subst">$&#123;process.env.REACT_APP_API_URL&#125;</span>/auth/refresh`</span>,</span><br><span class="line">            &#123; refreshToken &#125;</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">const</span> newAccessToken = data.<span class="property">access_token</span>;</span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;accessToken&#x27;</span>, newAccessToken);</span><br><span class="line">          originalRequest.<span class="property">headers</span>.<span class="property">Authorization</span> = <span class="string">`Bearer <span class="subst">$&#123;newAccessToken&#125;</span>`</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">api</span>(originalRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          <span class="comment">// 刷新失败时清除所有令牌</span></span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;accessToken&#x27;</span>);</span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>这个改造实现了对身份验证流程的优化和自动化：</p>
<ol>
<li>能够自动为请求添加访问令牌，确保每次请求都具备正确的身份验证信息。</li>
<li>能够检测令牌是否过期，并在必要时进行处理，防止因过期导致请求失败。</li>
<li>支持自动刷新令牌，并在刷新成功后重新尝试原始请求，从而提高用户体验，减少因身份验证失效带来的干扰。</li>
</ol>
<h4 id="442-状态管理优化"><a class="markdownIt-Anchor" href="#442-状态管理优化"></a> 4.4.2. 状态管理优化</h4>
<p>首先先介绍一下身份验证流程中整个认证状态的流转：</p>
<svg aria-roledescription="stateDiagram" role="graphics-document document" viewbox="0 0 460.1953125 437" style="max-width: 460.1953125px;" class="statediagram" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1753546540337"><style>#mermaid-1753546540337{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1753546540337 .error-icon{fill:#552222;}#mermaid-1753546540337 .error-text{fill:#552222;stroke:#552222;}#mermaid-1753546540337 .edge-thickness-normal{stroke-width:2px;}#mermaid-1753546540337 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1753546540337 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1753546540337 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1753546540337 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1753546540337 .marker{fill:#333333;stroke:#333333;}#mermaid-1753546540337 .marker.cross{stroke:#333333;}#mermaid-1753546540337 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1753546540337 defs #statediagram-barbEnd{fill:#333333;stroke:#333333;}#mermaid-1753546540337 g.stateGroup text{fill:#9370DB;stroke:none;font-size:10px;}#mermaid-1753546540337 g.stateGroup text{fill:#333;stroke:none;font-size:10px;}#mermaid-1753546540337 g.stateGroup .state-title{font-weight:bolder;fill:#131300;}#mermaid-1753546540337 g.stateGroup rect{fill:#ECECFF;stroke:#9370DB;}#mermaid-1753546540337 g.stateGroup line{stroke:#333333;stroke-width:1;}#mermaid-1753546540337 .transition{stroke:#333333;stroke-width:1;fill:none;}#mermaid-1753546540337 .stateGroup .composit{fill:white;border-bottom:1px;}#mermaid-1753546540337 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px;}#mermaid-1753546540337 .state-note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-1753546540337 .state-note text{fill:black;stroke:none;font-size:10px;}#mermaid-1753546540337 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5;}#mermaid-1753546540337 .edgeLabel .label rect{fill:#ECECFF;opacity:0.5;}#mermaid-1753546540337 .edgeLabel .label text{fill:#333;}#mermaid-1753546540337 .label div .edgeLabel{color:#333;}#mermaid-1753546540337 .stateLabel text{fill:#131300;font-size:10px;font-weight:bold;}#mermaid-1753546540337 .node circle.state-start{fill:#333333;stroke:#333333;}#mermaid-1753546540337 .node .fork-join{fill:#333333;stroke:#333333;}#mermaid-1753546540337 .node circle.state-end{fill:#9370DB;stroke:white;stroke-width:1.5;}#mermaid-1753546540337 .end-state-inner{fill:white;stroke-width:1.5;}#mermaid-1753546540337 .node rect{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1753546540337 .node polygon{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1753546540337 #statediagram-barbEnd{fill:#333333;}#mermaid-1753546540337 .statediagram-cluster rect{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1753546540337 .cluster-label,#mermaid-1753546540337 .nodeLabel{color:#131300;}#mermaid-1753546540337 .statediagram-cluster rect.outer{rx:5px;ry:5px;}#mermaid-1753546540337 .statediagram-state .divider{stroke:#9370DB;}#mermaid-1753546540337 .statediagram-state .title-state{rx:5px;ry:5px;}#mermaid-1753546540337 .statediagram-cluster.statediagram-cluster .inner{fill:white;}#mermaid-1753546540337 .statediagram-cluster.statediagram-cluster-alt .inner{fill:#f0f0f0;}#mermaid-1753546540337 .statediagram-cluster .inner{rx:0;ry:0;}#mermaid-1753546540337 .statediagram-state rect.basic{rx:5px;ry:5px;}#mermaid-1753546540337 .statediagram-state rect.divider{stroke-dasharray:10,10;fill:#f0f0f0;}#mermaid-1753546540337 .note-edge{stroke-dasharray:5;}#mermaid-1753546540337 .statediagram-note rect{fill:#fff5ad;stroke:#aaaa33;stroke-width:1px;rx:0;ry:0;}#mermaid-1753546540337 .statediagram-note rect{fill:#fff5ad;stroke:#aaaa33;stroke-width:1px;rx:0;ry:0;}#mermaid-1753546540337 .statediagram-note text{fill:black;}#mermaid-1753546540337 .statediagram-note .nodeLabel{color:black;}#mermaid-1753546540337 .statediagram .edgeLabel{color:red;}#mermaid-1753546540337 #dependencyStart,#mermaid-1753546540337 #dependencyEnd{fill:#333333;stroke:#333333;stroke-width:1;}#mermaid-1753546540337 .statediagramTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1753546540337 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerunits="strokeWidth" markerheight="14" markerwidth="20" refy="7" refx="19" id="mermaid-1753546540337_statediagram-barbEnd"><path d="M 19,7 L9,13 L14,7 L9,1 Z"/></marker></defs><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge0" d="M246.098,22L246.098,26.167C246.098,30.333,246.098,38.667,246.098,47C246.098,55.333,246.098,63.667,246.098,67.833L246.098,72"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge1" d="M235.971,108L232.643,113.917C229.314,119.833,222.657,131.667,222.657,143.5C222.657,155.333,229.314,167.167,232.643,173.083L235.971,179"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge2" d="M246.098,215L246.098,220.917C246.098,226.833,246.098,238.667,246.098,250.5C246.098,262.333,246.098,274.167,246.098,280.083L246.098,286"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge3" d="M276.411,179L286.375,173.083C296.339,167.167,316.267,155.333,316.267,143.5C316.267,131.667,296.339,119.833,286.375,113.917L276.411,108"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge4" d="M214.598,312.865L188.165,320.304C161.732,327.743,108.866,342.622,83.107,355.978C57.349,369.333,58.697,381.167,59.372,387.083L60.046,393"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge5" d="M244.046,322L243.372,327.917C242.697,333.833,241.349,345.667,252.198,357.5C263.046,369.333,286.093,381.167,297.616,387.083L309.139,393"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge6" d="M352.27,393L354.924,387.083C357.578,381.167,362.887,369.333,350.441,356.8C337.996,344.267,307.797,331.035,292.697,324.419L277.598,317.802"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge7" d="M369.765,393L378.17,387.083C386.575,381.167,403.385,369.333,411.79,354.5C420.195,339.667,420.195,321.833,420.195,304C420.195,286.167,420.195,268.333,420.195,250.5C420.195,232.667,420.195,214.833,420.195,197C420.195,179.167,420.195,161.333,396.429,145.113C372.663,128.893,325.13,114.287,301.364,106.983L277.598,99.68"/><path marker-end="url(#mermaid-1753546540337_statediagram-barbEnd)" style="fill:none" class="edge-thickness-normal transition" id="edge8" d="M82.925,393L89.771,387.083C96.616,381.167,110.308,369.333,117.154,354.5C124,339.667,124,321.833,124,304C124,286.167,124,268.333,124,250.5C124,232.667,124,214.833,124,197C124,179.167,124,161.333,139.1,145.8C154.199,130.267,184.398,117.035,199.498,110.419L214.598,103.802"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><rect height="0" width="0" ry="0" rx="0"/><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"/></div></foreignObject></g></g><g transform="translate(216, 143.5)" class="edgeLabel"><g transform="translate(-48, -10.5)" class="label"><rect height="21" width="96" ry="0" rx="0"/><foreignObject height="21" width="96"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">自动登录检查</span></div></foreignObject></g></g><g transform="translate(246.09765625, 250.5)" class="edgeLabel"><g transform="translate(-48, -10.5)" class="label"><rect height="21" width="96" ry="0" rx="0"/><foreignObject height="21" width="96"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">自动登录成功</span></div></foreignObject></g></g><g transform="translate(336.1953125, 143.5)" class="edgeLabel"><g transform="translate(-48, -10.5)" class="label"><rect height="21" width="96" ry="0" rx="0"/><foreignObject height="21" width="96"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">自动登录失败</span></div></foreignObject></g></g><g transform="translate(56, 357.5)" class="edgeLabel"><g transform="translate(-48, -10.5)" class="label"><rect height="21" width="96" ry="0" rx="0"/><foreignObject height="21" width="96"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">用户主动登出</span></div></foreignObject></g></g><g transform="translate(240, 357.5)" class="edgeLabel"><g transform="translate(-60.1953125, -10.5)" class="label"><rect height="21" width="120.390625" ry="0" rx="0"/><foreignObject height="21" width="120.390625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">AccessToken过期</span></div></foreignObject></g></g><g transform="translate(368.1953125, 357.5)" class="edgeLabel"><g transform="translate(-32, -10.5)" class="label"><rect height="21" width="64" ry="0" rx="0"/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">刷新成功</span></div></foreignObject></g></g><g transform="translate(420.1953125, 250.5)" class="edgeLabel"><g transform="translate(-32, -10.5)" class="label"><rect height="21" width="64" ry="0" rx="0"/><foreignObject height="21" width="64"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">刷新失败</span></div></foreignObject></g></g><g transform="translate(124, 250.5)" class="edgeLabel"><g transform="translate(-48, -10.5)" class="label"><rect height="21" width="96" ry="0" rx="0"/><foreignObject height="21" width="96"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">清除本地存储</span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(246.09765625, 15)" data-id="root_start" data-node="true" id="state-root_start-0" class="node default"><circle height="14" width="14" r="7" class="state-start"/></g><g transform="translate(246.09765625, 90)" data-id="未认证" data-node="true" id="state-未认证-8" class="node  statediagram-state undefined"><rect height="36" width="63" y="-18" x="-31.5" style="" class="basic label-container"/><g transform="translate(-24, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="48"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">未认证</span></div></foreignObject></g></g><g transform="translate(246.09765625, 197)" data-id="认证中" data-node="true" id="state-认证中-3" class="node  statediagram-state undefined"><rect height="36" width="63" y="-18" x="-31.5" style="" class="basic label-container"/><g transform="translate(-24, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="48"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">认证中</span></div></foreignObject></g></g><g transform="translate(246.09765625, 304)" data-id="已认证" data-node="true" id="state-已认证-6" class="node  statediagram-state undefined"><rect height="36" width="63" y="-18" x="-31.5" style="" class="basic label-container"/><g transform="translate(-24, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="48"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">已认证</span></div></foreignObject></g></g><g transform="translate(62.09765625, 411)" data-id="已注销" data-node="true" id="state-已注销-8" class="node  statediagram-state undefined"><rect height="36" width="63" y="-18" x="-31.5" style="" class="basic label-container"/><g transform="translate(-24, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="48"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">已注销</span></div></foreignObject></g></g><g transform="translate(344.1953125, 411)" data-id="令牌刷新中" data-node="true" id="state-令牌刷新中-7" class="node  statediagram-state undefined"><rect height="36" width="95" y="-18" x="-47.5" style="" class="basic label-container"/><g transform="translate(-40, -10.5)" style="" class="label"><rect/><foreignObject height="21" width="80"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">令牌刷新中</span></div></foreignObject></g></g></g></g></g></svg>
<ol>
<li>用户在首次访问时可能处于 <strong>未认证</strong> 状态，系统会自动检查用户的登录状态。</li>
<li>认证过程中可能会发生令牌过期的情况，需要进行 <strong>令牌刷新</strong>。</li>
<li>而在用户注销时，系统会清除本地存储数据。</li>
</ol>
<p>为了有效管理用户的认证状态和流程，我们引入了一个状态机，覆盖以下几种主要状态和转变：</p>
<ol>
<li>
<p>未认证</p>
<p>初始状态，表示用户尚未通过认证。系统会自动检查是否有有效的认证信息（如 <code>accessToken</code> 或 <code>refreshToken</code>）。如果没有，用户将无法访问受保护的资源。</p>
</li>
<li>
<p>认证中</p>
<p>系统正在验证用户的认证信息，可能是通过自动登录检查（例如检查本地存储的 <code>accessToken</code> 或 <code>refreshToken</code>）来恢复用户的会话。若检查成功，用户进入 已认证 状态；若失败，进入 <strong>未认证</strong> 状态。</p>
</li>
<li>
<p>已认证</p>
<p>认证成功后，用户的身份验证信息有效，允许访问受保护的资源。如果在该状态下，用户的 <code>accessToken</code> 过期，系统会自动尝试通过刷新令牌（<code>refreshToken</code>）来更新 <code>accessToken</code>，进入 <strong>令牌刷新中</strong> 状态。</p>
</li>
<li>
<p>令牌刷新中</p>
<p>当 <code>accessToken</code> 过期且用户依然处于已认证状态时，系统会通过 <code>refreshToken</code> 尝试获取新的 <code>accessToken</code>。如果刷新成功，系统返回 <strong>已认证</strong> 状态；如果刷新失败，用户会被迫重新认证（进入 <strong>未认证</strong> 状态）。</p>
</li>
<li>
<p>已注销</p>
<p>用户主动退出时，系统会清除本地存储的认证信息，返回到 <strong>未认证</strong> 状态，确保用户的会话被完全销毁。</p>
</li>
<li>
<p>状态转换</p>
<p>通过自动登录检查、令牌刷新等机制，我们确保用户认证状态的持续性和稳定性。系统根据认证状态的变化自动调整访问权限和用户会话管理。</p>
</li>
</ol>
<p>在用户状态管理中，我们先添加了自动登录相关的功能：</p>
<figure class="highlight ts"><figcaption><span>actions.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">createUserSlice</span>: <span class="title class_">StateCreator</span>&lt;<span class="title class_">UserState</span>&gt; = <span class="function">(<span class="params">set, get</span>) =&gt;</span> (&#123;</span><br><span class="line">  <span class="comment">// ... 其他状态</span></span><br><span class="line">  <span class="attr">isAutoLoading</span>: <span class="literal">false</span>,  <span class="comment">// 新增自动登录状态</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除用户信息</span></span><br><span class="line">  <span class="attr">clearUser</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;accessToken&#x27;</span>);</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>);</span><br><span class="line">    <span class="title function_">set</span>(&#123; <span class="attr">user</span>: <span class="literal">null</span>, <span class="attr">isAutoLoading</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自动登录功能</span></span><br><span class="line">  <span class="attr">autoLogin</span>: <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> state = <span class="title function_">get</span>();</span><br><span class="line">    <span class="keyword">if</span> (state.<span class="property">isAutoLoading</span> || state.<span class="property">user</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> accessToken = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;accessToken&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> refreshToken = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!accessToken &amp;&amp; !refreshToken) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">set</span>(&#123; <span class="attr">isAutoLoading</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> token = accessToken;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果没有访问令牌但有刷新令牌，尝试刷新</span></span><br><span class="line">      <span class="keyword">if</span> (!token &amp;&amp; refreshToken) &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">&#x27;/auth/refresh&#x27;</span>, &#123; refreshToken &#125;);</span><br><span class="line">        token = response.<span class="property">data</span>.<span class="property">access_token</span>;</span><br><span class="line">        <span class="keyword">if</span> (token) &#123;</span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;accessToken&#x27;</span>, token);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取用户信息</span></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">get</span>(<span class="string">&#x27;/auth/me&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">headers</span>: &#123; <span class="title class_">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">set</span>(&#123; <span class="attr">user</span>: response.<span class="property">data</span>, <span class="attr">isAutoLoading</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;accessToken&#x27;</span>);</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>);</span><br><span class="line">      <span class="title function_">set</span>(&#123; <span class="attr">user</span>: <span class="literal">null</span>, <span class="attr">isAutoLoading</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 登出功能增强</span></span><br><span class="line">  <span class="attr">logout</span>: <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">&#x27;/auth/logout&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;accessToken&#x27;</span>);</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>);</span><br><span class="line">      <span class="title function_">set</span>(&#123; <span class="attr">user</span>: <span class="literal">null</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="443-状态管理范式转变"><a class="markdownIt-Anchor" href="#443-状态管理范式转变"></a> 4.4.3. 状态管理范式转变</h4>
<p>在登录功能中，我们需要处理用户的身份验证，同时提供“记住我”功能。然而，使用传统的状态管理（也就是我们的 Zustand）来存储 <code>error</code> 和 <code>isLoading</code> 状态可能会带来一些问题：</p>
<ul>
<li>全局状态污染：<code>error</code> 和 <code>isLoading</code> 这些状态只是登录相关，不需要在整个应用范围内存储。</li>
<li>手动管理状态：需要在 <code>try/catch</code> 中手动更新 <code>isLoading</code>，并在发生错误时手动存储 <code>error</code>，代码较为冗长。</li>
<li>状态同步问题：如果多个组件依赖相同的登录逻辑，手动管理状态可能会导致数据不同步。</li>
</ul>
<p>为了解决这些问题，我们决定使用 React Query 提供的 <code>useMutation</code>，将登录请求的状态管理完全交由 React Query 处理。</p>
<p>安装 React Query：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @tanstack/react-query</span><br></pre></td></tr></table></figure>
<p>让我们以注册组件为例，来看看这次改造。</p>
<p>在之前的实现中，我们使用全局状态来管理加载状态和错误信息：</p>
<figure class="highlight tsx"><figcaption><span>Register.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Register</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> register = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">register</span>);</span><br><span class="line">  <span class="keyword">const</span> isLoading = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">isLoading</span>);</span><br><span class="line">  <span class="keyword">const</span> error = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">error</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> formik = <span class="title function_">useFormik</span>(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="attr">onSubmit</span>: <span class="title function_">async</span> (values) =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; username, email, password &#125; = values;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">register</span>(&#123; username, email, password &#125;);</span><br><span class="line">        <span class="title function_">navigate</span>(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">          <span class="attr">state</span>: &#123;</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;注册成功！请登录您的账号。&#x27;</span>,</span><br><span class="line">            <span class="attr">email</span>: values.<span class="property">email</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;注册失败：&#x27;</span>, error);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这种方式存在以下问题：</p>
<ul>
<li>状态管理过于集中，不同组件的加载状态和错误状态混杂在一起</li>
<li>需要手动管理状态的清理和重置</li>
<li>错误处理不够优雅</li>
<li>缺乏对请求生命周期的完整控制</li>
</ul>
<p>在开始实现具体功能之前，我们需要先配置 React Query。首先修改应用的入口文件 <code>index.tsx</code>：</p>
<figure class="highlight tsx"><figcaption><span>index.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">QueryClient</span>, <span class="title class_">QueryClientProvider</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@tanstack/react-query&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queryClient = <span class="keyword">new</span> <span class="title class_">QueryClient</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> root = <span class="title class_">ReactDOM</span>.<span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>) <span class="keyword">as</span> <span class="title class_">HTMLElement</span>);</span><br><span class="line">root.<span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">React.StrictMode</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">QueryClientProvider</span> <span class="attr">client</span>=<span class="string">&#123;queryClient&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">QueryClientProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">React.StrictMode</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>使用 React Query 的 <code>useMutation</code> 后，代码变得更加清晰和强大：</p>
<figure class="highlight tsx"><figcaption><span>Register.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Register</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> setUser = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">setUser</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">mutate</span>: register, isPending, error &#125; = <span class="title function_">useMutation</span>(&#123;</span><br><span class="line">    <span class="attr">mutationFn</span>: <span class="title function_">async</span> (<span class="attr">values</span>: &#123;</span><br><span class="line">      <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">      <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">      <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line">    &#125;) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">&#x27;/users/create&#x27;</span>, values);</span><br><span class="line">      <span class="keyword">return</span> response.<span class="property">data</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onSuccess</span>: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setUser</span>(data.<span class="property">user</span>);</span><br><span class="line">      <span class="title function_">navigate</span>(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">state</span>: &#123;</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&#x27;注册成功！请检查邮箱完成验证&#x27;</span>,</span><br><span class="line">          <span class="attr">email</span>: data.<span class="property">user</span>.<span class="property">email</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">replace</span>: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> formik = <span class="title function_">useFormik</span>(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="attr">onSubmit</span>: <span class="title function_">async</span> (values) =&gt; &#123;</span><br><span class="line">      <span class="title function_">register</span>(&#123;</span><br><span class="line">        <span class="attr">username</span>: values.<span class="property">username</span>,</span><br><span class="line">        <span class="attr">email</span>: values.<span class="property">email</span>,</span><br><span class="line">        <span class="attr">password</span>: values.<span class="property">password</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这种改进带来了多个显著的好处，使得代码更加清晰、组件更加独立，且状态管理更加高效：</p>
<ol>
<li>
<p>实现了状态隔离。每个组件都有自己独立的加载和错误状态，不同的请求不会相互影响，从而避免了状态混乱的问题。同时，当组件卸载时，状态会自动清理，确保资源的合理释放。</p>
</li>
<li>
<p>得益于生命周期钩子的引入，异步操作的管理更加灵活。<code>mutationFn</code> 负责定义实际的异步操作，<code>onSuccess</code> 处理成功场景，而 <code>onError</code> 则用于错误处理。这些钩子让我们能够更精准地控制请求的执行过程。</p>
<p>在错误处理方面，这种改进也带来了增强。错误信息会被自动捕获并保存，同时错误状态与组件绑定，使得错误管理更加直观。此外，还能够提供更详细的错误类型信息，方便开发者调试和优化。</p>
</li>
<li>
<p>大幅简化了使用方式。开发者不需要手动处理 <code>try/catch</code> 逻辑，也不需要手动管理 <code>loading</code> 状态，只需直接调用 <code>mutate</code> 函数，即可完成异步操作，提高了开发效率和代码可读性。</p>
</li>
</ol>
<blockquote>
<p>使用 <code>useMutation</code> 的基本步骤：</p>
<ol>
<li>定义 <code>mutation</code> 函数：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mutationFn</span>: <span class="title function_">async</span> (values) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">&#x27;/users/create&#x27;</span>, values);</span><br><span class="line">  <span class="keyword">return</span> response.<span class="property">data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置生命周期钩子：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">onSuccess</span>: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 处理成功场景</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">onError</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 处理错误场景</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在组件中使用：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; mutate, isPending, error &#125; = <span class="title function_">useMutation</span>(&#123; ... &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发 mutation</span></span><br><span class="line"><span class="title function_">mutate</span>(values);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用状态</span></span><br><span class="line">&#123;isPending &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">LoadingSpinner</span> /&gt;</span></span>&#125;</span><br><span class="line">&#123;error &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">ErrorMessage</span> <span class="attr">error</span>=<span class="string">&#123;error&#125;</span> /&gt;</span></span>&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>同样的，修改 <code>VerifyEmail</code> 组件：</p>
<figure class="highlight tsx"><figcaption><span>VerifyEmail.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;useEffect&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123;useLocation, useNavigate&#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123;useMutation&#125; <span class="keyword">from</span> <span class="string">&#x27;@tanstack/react-query&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> api <span class="keyword">from</span> <span class="string">&#x27;../stores/common/api&#x27;</span>; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> <span class="title function_">VerifyEmail</span> = (<span class="params"></span>) =&gt; &#123; </span><br><span class="line">  <span class="keyword">const</span> location = <span class="title function_">useLocation</span>(); </span><br><span class="line">  <span class="keyword">const</span> navigate = <span class="title function_">useNavigate</span>(); </span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(location.<span class="property">search</span>).<span class="title function_">get</span>(<span class="string">&#x27;token&#x27;</span>); </span><br><span class="line"> </span><br><span class="line">  <span class="keyword">const</span> &#123; </span><br><span class="line">    emailVerified, </span><br><span class="line">    verificationError, </span><br><span class="line">    verificationToken, </span><br><span class="line">    verificationUserId, </span><br><span class="line">    clearVerificationState </span><br><span class="line">  &#125; = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> (&#123; </span><br><span class="line">    <span class="attr">emailVerified</span>: state.<span class="property">emailVerified</span>, </span><br><span class="line">    <span class="attr">verificationError</span>: state.<span class="property">verificationError</span>, </span><br><span class="line">    <span class="attr">verificationToken</span>: state.<span class="property">verificationToken</span>, </span><br><span class="line">    <span class="attr">verificationUserId</span>: state.<span class="property">verificationUserId</span>, </span><br><span class="line">    <span class="attr">clearVerificationState</span>: state.<span class="property">clearVerificationState</span> </span><br><span class="line">  &#125;)); </span><br><span class="line"> </span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">mutate</span>: verifyEmail, isPending &#125; = <span class="title function_">useMutation</span>(&#123; </span><br><span class="line">    <span class="attr">mutationFn</span>: <span class="title function_">async</span> (<span class="attr">token</span>: <span class="built_in">string</span>) =&gt; &#123; </span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">get</span>(<span class="string">`/users/verify-email?token=<span class="subst">$&#123;token&#125;</span>`</span>); </span><br><span class="line">      <span class="keyword">return</span> response.<span class="property">data</span>; </span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">onSuccess</span>: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">if</span> (data.<span class="property">success</span>) &#123; </span><br><span class="line">        useUserStore.<span class="title function_">setState</span>(&#123; </span><br><span class="line">          <span class="attr">emailVerified</span>: <span class="literal">true</span>, </span><br><span class="line">          <span class="attr">verificationUserId</span>: data.<span class="property">userId</span> </span><br><span class="line">        &#125;); </span><br><span class="line">        <span class="title function_">navigate</span>(<span class="string">&#x27;/login&#x27;</span>, &#123; <span class="attr">replace</span>: <span class="literal">true</span> &#125;) </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        useUserStore.<span class="title function_">setState</span>(&#123; </span><br><span class="line">          <span class="attr">verificationError</span>: data.<span class="property">error</span>, </span><br><span class="line">          <span class="attr">verificationUserId</span>: data.<span class="property">userId</span> </span><br><span class="line">        &#125;); </span><br><span class="line">      &#125; </span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">onError</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> &#123; </span><br><span class="line">      useUserStore.<span class="title function_">setState</span>(&#123; <span class="attr">verificationError</span>: error.<span class="property">message</span> || <span class="string">&#x27;验证过程中发生未知错误&#x27;</span> &#125;); </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;); </span><br><span class="line"> </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (token) <span class="title function_">verifyEmail</span>(token); </span><br><span class="line">  &#125;, [token]); </span><br><span class="line"> </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123; </span><br><span class="line">      <span class="title function_">clearVerificationState</span>(); </span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">replaceState</span>(&#123;&#125;, <span class="string">&#x27;&#x27;</span>, <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>); </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;, []); </span><br><span class="line"> </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleResend</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123; </span><br><span class="line">    <span class="keyword">if</span> (verificationUserId) &#123; </span><br><span class="line">      <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">`/users/resend-verification/<span class="subst">$&#123;verificationUserId&#125;</span>`</span>); </span><br><span class="line">        <span class="title function_">navigate</span>(<span class="string">&#x27;/login&#x27;</span>, &#123; </span><br><span class="line">          <span class="attr">state</span>: &#123; <span class="attr">message</span>: <span class="string">&#x27;新的验证邮件已发送，请查收邮箱&#x27;</span> &#125; </span><br><span class="line">        &#125;); </span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123; </span><br><span class="line">        useUserStore.<span class="title function_">setState</span>(&#123; <span class="attr">verificationError</span>: <span class="string">&#x27;重新发送验证邮件失败&#x27;</span> &#125;); </span><br><span class="line">        <span class="keyword">throw</span> error <span class="keyword">instanceof</span> <span class="title class_">Error</span> </span><br><span class="line">          ? error.<span class="property">message</span> </span><br><span class="line">          : <span class="string">&#x27;重新发送验证邮件失败&#x27;</span>; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;min-h-screen flex items-center justify-center bg-base-200&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;card w-96 bg-base-100 shadow-xl&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;card-body items-center text-center&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">&quot;card-title mb-4&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">            验证电子邮件 </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">h2</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">          &#123;isPending &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex flex-col items-center gap-4&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&quot;loading loading-spinner loading-lg&quot;</span> /&gt;</span> </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">p</span>&gt;</span>正在验证您的邮箱...<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          )&#125; </span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">          &#123;emailVerified &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;alert alert-success&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">span</span>&gt;</span>邮箱验证成功！正在跳转至登录页面……<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          )&#125; </span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">          &#123;verificationError &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;alert alert-error flex flex-col gap-3&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;verificationError&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              &#123;verificationUserId &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">className</span>=<span class="string">&quot;btn btn-sm btn-outline&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">onClick</span>=<span class="string">&#123;handleResend&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span> </span></span><br><span class="line"><span class="language-xml">                  重新发送验证邮件 </span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              )&#125; </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          )&#125; </span></span><br><span class="line"><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">          &#123;!isPending &amp;&amp; !emailVerified &amp;&amp; !verificationError &amp;&amp; verificationToken &amp;&amp; ( </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex flex-col gap-3&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">p</span>&gt;</span>验证链接已失效<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">className</span>=<span class="string">&quot;btn btn-outline&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> verifyEmail(verificationToken)&#125; </span></span><br><span class="line"><span class="language-xml">              &gt; </span></span><br><span class="line"><span class="language-xml">                重新尝试验证 </span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">          )&#125; </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">  ); </span><br><span class="line">&#125;; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">VerifyEmail</span>; </span><br></pre></td></tr></table></figure>
<h4 id="444-登录组件改造"><a class="markdownIt-Anchor" href="#444-登录组件改造"></a> 4.4.4. 登录组件改造</h4>
<p>我们需要对登录组件（<code>Login.tsx</code>）进行改造，以支持“记住我”功能。</p>
<ol>
<li>
<p>在表单验证模式中增加“记住我”选项：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validationSchema = <span class="title class_">Yup</span>.<span class="title function_">object</span>().<span class="title function_">shape</span>(&#123; </span><br><span class="line">  <span class="attr">username</span>: <span class="title class_">Yup</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(<span class="string">&#x27;请输入用户名！&#x27;</span>), </span><br><span class="line">  <span class="attr">password</span>: <span class="title class_">Yup</span>.<span class="title function_">string</span>().<span class="title function_">required</span>(<span class="string">&#x27;请输入密码！&#x27;</span>),</span><br><span class="line">  <span class="attr">rememberMe</span>: <span class="title class_">Yup</span>.<span class="title function_">boolean</span>()  <span class="comment">// 新增</span></span><br><span class="line">&#125;); </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> formik = <span class="title function_">useFormik</span>(&#123; </span><br><span class="line">  <span class="attr">initialValues</span>: &#123; </span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">    <span class="attr">rememberMe</span>: <span class="literal">false</span>  <span class="comment">// 新增</span></span><br><span class="line">  &#125;, </span><br><span class="line">  validationSchema,</span><br><span class="line">  <span class="attr">onSubmit</span>: <span class="title function_">async</span> (values) =&gt; &#123;</span><br><span class="line">    <span class="title function_">login</span>(values);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用 <code>useMutation</code> 重构登录逻辑：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="attr">mutate</span>: login, isPending, error &#125; = <span class="title function_">useMutation</span>(&#123; </span><br><span class="line">  <span class="attr">mutationFn</span>: <span class="title function_">async</span> (<span class="attr">credentials</span>: &#123; </span><br><span class="line">    <span class="attr">username</span>: <span class="built_in">string</span>, </span><br><span class="line">    <span class="attr">password</span>: <span class="built_in">string</span>, </span><br><span class="line">    <span class="attr">rememberMe</span>: <span class="built_in">boolean</span>, </span><br><span class="line">  &#125;) =&gt; &#123; </span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">&#x27;/auth/login&#x27;</span>, credentials); </span><br><span class="line">    <span class="keyword">return</span> response.<span class="property">data</span>; </span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">onSuccess</span>: <span class="title function_">async</span> (data) =&gt; &#123; </span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;accessToken&#x27;</span>, data.<span class="property">access_token</span>); </span><br><span class="line">    <span class="comment">// 只有在用户选择“记住我”时才保存刷新令牌</span></span><br><span class="line">    <span class="keyword">if</span> (formik.<span class="property">values</span>.<span class="property">rememberMe</span>) &#123;</span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>, data.<span class="property">refresh_token</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">setUser</span>(data.<span class="property">user</span>); </span><br><span class="line">    <span class="title function_">navigate</span>(<span class="string">&#x27;/&#x27;</span>, &#123; </span><br><span class="line">      <span class="attr">state</span>: &#123; <span class="attr">message</span>: <span class="string">&#x27;登陆成功！&#x27;</span> &#125;, </span><br><span class="line">      <span class="attr">replace</span>: <span class="literal">true</span> </span><br><span class="line">    &#125;) </span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">onError</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> &#123; </span><br><span class="line">    <span class="comment">// 登录失败时清除所有令牌</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;accessToken&#x27;</span>); </span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>); </span><br><span class="line">    <span class="title function_">clearUser</span>(); </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录失败：&#x27;</span>, error); </span><br><span class="line">  &#125; </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>添加自动登录检查逻辑：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123; </span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">checkAutoLogin</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123; </span><br><span class="line">    <span class="keyword">const</span> accessToken = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;accessToken&#x27;</span>); </span><br><span class="line">    <span class="keyword">const</span> refreshToken = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (accessToken || refreshToken) &#123; </span><br><span class="line">      <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">autoLogin</span>(); </span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123; </span><br><span class="line">        <span class="title function_">clearUser</span>(); </span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;accessToken&#x27;</span>); </span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refreshToken&#x27;</span>); </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;检查自动登录失败：&#x27;</span>, error); </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="title function_">checkAutoLogin</span>().<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;检查自动登录成功：&#x27;</span>, r)); </span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>登录后自动跳转：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123; </span><br><span class="line">  <span class="keyword">if</span> (user &amp;&amp; !isAutoLoading) &#123; </span><br><span class="line">    <span class="title function_">navigate</span>(<span class="string">&#x27;/&#x27;</span>, &#123; <span class="attr">replace</span>: <span class="literal">true</span> &#125;); </span><br><span class="line">  &#125; </span><br><span class="line">&#125;, [user, isAutoLoading, navigate]);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>添加“记住我”选项的界面元素：</p>
 <figure class="highlight tsx"><figcaption><span>Login.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;mb-4 flex items-center&quot;</span>&gt; </span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">id</span>=<span class="string">&quot;rememberMe&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">name</span>=<span class="string">&quot;rememberMe&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">className</span>=<span class="string">&quot;w-4 h-4 text-primary bg-base-300 border-neutral-600 rounded&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">checked</span>=<span class="string">&#123;formik.values.rememberMe&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">onChange</span>=<span class="string">&#123;formik.handleChange&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">disabled</span>=<span class="string">&#123;isPending&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  /&gt;</span></span> </span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">label</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">htmlFor</span>=<span class="string">&quot;rememberMe&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">className</span>=<span class="string">&quot;ml-2 text-sm text-neutral-content cursor-pointer&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  &gt;</span> </span></span><br><span class="line"><span class="language-xml">    记住我 </span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span> </span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="45-邮箱验证提示"><a class="markdownIt-Anchor" href="#45-邮箱验证提示"></a> 4.5. 邮箱验证提示</h2>
<p>为了提升用户体验，我们需要在用户未验证邮箱时给出明显的提示。这个功能包含两个部分：提示组件和布局改造。</p>
<p>创建 <code>UnverifiedBanner</code> 组件来显示验证提示：</p>
<figure class="highlight tsx"><figcaption><span>UnverifiedBanner.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useUserStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">UnverifiedBanner</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">user</span>);</span><br><span class="line">  <span class="keyword">if</span> (user &amp;&amp; !user.<span class="property">verified</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;p-4 mb-4 text-sm text-warning-content bg-warning rounded&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        您的邮箱尚未验证，请尽快验证。您可以修改邮箱地址或<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/resend-verification&quot;</span> <span class="attr">className</span>=<span class="string">&quot;underline ml-1&quot;</span>&gt;</span>重新发送验证邮件<span class="tag">&lt;/<span class="name">a</span>&gt;</span>。</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">UnverifiedBanner</span>;</span><br></pre></td></tr></table></figure>
<p>这个组件具有几个重要特点。它通过全局状态获取用户信息，确保始终使用最新的用户数据。同时，它只会在用户尚未完成验证时显示，避免对已验证用户造成干扰。此外，组件还提供了快捷的邮箱验证操作，使用户能够方便地完成身份确认，提高使用体验。</p>
<p>将验证提示集成到 <code>AuthLayout</code> 中：</p>
<figure class="highlight tsx"><figcaption><span>AuthLayout.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>; </span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UnverifiedBanner</span> <span class="keyword">from</span> <span class="string">&#x27;../components/UnverifiedBanner&#x27;</span>; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> <span class="title class_">AuthLayoutProps</span> = &#123; </span><br><span class="line">  <span class="attr">children</span>: <span class="title class_">React</span>.<span class="property">ReactNode</span>; </span><br><span class="line">&#125;; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> <span class="title function_">AuthLayout</span> = (<span class="params">&#123; children &#125;: <span class="title class_">AuthLayoutProps</span></span>) =&gt; &#123; </span><br><span class="line">  <span class="keyword">return</span> ( </span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex flex-col min-h-screen items-center justify-center bg-base-200&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">UnverifiedBanner</span> /&gt;</span> </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;w-full max-w-md bg-base-100 p-8 rounded-lg shadow-xl&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        &#123;children&#125; </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">  ); </span><br><span class="line">&#125;; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">AuthLayout</span>; </span><br></pre></td></tr></table></figure>
<p>这种改进带来了多方面的好处。用户可以及时了解自己的邮箱验证状态，避免因未验证而影响正常使用。同时，组件提供了直接的验证操作入口，使用户能够快速完成身份确认。此外，它保持了统一的视觉风格，与整体界面设计相协调，并且不会影响原有的布局结构，确保页面的整洁与一致性。</p>
<p>为了解决用户可能未收到验证邮件或验证邮件过期的问题，我们需要实现验证邮件重发功能：</p>
<figure class="highlight tsx"><figcaption><span>ResendVerification.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;useCallback, useEffect&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useNavigate &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useMutation&#125; <span class="keyword">from</span> <span class="string">&#x27;@tanstack/react-query&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useUserStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> api <span class="keyword">from</span> <span class="string">&#x27;../stores/common/api&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ResendVerification</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> navigate = <span class="title function_">useNavigate</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    user,</span><br><span class="line">    verificationUserId,</span><br><span class="line">    clearVerificationState</span><br><span class="line">  &#125; = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">user</span>: state.<span class="property">user</span>,</span><br><span class="line">    <span class="attr">verificationUserId</span>: state.<span class="property">verificationUserId</span>,</span><br><span class="line">    <span class="attr">clearVerificationState</span>: state.<span class="property">clearVerificationState</span></span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">mutate</span>: resendEmail, isPending, error &#125; = <span class="title function_">useMutation</span>(&#123;</span><br><span class="line">    <span class="attr">mutationFn</span>: <span class="title function_">async</span> (<span class="attr">userId</span>: <span class="built_in">string</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> api.<span class="title function_">post</span>(<span class="string">`/users/resend-verification/<span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> response.<span class="property">data</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onSuccess</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">navigate</span>(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">state</span>: &#123; <span class="attr">message</span>: <span class="string">&#x27;新的验证邮件已发送至你的注册邮箱&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">replace</span>: <span class="literal">true</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleResend = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!verificationUserId) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;缺少用户 ID&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resendEmail</span>(verificationUserId);</span><br><span class="line">  &#125;, [verificationUserId, resendEmail]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">clearVerificationState</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [clearVerificationState]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;min-h-screen flex items-center justify-center bg-base-200&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;card w-96 bg-base-100 shadow-xl&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;card-body items-center text-center&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">&quot;card-title mb-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            邮箱验证</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex flex-col items-center gap-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;text-sm&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              你的邮箱 <span class="tag">&lt;<span class="name">strong</span> <span class="attr">className</span>=<span class="string">&quot;text-primary&quot;</span>&gt;</span>&#123;user?.email&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> 还未验证</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            &#123;error &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;alert alert-error shadow-lg&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">className</span>=<span class="string">&quot;stroke-current flex-shrink-0 h-6 w-6&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;none&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 24 24&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">path</span> <span class="attr">strokeLinecap</span>=<span class="string">&quot;round&quot;</span> <span class="attr">strokeLinejoin</span>=<span class="string">&quot;round&quot;</span> <span class="attr">strokeWidth</span>=<span class="string">&quot;2&quot;</span> <span class="attr">d</span>=<span class="string">&quot;M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;error.message&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            )&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">onClick</span>=<span class="string">&#123;handleResend&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">disabled</span>=<span class="string">&#123;isPending&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">className</span>=<span class="string">&#123;</span>`<span class="attr">btn</span> <span class="attr">btn-primary</span> <span class="attr">w-full</span> $&#123;<span class="attr">isPending</span> ? &#x27;<span class="attr">loading</span>&#x27; <span class="attr">:</span> &#x27;&#x27;&#125;`&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">              &#123;isPending ? &#x27;发送中...&#x27; : &#x27;重新发送验证邮件&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;text-sm mt-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;text-gray-500&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                没有收到邮件？请检查垃圾邮件文件夹</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;text-gray-500 mt-2&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                需要修改邮箱？前往&#123;&#x27; &#x27;&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">a</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">href</span>=<span class="string">&quot;/settings&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">className</span>=<span class="string">&quot;link link-primary&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                  <span class="attr">onClick</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    e.preventDefault();</span></span><br><span class="line"><span class="language-xml">                    navigate(&#x27;/settings&#x27;);</span></span><br><span class="line"><span class="language-xml">                  &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                &gt;</span></span><br><span class="line"><span class="language-xml">                  账户设置</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ResendVerification</span>;</span><br></pre></td></tr></table></figure>
<p>通过这个功能，我们为用户提供了一个完整的邮箱验证补救方案，帮助他们顺利完成账号验证过程。</p>
<h2 id="46-错误边界处理"><a class="markdownIt-Anchor" href="#46-错误边界处理"></a> 4.6. 错误边界处理</h2>
<p>在复杂的单页应用中，错误处理是一个非常重要的环节。为了防止应用因为某个组件的错误而完全崩溃，我们引入了错误边界（Error Boundary）机制。</p>
<p>安装 <code>react-error-boundary</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-error-boundary</span><br></pre></td></tr></table></figure>
<h4 id="461-应用入口改造"><a class="markdownIt-Anchor" href="#461-应用入口改造"></a> 4.6.1. 应用入口改造</h4>
<p>首先，我们在应用的最顶层添加错误边界保护。修改 <code>App.tsx</code>：</p>
<figure class="highlight tsx"><figcaption><span>App.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterProvider</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ErrorBoundary</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-error-boundary&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ErrorFallback</span> <span class="keyword">from</span> <span class="string">&#x27;./components/ErrorFallback&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">FallbackComponent</span>=<span class="string">&#123;ErrorFallback&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">RouterProvider</span> <span class="attr">router</span>=<span class="string">&#123;</span> <span class="attr">router</span> &#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></table></figure>
<p>这样做可以捕获整个应用中的 React 组件错误，防止应用崩溃。</p>
<h4 id="462-错误回退组件"><a class="markdownIt-Anchor" href="#462-错误回退组件"></a> 4.6.2. 错误回退组件</h4>
<p>我们创建了一个专门的错误回退组件 <code>ErrorFallback.tsx</code>，用于显示错误信息并提供重试功能：</p>
<figure class="highlight tsx"><figcaption><span>ErrorFallback.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FallbackProps</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-error-boundary&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ErrorFallback</span> = (<span class="params">&#123; error, resetErrorBoundary &#125;: <span class="title class_">FallbackProps</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;alert alert-error shadow-lg&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">className</span>=<span class="string">&quot;stroke-current flex-shrink-0 h-6 w-6&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;none&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 24 24&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">path</span> <span class="attr">strokeLinecap</span>=<span class="string">&quot;round&quot;</span> <span class="attr">strokeLinejoin</span>=<span class="string">&quot;round&quot;</span> <span class="attr">strokeWidth</span>=<span class="string">&quot;2&quot;</span> <span class="attr">d</span>=<span class="string">&quot;M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h3</span> <span class="attr">className</span>=<span class="string">&quot;font-bold&quot;</span>&gt;</span>发生错误！<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">pre</span> <span class="attr">className</span>=<span class="string">&quot;whitespace-pre-wrap&quot;</span>&gt;</span>&#123;error.message&#125;<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">className</span>=<span class="string">&quot;btn btn-sm btn-primary&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;resetErrorBoundary&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      &gt;</span></span></span><br><span class="line"><span class="language-xml">        重试</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ErrorFallback</span>;</span><br></pre></td></tr></table></figure>
<p>错误回退组件具备以下核心功能，旨在提升错误处理的可读性和用户体验：</p>
<ol>
<li>提供清晰的错误信息展示。组件能够显示友好的错误提示，同时呈现具体的错误详情，并保持错误信息的格式化显示，以便用户理解问题所在。</li>
<li>支持错误恢复功能。用户可以通过重试按钮尝试重新执行操作，同时，<code>resetErrorBoundary</code> 方法允许重置错误状态，使应用能够正常运行，让用户得以从错误中恢复。</li>
<li>在用户体验方面，组件采用统一的错误提示样式，确保与应用的整体设计风格保持一致。同时，它提供清晰的操作指引，帮助用户快速做出合适的应对操作，从而减少因错误导致的使用困扰。</li>
</ol>
<h2 id="47-路由访问控制"><a class="markdownIt-Anchor" href="#47-路由访问控制"></a> 4.7. 路由访问控制</h2>
<p>为了确保用户只能访问其权限内的页面，我们需要实现路由保护机制。这包括对私有路由的保护和对公共路由的控制。</p>
<h4 id="471-受保护路由组件"><a class="markdownIt-Anchor" href="#471-受保护路由组件"></a> 4.7.1. 受保护路由组件</h4>
<p>创建 <code>ProtectedRoute</code> 组件用于保护需要登录才能访问的页面：</p>
<figure class="highlight tsx"><figcaption><span>ProtectedRoute.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useLocation, <span class="title class_">Navigate</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ProtectedRoute</span> = (<span class="params">&#123; children &#125;: &#123; children: React.ReactNode &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">user</span>);</span><br><span class="line">  <span class="keyword">const</span> isAutoLoading = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">isAutoLoading</span>);</span><br><span class="line">  <span class="keyword">const</span> location = <span class="title function_">useLocation</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 返回一个加载动画</span></span><br><span class="line">  <span class="keyword">if</span> (isAutoLoading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>加载中……<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Navigate</span> <span class="attr">to</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">state</span>=<span class="string">&#123;&#123;from:</span> <span class="attr">location</span>&#125;&#125; <span class="attr">replace</span> /&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;&gt;</span>&#123;children&#125;<span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ProtectedRoute</span>;</span><br></pre></td></tr></table></figure>
<h4 id="472-公共路由组件"><a class="markdownIt-Anchor" href="#472-公共路由组件"></a> 4.7.2. 公共路由组件</h4>
<p>创建 <code>PublicRoute</code> 组件用于处理登录、注册等公共页面：</p>
<figure class="highlight tsx"><figcaption><span>PublicRoute.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Navigate</span>, useLocation&#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">PublicRoute</span> = (<span class="params">&#123;children&#125; : &#123;children: React.ReactNode&#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">user</span>);</span><br><span class="line">  <span class="keyword">const</span> isAutoLoading = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">isAutoLoading</span>);</span><br><span class="line">  <span class="keyword">const</span> location = <span class="title function_">useLocation</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isAutoLoading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>加载中……<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (user) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">from</span> = location.<span class="property">state</span>?.<span class="property">from</span>?.<span class="property">pathname</span> || <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Navigate</span> <span class="attr">to</span>=<span class="string">&#123;from&#125;</span> <span class="attr">replace</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;&gt;</span>&#123;children&#125;<span class="tag">&lt;/&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PublicRoute</span>;</span><br></pre></td></tr></table></figure>
<h4 id="473-路由配置优化"><a class="markdownIt-Anchor" href="#473-路由配置优化"></a> 4.7.3. 路由配置优化</h4>
<p>使用这些保护组件来包装路由：</p>
<figure class="highlight tsx"><figcaption><span>router.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createBrowserRouter</span>([ </span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, </span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">ProtectedRoute</span>&gt;</span><span class="tag">&lt;<span class="name">MainPage</span> /&gt;</span><span class="tag">&lt;/<span class="name">ProtectedRoute</span>&gt;</span></span> </span><br><span class="line">  &#125;, </span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/register&#x27;</span>, </span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">PublicRoute</span>&gt;</span><span class="tag">&lt;<span class="name">Register</span> /&gt;</span><span class="tag">&lt;/<span class="name">PublicRoute</span>&gt;</span></span> </span><br><span class="line">  &#125;, </span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>, </span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">PublicRoute</span>&gt;</span><span class="tag">&lt;<span class="name">Login</span> /&gt;</span><span class="tag">&lt;/<span class="name">PublicRoute</span>&gt;</span></span> </span><br><span class="line">  &#125;, </span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/verify-email&#x27;</span>, </span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">VerifyEmail</span> /&gt;</span></span> </span><br><span class="line">  &#125;, </span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/resend-verification&#x27;</span>, </span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">ResendVerification</span> /&gt;</span></span> </span><br><span class="line">  &#125; </span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以写一个简单的 <code>MainPage</code> 组件来测试登出功能：</p>
<figure class="highlight tsx"><figcaption><span>MainPage.tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useUserStore &#125; <span class="keyword">from</span> <span class="string">&#x27;../stores&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MainLayout</span> <span class="keyword">from</span> <span class="string">&#x27;../layouts/MainLayout&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MainPage</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> logout = <span class="title function_">useUserStore</span>(<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">logout</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">MainLayout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;logout&#125;</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">MainLayout</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MainPage</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="6976.html">上一篇</a><a class="next" href="567.html">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'hallowdem';
var disqus_identifier = 'posts/270a.html';
var disqus_title = 'React + NestJS购物平台练习【5】用户登录功能';
var disqus_url = 'https://cytrogen.icu/posts/270a.html';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2022 - 2025 <a href="https://cytrogen.icu">Cytrogen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/cytrogen/hexo-theme-ares" target="_blank">hexo-theme-ares</a>.</p></div></footer></div><script>document.addEventListener('DOMContentLoaded', function() {
  const codeBlocks = document.querySelectorAll('figure.highlight');
  
  codeBlocks.forEach(block => {
    let caption = block.querySelector('figcaption');
    if (!caption) {
      caption = document.createElement('figcaption');
      block.insertBefore(caption, block.firstChild);
    }

    const info = document.createElement('div');
    info.className = 'info';
    
    const filename = caption.querySelector('span');
    if (filename) {
      filename.className = 'filename';
      info.appendChild(filename);
    }
    
    const lang = block.className.split(' ')[1];
    if (lang) {
      const langSpan = document.createElement('span');
      langSpan.className = 'lang-name';
      langSpan.textContent = lang;
      info.appendChild(langSpan);
    }

    const sourceLink = caption.querySelector('a');
    if (sourceLink) {
      sourceLink.className = 'source-link';
      info.appendChild(sourceLink);
    }

    const actions = document.createElement('div');
    actions.className = 'actions';

    const codeHeight = block.scrollHeight;
    const threshold = 300;

    if (codeHeight > threshold) {
      block.classList.add('folded');
      
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = '展开';
      toggleBtn.addEventListener('click', () => {
        block.classList.toggle('folded');
        toggleBtn.textContent = block.classList.contains('folded') ? '展开' : '折叠';
      });
      actions.appendChild(toggleBtn);
    }

    const copyBtn = document.createElement('button');
    copyBtn.textContent = '复制';
    copyBtn.addEventListener('click', async () => {
      const codeLines = block.querySelectorAll('.code .line');
      const code = Array.from(codeLines)
        .map(line => line.textContent)
        .join('\n')
        .replace(/\n\n/g, '\n');
      
      try {
        await navigator.clipboard.writeText(code);
        copyBtn.textContent = '已复制';
        copyBtn.classList.add('copied');
        
        setTimeout(() => {
          copyBtn.textContent = '复制';
          copyBtn.classList.remove('copied');
        }, 3000);
      } catch (err) {
        console.error('复制失败:', err);
        copyBtn.textContent = '复制失败';
        
        setTimeout(() => {
          copyBtn.textContent = '复制';
        }, 3000);
      }
    });
    actions.appendChild(copyBtn);

    caption.innerHTML = '';
    caption.appendChild(info);
    caption.appendChild(actions);

    const markedLines = block.getAttribute('data-marked-lines');
    if (markedLines) {
      const lines = markedLines.split(',');
      lines.forEach(range => {
        if (range.includes('-')) {
          const [start, end] = range.split('-').map(Number);
          for (let i = start; i <= end; i++) {
            const line = block.querySelector(`.line-${i}`);
            if (line) line.classList.add('marked');
          }
        } else {
          const line = block.querySelector(`.line-${range}`);
          if (line) line.classList.add('marked');
        }
      });
    }
  });
});</script><script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-4PVPZXE0QQ"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4PVPZXE0QQ');</script><script src="../js/search.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('search-btn');
    const searchPopup = document.getElementById('search-popup');
    const searchInput = document.getElementById('local-search-input');
    const searchClose = document.getElementById('search-close');

    if (searchBtn && searchPopup && searchInput) {
        searchBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            searchPopup.classList.remove('hidden');
            searchInput.focus();
        });

        searchPopup.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        if (searchClose) {
            searchClose.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                searchPopup.classList.add('hidden');
            });
        }

        document.addEventListener('click', function() {
            searchPopup.classList.add('hidden');
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchPopup.classList.add('hidden');
            }
        });

        let search_path = "search.xml";
        if (search_path.length === 0) {
            search_path = "search.xml";
        }
        const path = "/" + search_path;
        searchFunc(path, 'local-search-input', 'local-search-result');
    }
});
</script><script>document.addEventListener('DOMContentLoaded', function() {
    const languageToggle = document.querySelector('.language-toggle');
    const languageDropdown = document.querySelector('.language-dropdown');

    if (languageToggle && languageDropdown) {
    languageToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        languageDropdown.classList.toggle('hidden');
    });

    languageDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    document.addEventListener('click', function() {
        languageDropdown.classList.add('hidden');
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
        languageDropdown.classList.add('hidden');
        }
    });
    }
});
</script><script>document.addEventListener('DOMContentLoaded', function() {
    const moreToggle = document.querySelector('.more-toggle');
    const moreDropdown = document.querySelector('.more-dropdown');

    if (moreToggle && moreDropdown) {
        moreToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            moreDropdown.classList.toggle('hidden');
        });

        moreDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        document.addEventListener('click', function() {
            moreDropdown.classList.add('hidden');
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                moreDropdown.classList.add('hidden');
            }
        });
    }
});
</script><script>const hamburger = document.querySelector('.hamburger-menu');
const mobileMenu = document.querySelector('.mobile-menu-container');
const menuClose = document.querySelector('.menu-close');

if (hamburger && mobileMenu) {
    const closeDropdowns = () => {
        const openDropdowns = mobileMenu.querySelectorAll('.dropdown-menu.show');
        const rotatedToggles = mobileMenu.querySelectorAll('.dropdown-toggle.rotated');
        openDropdowns.forEach(dropdown => dropdown.classList.remove('show'));
        rotatedToggles.forEach(toggle => toggle.classList.remove('rotated'));
    };

    const closeMenu = () => {
        mobileMenu.classList.remove('show');
        hamburger.setAttribute('aria-expanded', false);
        closeDropdowns();
    };

    hamburger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        mobileMenu.classList.toggle('show');
        const isExpanded = mobileMenu.classList.contains('show');
        hamburger.setAttribute('aria-expanded', isExpanded);
    });

    if (menuClose) {
        menuClose.addEventListener('click', closeMenu);
    }

    const dropdownItems = mobileMenu.querySelectorAll('.has-dropdown');
    dropdownItems.forEach(item => {
        const link = item.querySelector('.nav-link');
        const dropdownMenu = item.querySelector('.dropdown-menu');
        const dropdownToggle = item.querySelector('.dropdown-toggle');

        if (link && dropdownMenu) {
            link.addEventListener('click', function(e) {
                if (e.target !== link) return;
                e.preventDefault();
                dropdownMenu.classList.toggle('show');
                dropdownToggle?.classList.toggle('rotated');
            });
        }
    });

    mobileMenu.addEventListener('click', e => e.stopPropagation());

    document.addEventListener('click', closeMenu);

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && mobileMenu.classList.contains('show')) {
            closeMenu();
        }
    });
}</script><div class="hidden" id="search-popup"><div id="search-panel"><input type="text" id="local-search-input" placeholder="搜索..."><div id="local-search-result"></div></div></div></body></html>